
{% extends "base.html" %}
{% block content %}

<div class="row g-3 align-items-end mb-3">
  <div class="col-auto">
    <div class="page-title d-flex align-items-center">
      <div class="page-title-icon me-3">
        üìë
      </div>
      <div class="d-flex align-items-baseline flex-wrap">
        <div class="page-title-main me-3">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á (Warehouse)</div>
        <div class="text-muted" style="font-size: 1rem; border-left: 2px solid #ccc; padding-left: 12px;">
          ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
        </div>
      </div>
    </div>
  </div>
</div>
<hr class="mb-4">

<style>
  footer { display: none !important; }
  @media print {
    footer { display: none !important; }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

    /* --- ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå (‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏≤‡∏¢/‡∏ö‡∏≤‡∏á) --- */
    table.table {
      border-collapse: collapse !important;
      width: 100% !important;
    }
    table.table th,
    table.table td {
      border: 1px solid #000 !important;
      padding: 4px !important;
    }
    /* ------------------------------------------------------ */

    .d-print-none { display: none !important; }
    
    /* ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Scan Order ‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå */
    .scan-col, .scan-cell {
      display: table-cell !important;
      width: 80px !important;
      text-align: center;
      vertical-align: middle;
      border: 1px solid #000 !important;
    }
    
    /* ‡∏ã‡πà‡∏≠‡∏ô input ‡πÅ‡∏•‡∏∞ status text ‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå */
    .scan-input, .scan-status {
      display: none !important;
    }
    
    /* ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå - ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≤‡∏ß‡∏ß‡πà‡∏≤‡∏á (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πÅ‡∏Å‡∏ô) */
    .scan-print-symbol {
      display: block !important;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      border: 1px solid #000;
      width: 24px;
      height: 24px;
      line-height: 20px;
      margin: 0 auto;
      background-color: #fff;
      color: #000;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    
    /* ‡∏™‡∏µ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß - ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏î‡∏≥‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å‡∏Ç‡∏≤‡∏ß */
    .scan-print-symbol.scanned-print {
      background-color: #000 !important;
      border-color: #000 !important;
      color: #fff !important;
      font-size: 22px;
      font-weight: bold;
    }
  }
  
  /* Sortable column headers */
  th.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 20px !important;
  }
  th.sortable:hover {
    background-color: #e9ecef;
  }
  th.sortable::after {
    content: '‚áÖ';
    position: absolute;
    right: 5px;
    opacity: 0.3;
  }
  th.sortable.asc::after {
    content: '‚ñ≤';
    opacity: 1;
  }
  th.sortable.desc::after {
    content: '‚ñº';
    opacity: 1;
  }
  
  /* Scan Order input styling */
  .scan-container {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .scan-input {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    text-transform: uppercase;
  }
  .scan-input:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    background-color: #fff8dc;
  }
  .scan-input.is-valid {
    border-color: #28a745 !important;
    background-color: #d4edda !important;
  }
  .scan-input.is-invalid {
    border-color: #dc3545 !important;
    background-color: #f8d7da !important;
  }
  .scan-status {
    font-size: 0.85rem;
    min-height: 20px;
  }
</style>

<div class="container">
  <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ + ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏•‡πá‡∏≠‡∏Å -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">
      {{ report_title or "‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á (Warehouse Job Sheet)" }}
      {% if is_history_view %}<span class="badge bg-info ms-2">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß</span>{% endif %}
    </h3>
    <div class="d-print-none d-flex gap-2">
      {% if not official_print %}
        <button id="printSelectedBtn" class="btn btn-danger" onclick="printSelected()">üîí ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        <button id="printAllBtn" class="btn btn-warning" onclick="printAllOrders()">üîí ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button id="updateDispatchBtn" class="btn btn-primary" onclick="showDispatchModal()">üìù ‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô(‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà)</button>
      {% endif %}
      {% if is_history_view %}
        <a class="btn btn-outline-secondary" href="{{ url_for('warehouse_printed_history', reset='today') }}">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä </a>
      {% else %}
        <a class="btn btn-outline-secondary" href="{{ url_for('print_warehouse', reset='all') }}">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä/Order‡∏Ñ‡πâ‡∏≤‡∏á</a>
      {% endif %}
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏´‡∏°‡∏î -->
  {% if is_history_view %}
    <div class="alert alert-primary d-print-none">
      <strong>üìã ‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß</strong> ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ)
    </div>
  {% elif official_print and printed_meta %}
    <div class="alert alert-success d-print-none">
      <strong>Official print</strong>
      ‚Ä¢ ‡∏ú‡∏π‡πâ‡∏≠‡∏≠‡∏Å: {{ printed_meta.by }}
      ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: {{ printed_meta.at|thai_be }}
      ‚Ä¢ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: {{ printed_meta.orders }}
      {% if printed_meta.override %}<span class="badge text-bg-warning ms-2">Reprint (Admin)</span>{% endif %}
    </div>
  {% else %}
    <div class="alert alert-info d-print-none">
      ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏´‡∏°‡∏î <strong>Preview</strong> ‚Äî ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏î "‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô"
    </div>
  {% endif %}

  <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå (GET) -->
  <form class="row gy-2 gx-2 align-items-end mb-3 d-print-none" method="get" action="{{ url_for('print_warehouse') if not is_history_view else url_for('warehouse_printed_history') }}">
    
    {% if is_history_view %}
    <div class="col-md-3">
      <label class="form-label small fw-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå</label>
      <div class="d-flex gap-1">
        <input type="date" name="print_date_from" class="form-control form-control-sm" value="{{ print_date_from or '' }}" placeholder="‡πÄ‡∏£‡∏¥‡πà‡∏°">
        <input type="date" name="print_date_to" class="form-control form-control-sm" value="{{ print_date_to or '' }}" placeholder="‡∏ñ‡∏∂‡∏á">
      </div>
    </div>
    {% endif %}
    
    <div class="col-md-2">
      <label class="form-label small fw-bold">‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</label>
      <select name="platform" class="form-select form-select-sm">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        {% for p in ["Shopee","TikTok","Lazada","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] %}
          <option value="{{p}}" {% if platform_sel==p %}selected{% endif %}>{{p}}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small fw-bold">‡∏£‡πâ‡∏≤‡∏ô</label>
      <select name="shop_id" class="form-select form-select-sm">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        {% for s in shops %}
          <option value="{{s.id}}" {% if shop_sel and (shop_sel|int==s.id) %}selected{% endif %}>{{ s.platform }} ‚Ä¢ {{ s.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small fw-bold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏ô‡∏™‡πà‡∏á</label>
      <select name="logistic" class="form-select form-select-sm">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        {% for l in logistics %}
          <option value="{{l}}" {% if logistic_sel==l %}selected{% endif %}>{{l}}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-1">
      <label class="form-label small fw-bold">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà</label>
      <input type="number" name="round" class="form-control form-control-sm" value="{{ round_sel or '' }}" placeholder="‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö" min="1">
    </div>
    <div class="col-md-1">
      <label class="form-label small fw-bold">‡∏û‡∏¥‡∏°‡∏û‡πå(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</label>
      <input type="number" name="print_count" class="form-control form-control-sm" value="{{ print_count_sel or '' }}" placeholder="‡∏ó‡∏∏‡∏Å‡∏Ñ‡πà‡∏≤" min="0">
    </div>

    <div class="w-100"></div>

    <div class="col-md-4">
      <label class="form-label small fw-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö</label>
      <div class="d-flex gap-2 align-items-center">
        <input type="date" name="accepted_from" class="form-control form-control-sm" value="{{ accepted_from or '' }}">
        <span class="small">‡∏ñ‡∏∂‡∏á</span>
        <input type="date" name="accepted_to" class="form-control form-control-sm" value="{{ accepted_to or '' }}">
        <button type="button" class="btn btn-outline-secondary btn-sm text-nowrap px-3" onclick="setTodayWarehouse()">üìÖ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
      </div>
    </div>

    <div class="col-md-auto d-flex gap-2">
      <button type="submit" class="btn btn-primary btn-sm fw-bold px-3"><i class="bi bi-search"></i> ‡∏Å‡∏£‡∏≠‡∏á</button>
      
      {% if is_history_view %}
        <a class="btn btn-success btn-sm" href="{{ url_for('export_warehouse_history_excel', **request.args) }}">Export Excel ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
      {% else %}
        <a class="btn btn-success btn-sm" href="{{ url_for('export_warehouse_excel', **request.args) }}">Export Excel ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
      {% endif %}
    </div>
  </form>

  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Global Search) -->
  <div class="d-print-none mb-3">
    <form method="get" action="{{ url_for('warehouse_printed_history') if is_history_view else url_for('print_warehouse') }}" class="d-flex gap-2 align-items-center">
      <div class="input-group" style="max-width: 600px;">
        <span class="input-group-text bg-white"><i class="bi bi-search" style="font-size: 18px;"></i></span>
        <input type="text" name="q" class="form-control" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç Order (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)" value="{{ q or '' }}" style="font-size: 15px;">
        <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      
      {% if q %}
        <a href="{{ url_for('warehouse_printed_history', reset='today') if is_history_view else url_for('print_warehouse', reset='all') }}" class="btn btn-outline-secondary" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
          <i class="bi bi-x-lg"></i> ‡∏•‡πâ‡∏≤‡∏á
        </a>
      {% endif %}
    </form>
    
    {% if q %}
      <div class="alert alert-info mt-2 mb-0">
        <i class="bi bi-info-circle"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: <strong>{{ q }}</strong> {% if is_history_view %}(‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î){% else %}(‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà){% endif %}
      </div>
    {% endif %}
  </div>

  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏•‡∏±‡∏Å (Global Scanner) - Compact Mode -->
  <div class="d-print-none mx-auto mb-3" style="max-width: 500px;">
    
    <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á Input ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î -->
    <div class="input-group shadow-sm mb-2">
      <span class="input-group-text bg-primary text-white border-primary px-3">
        <i class="bi bi-upc-scan" style="font-size: 20px;"></i>
      </span>
      <input type="text" id="globalScanInput" 
             class="form-control fw-bold text-primary" 
             placeholder="‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." 
             autocomplete="off" 
             autofocus
             style="font-size: 18px; height: 45px;">
    </div>

    <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
    <div id="globalScanStatusContainer">
      <div id="globalScanStatus" class="alert alert-secondary text-center shadow-sm py-2" role="alert" 
           style="min-height: 50px; display: flex; align-items: center; justify-content: center;">
        <span class="h6 mb-0 text-muted"><i class="bi bi-circle-fill text-success me-2" style="font-size: 10px;"></i> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
      </div>
    </div>

    <div class="text-center text-muted small mt-1" style="font-size: 0.8rem;">
      <i class="bi bi-info-circle me-1"></i> ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏¢‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
    </div>
  </div>

  <!-- Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î + Filter Controls -->
  <div class="row g-2 mb-3 d-print-none">
    <div class="col-md-6 d-flex gap-3">
      <div class="card shadow-sm border-primary flex-fill">
        <div class="card-body p-2 text-center">
          <small class="text-muted fw-bold">üì¶ Order ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
          <h3 class="fw-bold text-primary mb-0" id="dash-total">{{ count_orders }}</h3>
        </div>
      </div>
      <div class="card shadow-sm border-success flex-fill">
        <div class="card-body p-2 text-center">
          <small class="text-muted fw-bold">‚úÖ Scan ‡πÅ‡∏•‡πâ‡∏ß</small>
          <h3 class="fw-bold text-success mb-0" id="dash-scanned">0</h3>
        </div>
      </div>
      <div class="card shadow-sm border-warning flex-fill">
        <div class="card-body p-2 text-center">
          <small class="text-muted fw-bold">‚è≥ ‡∏£‡∏≠‡∏™‡πÅ‡∏Å‡∏ô</small>
          <h3 class="fw-bold text-warning mb-0" id="dash-pending">0</h3>
        </div>
      </div>
    </div>

    <div class="col-md-6 d-flex flex-column justify-content-end align-items-end gap-2">
       <div><span class="badge text-bg-secondary fs-6" id="selectedCount">Selected: 0</span></div>
    </div>
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• -->
  <div class="table-responsive">
    <table class="table table-bordered table-sm align-middle" id="warehouseTable">
      <thead class="table-light">
        <tr>
          <th class="d-print-none" style="width: 40px;">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
          </th>
          <th class="sortable" data-column="platform">‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</th>
          <th class="sortable" data-column="shop">‡∏£‡πâ‡∏≤‡∏ô</th>
          <th class="sortable" data-column="order_id" style="width: 140px;">‡πÄ‡∏•‡∏Ç Order</th>
          <th class="sortable" data-column="logistic">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏ô‡∏™‡πà‡∏á</th>
          <th class="sortable" data-column="accepted_by">‡∏ú‡∏π‡πâ‡∏Å‡∏î‡∏£‡∏±‡∏ö</th>
          <th class="text-center scan-col" style="width: 180px;">Scan Order</th>
          <th class="sortable text-center" data-column="dispatch_round" style="width: 120px;">‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô(‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà)</th>
          <th class="sortable text-center" data-column="printed_count" style="width: 120px;">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</th>
          <th class="sortable text-center" data-column="printed_at" style="width: 180px;">‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ/‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr data-order-id="{{ r.order_id }}" data-platform="{{ r.platform }}" data-shop="{{ r.shop }}" data-logistic="{{ r.logistic or '-' }}" data-accepted-by="{{ r.accepted_by or '-' }}" data-dispatch-round="{% if r.dispatch_round is not none %}{{ r.dispatch_round }}{% endif %}" data-printed-count="{% if r.printed_warehouse is not none %}{{ r.printed_warehouse }}{% else %}0{% endif %}" data-printed-at="{% if r.printed_warehouse_at %}{{ r.printed_warehouse_at.isoformat() }}{% endif %}">
            
            {# Checkbox #}
            <td class="d-print-none">
              <input type="checkbox" class="order-checkbox" value="{{ r.order_id }}" onchange="updateSelectedCount()">
            </td>
            
            <td>{{ r.platform }}</td>
            <td>{{ r.shop }}</td>
            <td><strong>{{ r.order_id }}</strong></td>
            <td>{{ r.logistic or '-' }}</td>
            <td>{{ r.accepted_by or '-' }}</td>
            <td class="text-center scan-cell">
              <div class="scan-container">
                <input type="text" class="form-control form-control-sm scan-input text-center" 
                       placeholder="" 
                       data-expected="{{ r.order_id }}" 
                       data-scanned="{{ 'true' if r.scanned_at else 'false' }}"
                       readonly 
                       tabindex="-1">
                <span class="scan-status mt-1 d-block"></span>
                <div class="scan-print-symbol d-none">‚¨ú</div>
              </div>
            </td>
            <td class="text-center">
              {% if r.dispatch_round is not none %}
                {{ r.dispatch_round }}
              {% else %}
                -
              {% endif %}
            </td>
            <td class="text-center">
              {% if r.get('printed_warehouse') and r.get('printed_warehouse') > 0 %}
                <span class="badge bg-success">{{ r.get('printed_warehouse') }}</span>
              {% else %}
                <span class="text-muted">0</span>
              {% endif %}
            </td>
            <td class="text-center">
              {% if r.get('printed_warehouse_at') %}
                {{ r.get('printed_warehouse_at')|thai_be }}
                {% if r.get('printed_warehouse_by') %}
                  <br><small class="text-muted">(‡πÇ‡∏î‡∏¢: {{ r.get('printed_warehouse_by') }})</small>
                {% endif %}
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏ã‡πá‡∏ô‡∏£‡∏±‡∏ö -->
  <div class="row mt-4 g-3">
    <div class="col-md-6">
      <div class="border rounded p-3" style="height:160px;">
        <div class="fw-bold mb-5">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</div>
        <div class="text-muted">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• / ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="border rounded p-3" style="height:160px;">
        <div class="fw-bold mb-2">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</div>
        <div class="text-muted">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ç‡∏ô‡∏™‡πà‡∏á / ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á</div>
        {% if request.args.get("logi_phone") %}
          <div class="mt-2">‡πÇ‡∏ó‡∏£: {{ request.args.get("logi_phone") }}</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î Preview) -->
  <div class="mt-3 d-print-none">
    {% if not official_print %}
      <button class="btn btn-outline-secondary" onclick="window.print()">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Preview)</button>
    {% endif %}
  </div>
</div>

{% if official_print %}
<script>
  // ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô Official print
  window.addEventListener('load', function(){ window.print(); });
</script>
{% endif %}

<script>
// ========== Global Shared Variables ==========
let table = null;
let allRows = [];
let sortState = { column: null, direction: 'none' };

// ========== Protection Disable System ==========
let protectionsEnabled = true;
let protectionTimer = null;
const protectionHandlers = {
  clickHandler: null,
  pasteHandler: null,
  dropHandler: null,
  inputHandler: null
};

document.addEventListener('DOMContentLoaded', function() {
  const tbody = document.querySelector('#warehouseTable tbody');
  allRows = Array.from(tbody.querySelectorAll('tr'));
  
  // Initialize DataTables with Pagination
  if ($('#warehouseTable').length) {

    // Clear remembered DataTables state when explicitly asked (e.g. refresh button)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('reset')) {
      localStorage.removeItem('DataTables_warehouseTable_' + window.location.pathname);
    }

    table = $('#warehouseTable').DataTable({
      "stateSave": true,
      "paging": true,
      "pageLength": 100,
      "lengthMenu": [
        [100, 200, 300, 400, 500, -1], 
        [100, 200, 300, 400, 500, "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"]
      ],
      "ordering": false, // ‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ custom sorting
      "info": true,
      "searching": true,
      "dom": "<'row mb-2'<'col-sm-6'l><'col-sm-6 text-end'f>>" +
             "<'row'<'col-sm-12'tr>>" +
             "<'row mt-2'<'col-sm-5'i><'col-sm-7'p>>",
      "language": {
        "lengthMenu": "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏´‡∏ô‡πâ‡∏≤",
        "zeroRecords": "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
        "info": "‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î _TOTAL_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
        "infoEmpty": "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
        "infoFiltered": "(‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î _MAX_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)",
        "search": "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á:",
        "paginate": { 
          "first": "‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å", 
          "last": "‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢", 
          "next": "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ¬ª", 
          "previous": "¬´ ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤" 
        }
      },
      "drawCallback": function(settings) {
        updateScanStats();
        updateSelectedCount();
      }
    });
    
    // Initial update
    updateScanStats();
  }
});

// ========== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î Dashboard ==========
function updateScanStats() {
  if (!table) {
    // Fallback ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ DataTables
    const allInputs = document.querySelectorAll('.scan-input');
    let scanned = 0;
    allInputs.forEach(input => {
      if (input.classList.contains('is-valid') || input.value.includes('‚úì') || input.dataset.scanned === 'true') {
        scanned++;
      }
    });
    document.getElementById('dash-total').textContent = allInputs.length;
    document.getElementById('dash-scanned').textContent = scanned;
    document.getElementById('dash-pending').textContent = allInputs.length - scanned;
    return;
  }

  // ‡πÉ‡∏ä‡πâ DataTables API ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Ñ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
  const allFilteredRows = table.rows({ search: 'applied' }).nodes();
  
  let totalCount = allFilteredRows.length;
  let scannedCount = 0;

  $(allFilteredRows).each(function() {
    const input = $(this).find('input.scan-input');
    if (input.hasClass('is-valid') || input.val().includes('‚úì') || input.data('scanned') === 'true') {
      scannedCount++;
    }
  });

  document.getElementById('dash-total').textContent = totalCount;
  document.getElementById('dash-scanned').textContent = scannedCount;
  document.getElementById('dash-pending').textContent = totalCount - scannedCount;
}

// Toggle select all checkboxes (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á DataTables)
function toggleSelectAll(checkbox) {
  if (!table) return;
  
  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ checkbox ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  const currentPageRows = table.rows({ page: 'current' }).nodes();
  $(currentPageRows).find('.order-checkbox:not(:disabled)').prop('checked', checkbox.checked);
  
  updateSelectedCount();
}

// Update selected count badge
function updateSelectedCount() {
  // ‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤ (‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô filter)
  const checked = document.querySelectorAll('.order-checkbox:checked').length;
  document.getElementById('selectedCount').textContent = `Selected: ${checked}`;
  
  // Update select all checkbox state (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
  const selectAll = document.getElementById('selectAll');
  if (!table || !selectAll) return;
  
  const currentPageRows = table.rows({ page: 'current' }).nodes();
  const visibleCheckboxes = $(currentPageRows).find('.order-checkbox:not(:disabled)');
  const visibleChecked = $(currentPageRows).find('.order-checkbox:checked').length;
  
  if (visibleCheckboxes.length === 0) {
    selectAll.checked = false;
    selectAll.indeterminate = false;
  } else {
    selectAll.checked = visibleChecked === visibleCheckboxes.length;
    selectAll.indeterminate = visibleChecked > 0 && visibleChecked < visibleCheckboxes.length;
  }
}

// Print selected orders
function printSelected() {
  const selected = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
  
  if (selected.length === 0) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    return;
  }
  
  if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô ${selected.length} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
    return;
  }
  
  submitPrintForm(selected);
}

// Print all orders
function printAllOrders() {
  const allOrderIds = Array.from(new Set(
    Array.from(document.querySelectorAll('.order-checkbox')).map(cb => cb.value)
  ));
  
  if (allOrderIds.length === 0) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå');
    return;
  }
  
  if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${allOrderIds.length} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
    return;
  }
  
  submitPrintForm(allOrderIds);
}

// Submit print form
function submitPrintForm(orderIds) {
  const form = document.createElement('form');
  form.method = 'post';
  form.action = '{{ print_action or url_for("print_warehouse_commit") }}';
  
  // Add hidden fields
  const fields = {
    platform: '{{ platform_sel or "" }}',
    shop_id: '{{ shop_sel or "" }}',
    logistic: '{{ logistic_sel or "" }}',
    order_ids: orderIds.join(',')
  };
  
  {% if CURRENT_USER and CURRENT_USER.role == 'admin' %}
  // Check if admin override is needed
  const override = confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)');
  if (override) {
    fields.override = '1';
  }
  {% endif %}
  
  for (const [key, value] of Object.entries(fields)) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = key;
    input.value = value;
    form.appendChild(input);
  }
  
  document.body.appendChild(form);
  form.submit();
}

// Filter by print count (‡πÉ‡∏ä‡πâ DataTables custom filtering)
function filterByPrintCount() {
  const filterValue = document.getElementById('printCountFilter').value;
  
  if (filterValue === '') {
    clearPrintCountFilter();
    return;
  }
  
  const targetCount = parseInt(filterValue);
  
  // ‡πÉ‡∏ä‡πâ DataTables custom filter
  $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
    const row = table.row(dataIndex).node();
    const printedCount = parseInt(row.dataset.printedCount || '0');
    return printedCount === targetCount;
  });
  
  table.draw();
  updateSelectedCount();
}

// Clear print count filter
function clearPrintCountFilter() {
  document.getElementById('printCountFilter').value = '';
  // ‡∏•‡∏ö custom filter ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  $.fn.dataTable.ext.search.pop();
  if (table) table.draw();
  updateSelectedCount();
}

// Filter by dispatch round
function filterByDispatchRound() {
  const filterValue = document.getElementById('dispatchRoundFilter').value;
  
  if (filterValue === '') {
    clearDispatchRoundFilter();
    return;
  }
  
  const targetRound = parseInt(filterValue);
  
  // ‡πÉ‡∏ä‡πâ DataTables custom filter
  $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
    const row = table.row(dataIndex).node();
    const dispatchRound = row.dataset.dispatchRound;
    const roundValue = dispatchRound ? parseInt(dispatchRound) : null;
    return roundValue === targetRound;
  });
  
  table.draw();
  updateSelectedCount();
}

// Clear dispatch round filter
function clearDispatchRoundFilter() {
  document.getElementById('dispatchRoundFilter').value = '';
  // ‡∏•‡∏ö custom filter ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  $.fn.dataTable.ext.search.pop();
  if (table) table.draw();
  updateSelectedCount();
}

// Clear all filters
function clearAllFilters() {
  document.getElementById('printCountFilter').value = '';
  document.getElementById('dispatchRoundFilter').value = '';
  // ‡∏•‡∏ö custom filter ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  $.fn.dataTable.ext.search.length = 0;
  if (table) {
    table.search('').draw();
  }
  updateSelectedCount();
}

// Show dispatch round modal
function showDispatchModal() {
  const selected = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
  
  if (selected.length === 0) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    return;
  }
  
  const round = prompt(`‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà? (${selected.length} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)`);
  
  if (round === null) {
    return; // User cancelled
  }
  
  if (round === '' || isNaN(parseInt(round))) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    return;
  }
  
  // Send update request
  updateDispatchRound(selected, parseInt(round));
}

// Update dispatch round via API
async function updateDispatchRound(orderIds, dispatchRound) {
  try {
    const response = await fetch('{{ url_for("update_dispatch_round") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        order_ids: orderIds,
        dispatch_round: dispatchRound
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert(result.message);
      // Reload page to show updated data
      window.location.reload();
    } else {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error);
    }
  } catch (error) {
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + error.message);
  }
}

// Sort table by column
document.querySelectorAll('th.sortable').forEach(th => {
  th.addEventListener('click', function() {
    const column = this.dataset.column;
    
    // Determine sort direction
    if (sortState.column === column) {
      if (sortState.direction === 'none') {
        sortState.direction = 'asc';
      } else if (sortState.direction === 'asc') {
        sortState.direction = 'desc';
      } else {
        sortState.direction = 'none';
      }
    } else {
      sortState.column = column;
      sortState.direction = 'asc';
    }
    
    // Update UI
    document.querySelectorAll('th.sortable').forEach(h => {
      h.classList.remove('asc', 'desc');
    });
    
    if (sortState.direction !== 'none') {
      this.classList.add(sortState.direction);
    }
    
    // Sort rows
    sortTable(column, sortState.direction);
  });
});

function sortTable(column, direction) {
  const tbody = document.querySelector('#warehouseTable tbody');
  
  if (direction === 'none') {
    // Restore original order
    allRows.forEach(row => tbody.appendChild(row));
    return;
  }
  
  // Since each row is now 1 order, just sort rows directly
  const sortedRows = [...allRows].sort((rowA, rowB) => {
    let valueA = rowA.dataset[column === 'order_id' ? 'orderId' : column] || '';
    let valueB = rowB.dataset[column === 'order_id' ? 'orderId' : column] || '';
    
    // Handle numeric sorting for printed_count and dispatch_round
    if (column === 'printed_count' || column === 'dispatch_round') {
      valueA = parseInt(valueA) || 0;
      valueB = parseInt(valueB) || 0;
      
      if (direction === 'asc') {
        return valueA - valueB;
      } else {
        return valueB - valueA;
      }
    }
    
    // Handle datetime sorting for printed_at
    if (column === 'printed_at') {
      const dateA = valueA ? new Date(valueA).getTime() : 0;
      const dateB = valueB ? new Date(valueB).getTime() : 0;
      
      if (direction === 'asc') {
        return dateA - dateB;
      } else {
        return dateB - dateA;
      }
    }
    
    // String comparison with Thai locale support
    const comparison = valueA.localeCompare(valueB, 'th');
    return direction === 'asc' ? comparison : -comparison;
  });
  
  // Rebuild table with sorted rows
  sortedRows.forEach(row => tbody.appendChild(row));
}

// Initialize
updateSelectedCount();

function setTodayWarehouse() {
  // ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Local Time) ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏ß‡∏•‡∏≤ 00:xx ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤
  const date = new Date();
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const today = `${year}-${month}-${day}`;

  // ‡∏´‡∏≤ form ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
  const form = document.querySelector('form[method="get"]');
  const inputFrom = form.querySelector('input[name="accepted_from"]');
  const inputTo = form.querySelector('input[name="accepted_to"]');
  
  // ‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
  if(inputFrom) inputFrom.value = today;
  if(inputTo) inputTo.value = today;

  // ‡∏™‡∏±‡πà‡∏á Submit Form ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  form.submit();
}

// ========== Barcode Scanning System ==========
// Global Scanner (Main scanning point)

(function() {
  const globalInput = document.getElementById('globalScanInput');
  const globalStatus = document.getElementById('globalScanStatus');
  const scanInputs = document.querySelectorAll('.scan-input');
  let lastKeyTime = 0;
  const SCAN_SPEED_THRESHOLD = 50; // milliseconds between keystrokes (scanners type very fast)
  
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Server (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô Database)
  scanInputs.forEach(input => {
    if (input.dataset.scanned === 'true') {
      markAsScanned(input, false); // false = ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á API ‡∏ã‡πâ‡∏≥
    }
  });
  
  // ========== Global Scanner Setup ==========
  if (globalInput) {
    // ‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡πÄ‡∏™‡∏°‡∏≠
    globalInput.focus();

    // ‡∏õ‡∏¥‡∏î Autocomplete ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Browser ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤
    globalInput.setAttribute('autocomplete', 'off');

    // ========== [SECURITY] ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Copy-Paste ==========
    protectionHandlers.pasteHandler = function(e) {
      if (!protectionsEnabled) return;
      e.preventDefault(); // ‡∏´‡πâ‡∏≤‡∏°‡∏ß‡∏≤‡∏á!
      showGlobalStatus('<span class="h3 fw-bold"><i class="bi bi-shield-fill-exclamation me-2"></i> ‡∏´‡πâ‡∏≤‡∏° Copy ‡∏ß‡∏≤‡∏á! ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>', 'error');
      this.value = "";
      playBeep('error');
    };
    globalInput.addEventListener('paste', protectionHandlers.pasteHandler);

    protectionHandlers.dropHandler = function(e) {
      if (!protectionsEnabled) return;
      e.preventDefault(); // ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏≤‡∏ß‡∏≤‡∏á!
      showGlobalStatus('<span class="h3 fw-bold"><i class="bi bi-shield-fill-exclamation me-2"></i> ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏≤‡∏Å‡∏ß‡∏≤‡∏á! ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>', 'error');
      playBeep('error');
    };
    globalInput.addEventListener('drop', protectionHandlers.dropHandler);

    // ========== [SECURITY] ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏µ‡∏¢‡πå‡∏°‡∏∑‡∏≠ (Speed Check) ==========
    let lastInputTime = 0;
    protectionHandlers.inputHandler = function(e) {
      if (!protectionsEnabled) return;
      const now = new Date().getTime();

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 50ms = ‡∏Ñ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
      if (this.value.length > 1 && (now - lastInputTime) > 50) {
        this.value = ""; // ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ ‡πÑ‡∏°‡πà‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡∏£‡∏≥‡∏Ñ‡∏≤‡∏ç)
      }

      lastInputTime = now;
    };
    globalInput.addEventListener('input', protectionHandlers.inputHandler);

    // ‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô input, button, link)
    protectionHandlers.clickHandler = function(e) {
      if (!protectionsEnabled) return;
      if (!['INPUT', 'BUTTON', 'A', 'SELECT'].includes(e.target.tagName)) {
        globalInput.focus();
      }
    };
    document.addEventListener('click', protectionHandlers.clickHandler);
    
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î Enter ‡∏ó‡∏µ‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å
    globalInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏û‡∏≠‡∏™‡∏°‡∏Ñ‡∏ß‡∏£ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏ú‡∏•‡∏≠‡∏Å‡∏î Enter ‡πÄ‡∏õ‡∏•‡πà‡∏≤) - ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ protection disabled
        const minLength = protectionsEnabled ? 5 : 0;
        if (this.value.length > minLength) {
          handleGlobalScan(this.value);
        }

        this.value = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏¢‡∏¥‡∏á‡∏ï‡πà‡∏≠
      }
    });
  }

  document.addEventListener('keydown', function(e) {
    if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'k') {
      e.preventDefault();
      showProtectionDisableDialog();
    }
  });

  function showProtectionDisableDialog() {
    if (!protectionsEnabled) {
      alert('Protection system is already disabled');
      return;
    }

    const password = prompt('Enter password:');

    if (password !== 'pdev') {
      if (password !== null) {
        alert('Incorrect password');
      }
      return;
    }

    const choice = prompt(
      'Disable Protection Temporarily\n\n' +
      'Select duration:\n' +
      '1 = Disable for 2 minutes\n' +
      '2 = Disable for 5 minutes\n' +
      '3 = Disable for 10 minutes\n\n' +
      'Please enter 1, 2, or 3:'
    );

    const durations = {
      '1': 2,
      '2': 5,
      '3': 10
    };

    if (choice && durations[choice]) {
      disableProtections(durations[choice]);
    } else if (choice !== null) {
      alert('Please select only 1, 2, or 3');
    }
  }

  function disableProtections(minutes) {
    protectionsEnabled = false;

    if (globalInput) {
      globalInput.setAttribute('autocomplete', 'on');
    }

    alert(`Protection disabled for ${minutes} minutes\n\nYou can now:\n- Type manually\n- Copy-Paste\n- Drag & Drop\n- No auto-focus`);

    showGlobalStatus(
      `<span class="h5 fw-bold"><i class="bi bi-unlock-fill me-2"></i> Protection Disabled (${minutes} min)</span>`,
      'warning'
    );

    if (protectionTimer) {
      clearTimeout(protectionTimer);
    }

    protectionTimer = setTimeout(() => {
      enableProtections();
    }, minutes * 60 * 1000);
  }

  function enableProtections() {
    protectionsEnabled = true;

    if (globalInput) {
      globalInput.setAttribute('autocomplete', 'off');
      globalInput.focus();
    }

    alert('Protection re-enabled\n\nAll protection systems are now active');

    showGlobalStatus(
      '<span class="h6 mb-0 text-muted"><i class="bi bi-circle-fill text-success me-2" style="font-size: 10px;"></i> Ready (Protection ON)</span>',
      'normal'
    );

    protectionTimer = null;
  }
  
  // ========== ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Timer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ==========
  let scanStatusTimer = null;

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î Font ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á - Compact Mode)
  function showGlobalStatus(htmlContent, type = 'normal') {
    const statusBox = document.getElementById('globalScanStatus');
    
    // 1. ‡∏•‡πâ‡∏≤‡∏á Timer ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (scanStatusTimer) {
      clearTimeout(scanStatusTimer);
      scanStatusTimer = null;
    }

    // 2. Reset styles - Compact Mode
    statusBox.className = 'alert text-center shadow-sm border py-2';
    statusBox.style.minHeight = '50px';
    statusBox.style.display = 'flex';
    statusBox.style.alignItems = 'center';
    statusBox.style.justifyContent = 'center';
    statusBox.style.transition = 'all 0.3s ease';

    // 3. Set Color
    if (type === 'success') statusBox.classList.add('alert-success');
    else if (type === 'error') statusBox.classList.add('alert-danger');
    else if (type === 'warning') statusBox.classList.add('alert-warning');
    else if (type === 'loading' || type === 'info') statusBox.classList.add('alert-info');
    else if (type === 'dark') statusBox.classList.add('alert-dark');
    else statusBox.classList.add('alert-secondary');

    // 4. ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà class h2, h3 ‡πÉ‡∏ô htmlContent ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô h5, h6 ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    let smallHtml = htmlContent
        .replace(/class="h2/g, 'class="h5')
        .replace(/class="h3/g, 'class="h6')
        .replace(/class="h4/g, 'class="h6')
        .replace(/style="width: 1.5rem; height: 1.5rem;"/g, 'style="width: 1rem; height: 1rem;"');

    statusBox.innerHTML = smallHtml;

    // 5. ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥
    if (type !== 'normal' && type !== 'loading') {
      scanStatusTimer = setTimeout(() => {
        showGlobalStatus('<span class="h6 mb-0 text-muted"><i class="bi bi-circle-fill text-success me-2" style="font-size: 10px;"></i> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>', 'normal');
      }, 10000);
    }
  }

  // ========== Global Scanner Handler ==========
  function handleGlobalScan(rawValue) {
    const trimmedValue = rawValue.trim();

    if (trimmedValue === 'all') {
      scanAllOrders();
      return;
    }

    if (trimmedValue === 'reset') {
      resetAllScans();
      return;
    }

    const cleanValue = extractOrderNumber(rawValue);

    if (!cleanValue) {
      showGlobalStatus('<span class="h3 fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</span>', 'warning');
      playBeep('warning');
      return;
    }

    showGlobalStatus(`<span class="h3 fw-bold"><span class="spinner-border spinner-border-sm me-2" style="width: 1.5rem; height: 1.5rem;"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö... <strong>${cleanValue}</strong></span>`, 'loading');

    const targetInput = document.querySelector(`.scan-input[data-expected="${cleanValue}"]`);

    if (targetInput) {
      if (targetInput.classList.contains('is-valid')) {
        showGlobalStatus(`<span class="h2 fw-bold"><i class="bi bi-exclamation-circle-fill me-2"></i> ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${cleanValue}<br><small>‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</small></span>`, 'warning');
        playBeep('warning');
      } else {
        markAsScanned(targetInput, true);
        showGlobalStatus(`<span class="h2 fw-bold"><i class="bi bi-check-circle-fill me-2"></i> ‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br><small>${cleanValue}</small></span>`, 'success');
        playBeep('success');
        targetInput.closest('tr').scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    } else {
      checkOrderStatusOnServer(cleanValue);
    }
  }

  function scanAllOrders() {
    const allInputs = document.querySelectorAll('.scan-input');
    let scannedCount = 0;

    allInputs.forEach(input => {
      if (!input.classList.contains('is-valid') && input.dataset.expected) {
        markAsScanned(input, true);
        scannedCount++;
      }
    });

    showGlobalStatus(`<span class="h2 fw-bold"><i class="bi bi-check-all me-2"></i> Scan All Completed<br><small>Scanned ${scannedCount} items</small></span>`, 'success');
    playBeep('success');
  }

  function resetAllScans() {
    const allInputs = document.querySelectorAll('.scan-input');
    let resetCount = 0;
    const orderIds = [];

    allInputs.forEach(input => {
      if (input.dataset.expected) {
        orderIds.push(input.dataset.expected);
        input.value = '';
        input.classList.remove('is-valid', 'is-invalid');
        input.style.borderColor = '';
        input.style.backgroundColor = '';
        input.removeAttribute('readonly');
        input.dataset.scanned = 'false';

        const statusSpan = input.nextElementSibling;
        if (statusSpan) {
          statusSpan.innerHTML = '';
        }

        const printSymbol = input.parentElement.querySelector('.scan-print-symbol');
        if (printSymbol) {
          printSymbol.innerHTML = '‚¨ú';
          printSymbol.classList.remove('scanned-print');
        }

        resetCount++;
      }
    });

    if (orderIds.length > 0) {
      fetch('/api/reset_scans', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ order_ids: orderIds })
      }).catch(err => console.error('Reset scans failed:', err));
    }

    updateScanStats();
    showGlobalStatus(`<span class="h2 fw-bold"><i class="bi bi-arrow-counterclockwise me-2"></i> Reset Completed<br><small>Cleared ${resetCount} items</small></span>`, 'info');
    playBeep('success');
  }

  // ================= [ ‡πÄ‡∏ä‡πá‡∏Ñ Server - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Multi-Status ] =================
  function checkOrderStatusOnServer(orderId) {
    fetch('/api/check_order_status', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ order_id: orderId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.found) {
        // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢
        const reportMap = {
          'READY': '‡∏Å‡∏≠‡∏á1_‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á',
          'LOW_STOCK': '‡∏Å‡∏≠‡∏á2_‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢',
          'SHORTAGE': '‡∏Å‡∏≠‡∏á3_‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
          'NOT_ENOUGH': '‡∏Å‡∏≠‡∏á3_‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡πà‡∏á',
          'PACKED': '‡πÅ‡∏û‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß',
          'CANCELLED': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          'ISSUED': '‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
          'NOT_IN_SBS': '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ SBS'
        };

        // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà (statuses) ‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏Å‡πà‡∏≤ (status)
        let statusList = data.statuses || [data.status];
        let thaiNames = statusList.map(s => reportMap[s] || s).join(' / ');

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        let icon = '<i class="bi bi-check-circle-fill me-2"></i>';
        let alertType = 'success';

        if (data.color === 'danger') { 
          icon = '<i class="bi bi-x-circle-fill me-2"></i>'; 
          alertType = 'error'; 
        } else if (data.color === 'warning') { 
          icon = '<i class="bi bi-exclamation-triangle-fill me-2"></i>'; 
          alertType = 'warning'; 
        } else if (data.color === 'info') { 
          icon = '<i class="bi bi-info-circle-fill me-2"></i>'; 
          alertType = 'info'; 
        } else if (data.color === 'dark') { 
          icon = '<i class="bi bi-box-seam-fill me-2"></i>'; 
          alertType = 'dark'; 
        }

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏à‡∏ö‡∏á‡∏≤‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ISSUED "‡πÑ‡∏°‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏à‡∏ö‡∏á‡∏≤‡∏ô" ‡∏ï‡∏≤‡∏° requirement (‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Scan ‡πÑ‡∏î‡πâ)
        let isFinished = statusList.includes('CANCELLED') || statusList.includes('PACKED');

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ) ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡∏•‡∏á DB ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏ã‡πâ‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô + Dashboard ‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        if (!isFinished) {
          fetch('/api/scan_order', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ order_id: orderId })
          })
          .then(r => r.json())
          .then(d => {
            if (!d || d.success !== true) {
              console.error('Auto-save scan failed:', d);
            }
          })
          .catch(err => console.error('Auto-save scan network error:', err));
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ order ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢ q=...)
        let gotoUrl = '';
        let gotoLabel = '';
        if (statusList.includes('SHORTAGE')) {
          gotoUrl = `/report/nostock?q=${encodeURIComponent(orderId)}`;
          gotoLabel = '‡πÑ‡∏õ‡∏Å‡∏≠‡∏á3_‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
        } else if (statusList.includes('NOT_ENOUGH')) {
          gotoUrl = `/report/notenough?q=${encodeURIComponent(orderId)}`;
          gotoLabel = '‡πÑ‡∏õ‡∏Å‡∏≠‡∏á3_‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡πà‡∏á';
        } else if (statusList.includes('LOW_STOCK')) {
          gotoUrl = `/report/lowstock?q=${encodeURIComponent(orderId)}`;
          gotoLabel = '‡πÑ‡∏õ‡∏Å‡∏≠‡∏á2_‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢';
        } else if (statusList.includes('READY')) {
          gotoUrl = `/report/warehouse?q=${encodeURIComponent(orderId)}`;
          gotoLabel = '‡πÑ‡∏õ‡∏Å‡∏≠‡∏á1_‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á';
        }

        const savedBadge = (!isFinished)
          ? "<br><small class='text-white bg-success px-2 rounded mt-1 d-inline-block'>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Scan ‡πÅ‡∏•‡πâ‡∏ß ‚úì</small>"
          : "";
        const gotoLink = (gotoUrl && !isFinished)
          ? `<div class='mt-2'><a class='btn btn-light btn-sm' href='${gotoUrl}'>${gotoLabel}</a></div>`
          : "";

        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        showGlobalStatus(`<span class="h4 fw-bold">${icon} ${thaiNames}${savedBadge}</span>${gotoLink}`, alertType);
        
        if (!isFinished && statusList.includes('READY')) {
          playBeep('warning');
        } else {
          playBeep('error');
        }

      } else {
        // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÄ‡∏•‡∏¢‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÉ‡∏ô Database
        showGlobalStatus(`<span class="h4 fw-bold"><i class="bi bi-x-circle-fill me-2"></i> ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö<br><small>${orderId}</small></span>`, 'error');
        playBeep('error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showGlobalStatus('<span class="h4 fw-bold"><i class="bi bi-wifi-off me-2"></i> ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á</span>', 'error');
      playBeep('error');
    });
  }
  // =======================================================
  
  // ========== Individual Input Scanning (Backup - ‡∏ñ‡πâ‡∏≤‡∏¢‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á) ==========
  scanInputs.forEach(input => {
    let scanBuffer = '';
    let scanTimeout = null;
    
    // Note: Individual inputs are now readonly, but keep this for backup
    // Detect fast typing (barcode scanner behavior)
    input.addEventListener('keydown', function(e) {
      const currentTime = new Date().getTime();
      const timeDiff = currentTime - lastKeyTime;
      lastKeyTime = currentTime;
      
      // If Enter key (scanner sends Enter at the end)
      if (e.key === 'Enter') {
        e.preventDefault();
        validateScan(this);
        scanBuffer = '';
        return;
      }
      
      // Prevent manual typing (slow input)
      if (timeDiff > SCAN_SPEED_THRESHOLD && scanBuffer.length > 0) {
        // This is manual typing, block it
        e.preventDefault();
        this.value = '';
        scanBuffer = '';
        
        // Show warning
        const statusSpan = this.nextElementSibling;
        statusSpan.innerHTML = '<small class="text-warning">‚ö†Ô∏è ‡∏Å‡∏£‡πÅ‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô</small>';
        setTimeout(() => {
          statusSpan.innerHTML = '';
        }, 2000);
        return;
      }
      
      scanBuffer += e.key;
    });
    
    // Alternative: listen to paste event (some scanners use paste)
    input.addEventListener('paste', function(e) {
      e.preventDefault();
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      this.value = pastedText;
      setTimeout(() => validateScan(this), 100);
    });
    
    // Clear buffer after delay
    input.addEventListener('input', function() {
      clearTimeout(scanTimeout);
      scanTimeout = setTimeout(() => {
        scanBuffer = '';
      }, 1000);
    });
  });
})();

// ========== Helper Functions ==========

// Extract order number from barcode (remove prefixes)
function extractOrderNumber(rawValue) {
  let cleanValue = rawValue.trim().toUpperCase();
  
  // Remove common prefixes from shipping labels
  cleanValue = cleanValue.replace(/^(SHOPEE ORDER NO\.?|LAZADA ORDER NUMBER:?|ORDER NO\.?|ORDER:?)\s*/i, '');
  
  // Remove whitespace and special characters that might come from barcode
  cleanValue = cleanValue.replace(/[\s\-_]/g, '');
  
  return cleanValue;
}

// Play beep sound (success, warning, error)
function playBeep(type) {
  // Web Audio API for generating beep sounds
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  // Different frequencies for different types
  const frequencies = {
    'success': 800,  // High tone
    'warning': 600,  // Medium tone
    'error': 300     // Low tone
  };
  
  oscillator.frequency.value = frequencies[type] || 600;
  oscillator.type = 'sine';
  
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.1);
}

function validateScan(input) {
  const scannedValue = input.value.trim();
  
  // Extract order number from barcode
  const cleanValue = extractOrderNumber(scannedValue);
  const expectedValue = extractOrderNumber(input.dataset.expected);
  
  if (cleanValue === expectedValue || scannedValue.toUpperCase().includes(expectedValue)) {
    // ‚úÖ Correct scan - save to database
    markAsScanned(input, true); // true = ‡∏™‡πà‡∏á API ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á DB
    
    // Auto-focus next input
    setTimeout(() => {
      const nextInput = getNextScanInput(input);
      if (nextInput) {
        nextInput.focus();
        nextInput.select();
      }
    }, 300);
    
  } else {
    // ‚ùå Incorrect scan
    const statusSpan = input.nextElementSibling;
    input.classList.remove('is-valid');
    input.classList.add('is-invalid');
    input.style.borderColor = '#dc3545';
    statusSpan.innerHTML = '<small class="text-danger"><strong>‚úó ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!</strong></small>';
    
    // Play error sound
    playBeep('error');
    
    // Clear input for rescan
    setTimeout(() => {
      input.value = '';
      input.focus();
    }, 500);
  }
}

function markAsScanned(input, syncToServer) {
  const statusSpan = input.nextElementSibling;
  const printSymbol = input.parentElement.querySelector('.scan-print-symbol');
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
  input.value = input.dataset.expected;
  input.classList.remove('is-invalid');
  input.classList.add('is-valid');
  input.style.borderColor = '#28a745';
  input.style.backgroundColor = '#d4edda';
  input.setAttribute('readonly', 'readonly');
  
  if (statusSpan) {
    statusSpan.innerHTML = '<small class="text-success"><strong>‚úì ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</strong></small>';
  }
  
  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå (‡πÉ‡∏™‡πà Class ‡πÉ‡∏´‡πâ‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏°)
  if (printSymbol) {
    printSymbol.innerHTML = '‚úì';
    printSymbol.classList.add('scanned-print');
  }
  
  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Server (Database)
  if (syncToServer) {
    fetch('/api/scan_order', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ order_id: input.dataset.expected })
    })
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        // Update data attribute
        input.dataset.scanned = 'true';
        playBeep('success'); // Success sound
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dashboard ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        updateScanStats();
      } else {
        console.error('Save scan failed:', d.error);
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (d.error || 'Unknown error'));
      }
    })
    .catch(err => {
      console.error('Network error:', err);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠');
    });
  } else {
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà sync ‡∏Å‡πá‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dashboard ‡πÄ‡∏•‡∏¢
    updateScanStats();
  }
}

function getNextScanInput(currentInput) {
  const allInputs = Array.from(document.querySelectorAll('.scan-input'));
  const visibleInputs = allInputs.filter(input => {
    const row = input.closest('tr');
    return row && row.style.display !== 'none';
  });
  
  const index = visibleInputs.indexOf(currentInput);
  if (index > -1 && index < visibleInputs.length - 1) {
    return visibleInputs[index + 1];
  }
  return null;
}

// Simple beep sound for feedback
function playBeep(frequency, duration) {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration / 1000);
  } catch (e) {
    // Audio not supported, ignore
  }
}
</script>

{% endblock %}