
{# templates/dashboard.html #}
{% extends "base.html" %}
{% block content %}

<!-- Header + KPI -->
<div class="row g-3 align-items-end mb-2">
  <div class="col-auto">
    <div class="page-title d-flex align-items-center">
      <div class="page-title-icon me-3">
        üìä
      </div>
      <div class="d-flex align-items-baseline flex-wrap">
        <div class="page-title-main me-3">Dashboard</div>
        <div class="text-muted" style="font-size: 1rem; border-left: 2px solid #ccc; padding-left: 12px;">
          {% if all_time %}
            <span class="badge bg-info text-white ms-2">üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Time)</span>
          {% elif use_default_view %}
             <span class="badge bg-primary text-white ms-2">‚ö° ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î + ‡∏á‡∏≤‡∏ô‡∏à‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</span>
          {% else %}
             <span class="badge bg-secondary text-white ms-2">üîç ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á (Filtered)</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-auto d-flex gap-2 flex-wrap">
    <button type="button" class="btn btn-sm btn-success kpi-filter" data-status="READY_ACCEPT">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö: {{ kpis.ready }}</button>
    <button type="button" class="btn btn-sm btn-success kpi-filter" data-status="ACCEPTED">‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß: {{ kpis.accepted }}</button>
    <button type="button" class="btn btn-sm btn-warning kpi-filter" data-status="LOW_STOCK">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢: {{ kpis.low }}</button>
    <button type="button" class="btn btn-sm btn-danger kpi-filter" data-status="SHORTAGE">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: {{ kpis.nostock }}</button>
    <button type="button" class="btn btn-sm btn-outline-danger kpi-filter" data-status="NOT_ENOUGH">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡πà‡∏á: {{ kpis.notenough }}</button>
    <button type="button" class="btn btn-sm btn-dark kpi-filter" data-status="PACKED">‡πÅ‡∏û‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß: {{ kpis.packed }}</button>

    <span class="badge text-bg-light text-dark">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: {{ kpis.total_items }}</span>
    <span class="badge text-bg-light text-dark">‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: {{ kpis.total_qty }}</span>
    
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏• (‡∏ï‡∏≤‡∏°‡∏•‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) -->
    <button type="button" class="btn btn-sm btn-info text-white fw-bold kpi-filter" data-status="TOTAL">
      ‡∏£‡∏ß‡∏° Order: {{ kpis.orders_total or 0 }}
    </button>
    
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö) -->
    <button type="button" class="btn btn-sm btn-hot-pending kpi-filter pulse-active" data-status="">
      üî• ‡∏£‡∏ß‡∏° Order‡∏Ñ‡πâ‡∏≤‡∏á(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏û‡πá‡∏Ñ/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å): <span style="font-size: 1.1em;">{{ kpis.orders_unique }}</span>
    </button>

    <button type="button" class="btn btn-sm btn-success text-white fw-bold kpi-filter kpi-order-ready" data-status="ORDER_READY">
      Order‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö(‡∏Å‡∏≠‡∏á1): {{ kpis.orders_ready }}
    </button>
    <button type="button" class="btn btn-sm btn-warning text-dark fw-bold kpi-filter kpi-order-low" data-status="ORDER_LOW_STOCK">
      Order‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢(‡∏Å‡∏≠‡∏á2): {{ kpis.orders_low }}
    </button>
    <button type="button" class="btn btn-sm btn-danger text-white fw-bold kpi-filter" data-status="ORDER_PROBLEM" style="border: 2px solid #dc3545; box-shadow: 0 2px 4px rgba(220,53,69,0.3);">
      Order‡πÑ‡∏°‡πà‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏û‡∏≠(‡∏Å‡∏≠‡∏á3): {{ kpis.orders_problem or 0 }}
    </button>
    
    <button type="button" class="btn btn-sm btn-outline-secondary text-dark fw-bold kpi-filter kpi-order-nosale" data-status="ORDER_NO_SALES">
      Order‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ö‡∏Ç‡∏≤‡∏¢: {{ kpis.orders_nosales or 0 }}
    </button>
    <button type="button" class="btn btn-sm btn-outline-warning text-dark fw-bold kpi-filter" data-status="ORDER_NOT_IN_SBS" style="border-width:2px;">
      Order‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤SBS: {{ kpis.orders_not_in_sbs or 0 }}
    </button>
    
    <a class="btn btn-sm btn-info text-white fw-bold" href="{{ url_for('dashboard_issued') }}">
      Order‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß: {{ issued_count or 0 }}
    </a>
    <button type="button" class="btn btn-sm btn-secondary text-white fw-bold kpi-filter kpi-order-cancelled" data-status="ORDER_CANCELLED">
      Order‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏û‡πá‡∏Ñ: {{ kpis.orders_cancelled or 0 }}
    </button>
    <button type="button" class="btn btn-sm text-white fw-bold kpi-filter" data-status="ORDER_CANCELLED_PACKED" style="background-color: #6c757d; border: 2px solid #343a40; border-left: 5px solid #dc3545;">
      Order‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏û‡πá‡∏Ñ: {{ kpis.orders_cancelled_packed or 0 }}
    </button>
    <a class="btn btn-sm text-white fw-bold" href="{{ url_for('dashboard_deleted') }}" style="background-color: #5a6268; border: 2px solid #343a40;">
      <i class="bi bi-trash"></i> Order‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö: {{ kpis.orders_deleted or 0 }}
    </a>
  </div>
</div>

<!-- ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å -->
<form class="row gy-2 gx-2 align-items-end mb-2" method="get" id="filterForm">
  {% if all_time %}
  <input type="hidden" name="all_time" value="1">
  {% endif %}
  {% if mode %}
  <input type="hidden" name="mode" value="{{ mode }}">
  {% endif %}

  <div class="col-md-2">
    <label class="form-label">‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</label>
    <select class="form-select" name="platform">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      {% for p in ["Shopee","TikTok","Lazada","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] %}
        <option value="{{p}}" {% if platform_sel==p %}selected{% endif %}>{{p}}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
    <select class="form-select" name="shop_id">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      {% for s in shops %}
        <option value="{{ s.id }}" {% if shop_sel and shop_sel|int==s.id %}selected{% endif %}>
          {{ s.platform }} ‚Ä¢ {{ s.name }}
        </option>
      {% endfor %}
    </select>
  </div>
  
  <div class="col-md-2">
    <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÄ‡∏£‡∏¥‡πà‡∏°)</label>
    <input type="date" class="form-control" name="import_from" value="{{ import_from_sel or '' }}">
  </div>
  <div class="col-md-2">
    <label class="form-label">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
    <input type="date" class="form-control" name="import_to" value="{{ import_to_sel or '' }}">
  </div>

  <div class="col-md-2">
    <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á (‡πÄ‡∏£‡∏¥‡πà‡∏°)</label>
    <input type="date" class="form-control" name="date_from" value="{{ date_from_sel or '' }}">
  </div>
  <div class="col-md-2">
    <label class="form-label">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
    <input type="date" class="form-control" name="date_to" value="{{ date_to_sel or '' }}">
  </div>
  
  <div class="col-md-2">
    <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
    <select class="form-select" name="status">
      <option value="">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏ã‡πà‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡∏à‡∏ö)</option>
      <option value="TOTAL" {% if status_sel=='TOTAL' %}selected{% endif %}>‚≠ê ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏à‡∏ö)</option>
      <option value="READY_ACCEPT" {% if status_sel=='READY_ACCEPT' %}selected{% endif %}>‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö</option>
      <option value="ACCEPTED" {% if status_sel=='ACCEPTED' %}selected{% endif %}>‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option>
      <option value="LOW_STOCK" {% if status_sel=='LOW_STOCK' %}selected{% endif %}>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢</option>
      <option value="SHORTAGE" {% if status_sel=='SHORTAGE' %}selected{% endif %}>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</option>
      <option value="NOT_ENOUGH" {% if status_sel=='NOT_ENOUGH' %}selected{% endif %}>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡πà‡∏á</option>
      <option value="PACKED" {% if status_sel=='PACKED' %}selected{% endif %}>‡πÅ‡∏û‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß</option>
      <option value="ORDER_READY" {% if status_sel=='ORDER_READY' %}selected{% endif %}>Order‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö</option>
      <option value="ORDER_LOW_STOCK" {% if status_sel=='ORDER_LOW_STOCK' %}selected{% endif %}>Order‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢</option>
      <option value="ORDER_NO_SALES" {% if status_sel=='ORDER_NO_SALES' %}selected{% endif %}>Order‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ö‡∏Ç‡∏≤‡∏¢</option>
      <option value="ORDER_CANCELLED" {% if status_sel=='ORDER_CANCELLED' %}selected{% endif %}>Order‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
      <option value="ORDER_CANCELLED_PACKED" {% if status_sel=='ORDER_CANCELLED_PACKED' %}selected{% endif %}>Order‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏û‡πá‡∏Ñ</option>
      <option value="ORDER_NOT_IN_SBS" {% if status_sel=='ORDER_NOT_IN_SBS' %}selected{% endif %}>Order‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤SBS</option>
      <option value="ORDER_PROBLEM" {% if status_sel=='ORDER_PROBLEM' %}selected{% endif %}>Order‡πÑ‡∏°‡πà‡∏°‡∏µ/‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡πà‡∏á</option>
    </select>
  </div>
  <div class="col-md-4">
    <label class="form-label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Global Search)</label>
    <input type="text" class="form-control" name="q" value="{{ q or '' }}" placeholder="‡πÄ‡∏•‡∏Ç Order, SKU, Brand, ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...">
  </div>
  <div class="col-12 d-flex gap-2 flex-wrap mt-2">
    <button id="btn-filter" class="btn btn-primary" type="submit">‡∏Å‡∏£‡∏≠‡∏á</button>
    
    <a id="btn-reset" class="btn btn-outline-secondary" href="{{ url_for('dashboard') }}">
      <i class="bi bi-arrow-counterclockwise"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    </a>
    
    {% if mode == 'today' %}
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary text-white fw-bold shadow-sm" style="border: 2px solid #6c757d;">
            <i class="bi bi-arrow-left-circle-fill"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡∏π Order ‡∏Ñ‡πâ‡∏≤‡∏á
        </a>
        <span class="badge bg-success align-self-center p-2 fs-6 shadow-sm">
            <i class="bi bi-check-circle-fill me-1"></i> ‡πÇ‡∏´‡∏°‡∏î: Order ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
        </span>
    {% else %}
        <a href="{{ url_for('dashboard', mode='today') }}" class="btn fw-bold shadow-sm text-white" 
           style="background-color: #6610f2; border: 2px solid #520dc2;">
           <i class="bi bi-robot me-1" style="font-size: 1.1em;"></i> ‡∏î‡∏π Order ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        </a>
    {% endif %}

    {% if not all_time %}
    <a id="btn-all-time" class="btn btn-outline-info" href="{{ url_for('dashboard', all_time='1') }}">
      üìÖ ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ó‡∏∏‡∏ÅOrder‡∏≠‡∏î‡∏µ‡∏ï+‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô/Order‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/Order‡∏Ñ‡πâ‡∏≤‡∏á)
    </a>
    {% else %}
    <a id="btn-all-time-active" class="btn btn-info text-white" href="{{ url_for('dashboard') }}">
      ‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π All Time (‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å)
    </a>
    {% endif %}
    
    <a id="btn-export" class="btn btn-success ms-auto"
       href="{{ url_for('export_excel',
                        platform=platform_sel,
                        shop_id=shop_sel,
                        import_from=import_from_sel,
                        import_to=import_to_sel,
                        date_from=date_from_sel,
                        date_to=date_to_sel,
                        status=status_sel,
                        all_time=all_time,
                        mode=mode,
                        q=q) }}">
      Export Excel
    </a>
  </div>
</form>

<!-- ‡πÅ‡∏ñ‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô -->
<div class="d-flex flex-wrap gap-2 mb-3">
  <!-- Warehouse with dropdown -->
  <div class="btn-group">
    <a class="btn btn-outline-primary" href="{{ url_for('print_warehouse', platform=platform_sel, shop_id=shop_sel) }}">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á(‡∏Å‡∏≠‡∏á1)/‡∏¢‡∏¥‡∏áBarcode‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß Scan ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Å‡∏≠‡∏á</a>
    <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
      <span class="visually-hidden">Toggle Dropdown</span>
    </button>
    <ul class="dropdown-menu">
      <li><a class="dropdown-item" href="{{ url_for('print_warehouse', platform=platform_sel, shop_id=shop_sel) }}">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item" href="{{ url_for('warehouse_printed_history', platform=platform_sel, shop_id=shop_sel) }}">‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß</a></li>
    </ul>
  </div>
  
  <!-- Picking List with dropdown -->
  <div class="btn-group">
    <a class="btn btn-outline-success" href="{{ url_for('picking_list', platform=platform_sel, shop_id=shop_sel) }}">‡∏û‡∏¥‡∏°‡∏û‡πå Picking List (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á/‡∏Å‡∏≠‡∏á1)</a>
    <button type="button" class="btn btn-outline-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
      <span class="visually-hidden">Toggle Dropdown</span>
    </button>
    <ul class="dropdown-menu">
      <li><a class="dropdown-item" href="{{ url_for('picking_list', platform=platform_sel, shop_id=shop_sel) }}">‡∏û‡∏¥‡∏°‡∏û‡πåPicking List</a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item" href="{{ url_for('picking_printed_history', platform=platform_sel, shop_id=shop_sel) }}">‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß</a></li>
    </ul>
  </div>
  
  <a class="btn btn-outline-warning" style="color: #d39e00; border-color: #d39e00; font-weight: bold; border-width: 2px;" href="{{ url_for('report_lowstock', platform=platform_sel, shop_id=shop_sel) }}">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢(‡∏Å‡∏≠‡∏á2)</a>
  <a class="btn btn-outline-danger" href="{{ url_for('report_nostock', platform=platform_sel, shop_id=shop_sel) }}">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤(‡∏Å‡∏≠‡∏á3)</a>
  <a class="btn btn-outline-danger" href="{{ url_for('report_notenough', platform=platform_sel, shop_id=shop_sel) }}" style="border-width: 2px;">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡πà‡∏á(‡∏Å‡∏≠‡∏á3)</a>
</div>

<!-- ‡πÅ‡∏ñ‡∏ö Bulk -->
<div id="bulk-bar" class="alert alert-info d-print-none d-flex justify-content-between align-items-center d-none">
  <div>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b id="selected-count">0</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
  <div class="btn-group">
    <a href="#" class="btn btn-success" id="btn-bulk-accept-confirm">‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</a>
    <a href="#" class="btn btn-warning" id="btn-bulk-cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</a>
    <button type="button" class="btn btn-outline-danger" onclick="confirmBulkDeleteOrders()">‡∏•‡∏ö Order</button>
    <a href="#" class="btn btn-outline-secondary" id="btn-bulk-clear">‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</a>
  </div>
</div>

<!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö bulk delete -->
<form id="bulk-delete-form" method="post" action="{{ url_for('bulk_delete_orders') }}"></form>

<!-- CSS ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î + ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç Order -->
<style>
  {% if mode == 'today' %}
  /* ===== ‡πÇ‡∏´‡∏°‡∏î Order ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ) - ‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏¥‡πâ‡∏ô‡∏ï‡πå ===== */
  
  /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ö‡∏™‡∏µ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö */
  body::before {
    content: "";
    display: block;
    height: 5px;
    width: 100%;
    background: linear-gradient(to right, #198754, #20c997);
    position: fixed;
    top: 0;
    left: 0;
    z-index: 9999;
  }
  
  /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î "‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" */
  .page-title-icon {
    background: linear-gradient(135deg, #198754, #20c997) !important;
    box-shadow: 0 .25rem .5rem rgba(25, 135, 84, .35) !important;
  }
  
  /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ Badge ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á */
  .page-title .badge.bg-primary,
  .page-title .badge.bg-secondary {
    background-color: #198754 !important;
  }
  
  /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ navbar ‡∏´‡∏•‡∏±‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) */
  .navbar-brand, .page-title-main {
    color: #198754 !important;
  }
  
  /* ‡∏Ç‡∏≠‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
  #ordersTable {
    border-color: #198754 !important;
  }
  #ordersTable thead {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9) !important;
  }
  #ordersTable thead th {
    border-color: #a5d6a7 !important;
    color: #1b5e20 !important;
  }
  
  /* ‡∏Å‡∏£‡∏≠‡∏ö Order Cell ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
  #ordersTable td.order-cell {
    border-left: 2px solid #198754 !important;
    border-right: 2px solid #198754 !important;
    color: #1b5e20;
  }
  tr.order-group-start td.order-cell {
    border-top: 2px solid #198754 !important;
    box-shadow: inset 0 2px 0 0 rgba(25, 135, 84, 0.1);
  }
  tr.order-group-end td.order-cell {
    border-bottom: 2px solid #198754 !important;
    box-shadow: inset 0 -2px 0 0 rgba(25, 135, 84, 0.1);
  }
  {% endif %}

  /* ===== ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÅ‡∏ñ‡∏ß Order ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ===== */
  tr.cancelled-row {
    background-color: #f8d7da !important;
    opacity: 0.7;
  }
  tr.cancelled-row td {
    color: #721c24 !important;
    text-decoration: line-through;
    text-decoration-color: rgba(114, 28, 36, 0.4);
  }
  tr.cancelled-row td.order-cell,
  tr.cancelled-row td:last-child,
  tr.cancelled-row td:nth-last-child(2) {
    text-decoration: none !important; /* ‡πÑ‡∏°‡πà‡∏Ç‡∏µ‡∏î‡∏Ü‡πà‡∏≤‡πÄ‡∏•‡∏Ç Order ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ */
  }
  tr.cancelled-row:hover {
    opacity: 1;
    background-color: #f5c6cb !important;
  }

  /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏õ‡∏∏‡πà‡∏° Hot Pending (‡∏£‡∏ß‡∏° Order ‡∏Ñ‡πâ‡∏≤‡∏á) */
  .btn-hot-pending {
    /* ‡πÑ‡∏•‡πà‡∏™‡∏µ‡∏à‡∏≤‡∏Å‡∏™‡πâ‡∏°‡πÑ‡∏õ‡πÅ‡∏î‡∏á ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏£‡πâ‡∏≠‡∏ô‡πÅ‡∏£‡∏á */
    background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%) !important;
    color: #fff !important;
    border: none !important;
    font-weight: 800 !important; /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤‡∏û‡∏¥‡πÄ‡∏®‡∏© */
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(255, 94, 98, 0.4); /* ‡πÄ‡∏á‡∏≤‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏à‡∏≤‡∏á‡πÜ */
    transition: all 0.3s ease;
  }

  /* ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ï‡∏≠‡∏ô‡πÄ‡∏≠‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ: ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô + ‡πÄ‡∏á‡∏≤‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
  .btn-hot-pending:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 94, 98, 0.6);
    filter: brightness(1.1);
  }

  /* ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÑ‡∏ü‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡πÄ‡∏ö‡∏≤‡πÜ */
  @keyframes pulse-red {
    0% { box-shadow: 0 0 0 0 rgba(255, 94, 98, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(255, 94, 98, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 94, 98, 0); }
  }

  /* ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏£‡πâ‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏° class 'pulse-active' */
  .pulse-active {
    animation: pulse-red 2s infinite;
  }

  /* Page Title Styling */
  .page-title {
    gap: .75rem;
  }

  .page-title-icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    background: linear-gradient(135deg, #0d6efd, #6610f2);
    color: #fff;
    box-shadow: 0 .25rem .5rem rgba(13, 110, 253, .35);
  }

  .page-title-main {
    font-size: 1.6rem;
    font-weight: 700;
    letter-spacing: .03em;
    color: #212529;
  }

  /* Adjust spacing */
  .row.g-3.align-items-end.mb-2 {
    margin-bottom: .75rem !important;
  }

  /* KPI Buttons */
  .kpi-order-ready{filter:saturate(1.25) contrast(1.1);border-width:2px;}
  .kpi-order-ready:hover{box-shadow:0 0 0 .25rem rgba(25,135,84,.45);}
  .kpi-order-low{filter:saturate(1.25) contrast(1.1);border-width:2px;}
  .kpi-order-low:hover{box-shadow:0 0 0 .25rem rgba(255,193,7,.45);}
  .kpi-order-nosale{filter:saturate(1.1) contrast(1.05);border-width:2px;}
  .kpi-order-nosale:hover{box-shadow:0 0 0 .25rem rgba(108,117,125,.45);}
  .kpi-order-cancelled{filter:saturate(1.1) contrast(1.05);border-width:2px;}
  .kpi-order-cancelled:hover{box-shadow:0 0 0 .25rem rgba(108,117,125,.45);}

  /* ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô sort ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å (checkbox) */
  #ordersTable thead th:first-child:before,
  #ordersTable thead th:first-child:after { display: none !important; }

  /* --- [‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡∏°‡πà] ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç Order ‡πÅ‡∏ö‡∏ö Modern Blue --- */

  /* 1. ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏ã‡∏•‡∏•‡πå Order */
  #ordersTable td.order-cell {
    /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ò‡∏µ‡∏°‡πÄ‡∏ß‡πá‡∏ö */
    border-left: 2px solid #0d6efd !important;
    border-right: 2px solid #0d6efd !important;
    
    /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° */
    font-weight: 700;
    color: #084298; 
    
    /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
    vertical-align: middle;
    
    /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏à‡∏≤‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π */
    background-color: rgba(255, 255, 255, 0.6) !important;
  }

  /* 2. ‡∏õ‡∏¥‡∏î‡∏´‡∏±‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á (‡πÄ‡∏™‡πâ‡∏ô‡∏ö‡∏ô) */
  tr.order-group-start td.order-cell {
    border-top: 2px solid #0d6efd !important;
    /* (‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô) ‡∏ó‡∏≥‡∏°‡∏∏‡∏°‡∏°‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏≤ */
    box-shadow: inset 0 2px 0 0 rgba(13, 110, 253, 0.1); 
  }

  /* 3. ‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡πà‡∏≠‡∏á (‡πÄ‡∏™‡πâ‡∏ô‡∏•‡πà‡∏≤‡∏á) */
  tr.order-group-end td.order-cell {
    border-bottom: 2px solid #0d6efd !important;
    /* (‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô) ‡∏ó‡∏≥‡∏°‡∏∏‡∏°‡∏°‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏≤ */
    box-shadow: inset 0 -2px 0 0 rgba(13, 110, 253, 0.1);
  }

  /* 4. ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏ö‡∏≤‡∏á‡∏•‡∏á */
  tr.order-group-start td:not(.order-cell),
  tr.order-group-end td:not(.order-cell) {
    border-top: 1px solid #dee2e6 !important;
    border-bottom: 1px solid #dee2e6 !important;
  }
  
  /* --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏µ‡∏Å‡∏£‡∏≠‡∏ö --- */
  
  /* Remove default DataTables sorting icons */
  table.dataTable thead .sorting:before,
  table.dataTable thead .sorting:after,
  table.dataTable thead .sorting_asc:before,
  table.dataTable thead .sorting_asc:after,
  table.dataTable thead .sorting_desc:before,
  table.dataTable thead .sorting_desc:after {
    display: none !important;
  }
  
  /* Excel-like sorting indicators - must come after removing defaults */
  table.dataTable thead th.sorting,
  table.dataTable thead th.sorting_asc,
  table.dataTable thead th.sorting_desc {
    cursor: pointer;
    position: relative;
    padding-right: 30px !important;
    user-select: none;
  }
  
  /* Custom sort icons with higher specificity */
  table.dataTable thead th.sorting::after {
    content: '‚áÖ' !important;
    display: inline-block !important;
    position: absolute !important;
    right: 8px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    opacity: 0.4 !important;
    font-size: 16px !important;
    line-height: 1 !important;
  }
  
  table.dataTable thead th.sorting_asc::after {
    content: '‚ñ≤' !important;
    display: inline-block !important;
    position: absolute !important;
    right: 8px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    opacity: 1 !important;
    font-size: 12px !important;
    color: #0d6efd !important;
    font-weight: bold !important;
    line-height: 1 !important;
  }
  
  table.dataTable thead th.sorting_desc::after {
    content: '‚ñº' !important;
    display: inline-block !important;
    position: absolute !important;
    right: 8px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    opacity: 1 !important;
    font-size: 12px !important;
    color: #0d6efd !important;
    font-weight: bold !important;
    line-height: 1 !important;
  }
  
  /* Hover effect */
  table.dataTable thead th.sorting:hover,
  table.dataTable thead th.sorting_asc:hover,
  table.dataTable thead th.sorting_desc:hover {
    background-color: #e9ecef !important;
  }
</style>

<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å -->
<div class="table-responsive">
  <div class="alert alert-info alert-dismissible fade show d-print-none" role="alert">
    <strong>üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á:</strong>
    <ul class="mb-0 mt-2">
      <li><strong>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:</strong> ‡πÉ‡∏ä‡πâ‡∏ä‡πà‡∏≠‡∏á "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Global Search)" ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
      <li><strong>‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong> ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (A-Z, ‡∏Å-‡∏Æ, ‡∏ô‡πâ‡∏≠‡∏¢‚Üí‡∏°‡∏≤‡∏Å)</li>
      <li><strong>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á:</strong> ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô (Z-A, ‡∏Æ-‡∏Å, ‡∏°‡∏≤‡∏Å‚Üí‡∏ô‡πâ‡∏≠‡∏¢)</li>
      <li><strong>‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô:</strong> ‚áÖ = ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ | ‚ñ≤ = ‡πÄ‡∏£‡∏µ‡∏¢‡∏á A-Z / ‡∏ô‡πâ‡∏≠‡∏¢‚Üí‡∏°‡∏≤‡∏Å | ‚ñº = ‡πÄ‡∏£‡∏µ‡∏¢‡∏á Z-A / ‡∏°‡∏≤‡∏Å‚Üí‡∏ô‡πâ‡∏≠‡∏¢</li>
    </ul>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  
  <table id="ordersTable" class="table table-striped table-bordered table-sm align-middle">
    <thead class="table-light">
      <tr>
        <th class="text-center" style="width:36px;"><input type="checkbox" id="check-all" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"></th>
        <th>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</th>
        <th>‡∏£‡πâ‡∏≤‡∏ô</th>
        <th>‡πÄ‡∏•‡∏Ç Order</th>
        <th>SKU</th>
        <th>Brand</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
        <th>Stock</th>
        <th>Qty</th>
        <th>AllQty</th>
        <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á</th>
        <th>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</th>
        <th>SLA</th>
        <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏ô‡∏™‡πà‡∏á</th>
        <th>‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
        <th>‡∏ú‡∏π‡πâ‡∏Å‡∏î‡∏£‡∏±‡∏ö</th>
        <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      {% set overdue = (r.sla and r.sla.startswith('‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î')) and (r.allocation_status != 'PACKED') %}
      {# ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ READY_ACCEPT ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏Å‡∏±‡∏ô Low Stock, Shortage, Not Enough ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ) #}
      {% set can_accept = (r.allocation_status == 'READY_ACCEPT') %}
      {# [NEW] ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Order ID ‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà #}
      {% set is_order_ready = (r.order_id in ready_oids) %}
      <tr class="{% if r.is_cancelled %}cancelled-row{% elif overdue %}table-danger{% endif %}" data-order-id="{{ r.order_id }}">
        <td class="text-center">
          <input type="checkbox" class="form-check-input js-row-check" 
                 data-id="{{ r.id }}" 
                 value="{{ r.id }}"
                 data-can-accept="{{ 'true' if can_accept else 'false' }}"
                 data-order-ready="{{ 'true' if is_order_ready else 'false' }}">
        </td>
        <td>{{ r.platform }}</td>
        <td>{{ r.shop }}</td>
        <td class="order-cell">{{ r.order_id }}</td>
        <td>{{ r.sku }}</td>
        <td>{{ r.brand }}</td>
        <td>{{ r.model }}</td>
        <td>{{ r.stock_qty }}</td>
        <td>{{ r.qty }}</td>
        <td>{{ r.allqty }}</td>
        <td class="text-nowrap" data-ordertime="{{ r.order_time_iso }}" data-platform="{{ r.platform }}">{{ r.order_time|thai_be }}</td>
        <td>{{ r.due_date|be_date }}</td>
        <td class="sla-cell" data-status="{{ r.allocation_status }}" data-platform="{{ r.platform }}" data-ordertime="{{ r.order_time_iso }}">
          {% if r.allocation_status != 'PACKED' %}{{ r.sla }}{% endif %}
        </td>
        <td>{{ r.logistic or '-' }}</td>
        <td>
          {% if r.is_not_in_sbs %}
            <span class="text-danger fw-bold">Order‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤SBS</span>
          {% else %}
            {{ r.sales_status or '-' }}
          {% endif %}
        </td>
        <td>
          {% if r.is_issued %}
            <span class="badge bg-info text-dark border border-info">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
            <div style="font-size: 0.7rem; color: #666;">
              {% if r.allocation_status == "READY_ACCEPT" %}(‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö)
              {% elif r.allocation_status == "LOW_STOCK" %}(‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢)
              {% elif r.allocation_status == "SHORTAGE" %}(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤)
              {% elif r.allocation_status == "NOT_ENOUGH" %}(‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡πà‡∏á)
              {% endif %}
            </div>
          {% elif r.allocation_status == "READY_ACCEPT" %}
            <span class="badge text-bg-success">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏î‡∏£‡∏±‡∏ö</span>
          {% elif r.allocation_status == "ACCEPTED" %}
            <span class="badge text-bg-secondary">‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
          {% elif r.allocation_status == "PACKED" %}
            <span class="badge text-bg-dark">‡πÅ‡∏û‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß</span>
          {% elif r.allocation_status == "CANCELLED" %}
            <span class="badge text-bg-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>
          {% elif r.allocation_status == "LOW_STOCK" %}
            <span class="badge text-bg-warning">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢ (1‚Äì3)</span>
          {% elif r.allocation_status == "SHORTAGE" %}
            <span class="badge text-bg-danger">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
          {% elif r.allocation_status == "NOT_ENOUGH" %}
            <span class="badge text-bg-danger">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡πà‡∏á</span>
          {% else %}
            <span class="badge text-bg-light text-dark">-</span>
          {% endif %}
        </td>
        <td class="text-nowrap">
          <div class="d-flex gap-1 flex-wrap">
          {% if r.is_cancelled %}
            <span class="text-muted">-</span>
          {% else %}
            {% if r.is_issued %}
              <button class="btn btn-sm btn-secondary" disabled title="Order ‡∏ô‡∏µ‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>
            {% elif r.accepted %}
              <span class="badge bg-success"><i class="bi bi-check2-all"></i> ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
            {% elif r.allocation_status == 'READY_ACCEPT' %}
              <form method="post" action="{{ url_for('dashboard_accept_order') }}" class="d-inline">
                <input type="hidden" name="order_id" value="{{ r.order_id }}">
                <input type="hidden" name="sku" value="{{ r.sku }}">
                <input type="hidden" name="platform" value="{{ platform_sel or '' }}">
                <input type="hidden" name="shop_id" value="{{ shop_sel or '' }}">
                <button type="submit" class="btn btn-sm btn-success fw-bold shadow-sm" 
                        onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ?')">
                    <i class="bi bi-check-circle-fill"></i> ‡∏Å‡∏î‡∏£‡∏±‡∏ö
                </button>
              </form>
            {% else %}
              {# ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢ / ‡πÑ‡∏°‡πà‡∏û‡∏≠ / ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î) -> ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ ‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ #}
              <button type="button" class="btn btn-sm btn-secondary opacity-50" disabled style="cursor: not-allowed;" title="‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö">
                  <i class="bi bi-x-circle"></i> ‡∏Å‡∏î‡∏£‡∏±‡∏ö
              </button>
            {% endif %}
            
            {% if r.allocation_status == "ACCEPTED" %}
              <form method="post" action="{{ url_for('cancel_accept', order_line_id=r.id) }}" class="d-inline">
                <button class="btn btn-sm btn-warning text-dark fw-bold" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏£‡∏±‡∏ö" style="border: 1px solid #d39e00;">
                    <i class="bi bi-arrow-counterclockwise"></i> ‡∏ñ‡∏≠‡∏¢‡∏Å‡∏•‡∏±‡∏ö
                </button>
              </form>
            {% endif %}
            
            {# ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Order ‡∏ñ‡∏≤‡∏ß‡∏£ - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡∏°‡∏≠‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô PACKED ‡πÅ‡∏•‡∏∞ CANCELLED) #}
            {% if r.allocation_status not in ["PACKED"] %}
              <button class="btn btn-sm btn-outline-danger" 
                      onclick="openCancelModal('{{ r.order_id }}')"
                      title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Order ‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£">
                <i class="bi bi-x-circle"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </button>
            {% endif %}
          {% endif %}
          </div>
        </td>
        <td>{{ r.accepted_by or '-' }}</td>
        <td>
          {# ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å + ‡πÄ‡∏ß‡∏•‡∏≤ #}
          {% if r.is_cancelled %}
            <div class="d-flex flex-column align-items-start">
                <span class="text-danger small fw-bold">
                    <i class="bi bi-info-circle"></i> {{ r.cancel_reason or '-' }}
                </span>
                {% if r.cancel_at %}
                    <span class="text-muted" style="font-size: 0.75rem;">
                        <i class="bi bi-clock"></i> {{ r.cancel_at }}
                    </span>
                {% endif %}
            </div>
          {% else %}
            <span class="text-muted small">-</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background: rgba(255,255,255,0.8); z-index: 9999; backdrop-filter: blur(2px);">
    <div class="text-center shadow p-4 rounded bg-white">
        <div class="spinner-border text-primary mb-2" role="status" style="width: 3rem; height: 3rem;"></div>
        <h5 class="m-0 text-primary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h5>
    </div>
</div>

<script>
function confirmBulkDeleteOrders() {
  // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Selector ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏ö‡∏à‡∏≤‡∏Å class .js-row-check ‡πÅ‡∏ó‡∏ô
  const checked = document.querySelectorAll(".js-row-check:checked");
  
  if (!checked.length) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ï‡∏¥‡πä‡∏Å‡∏ñ‡∏π‡∏Å) ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö");
    return;
  }
  
  // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Order ‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ã‡πâ‡∏≥) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô confirm message
  const oids = new Set();
  checked.forEach(ch => {
    const tr = ch.closest("tr");
    if (tr && tr.dataset && tr.dataset.orderId) {
      oids.add(tr.dataset.orderId);
    }
  });
  
  const msg = oids.size > 0
    ? `‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?\n- ${Array.from(oids).slice(0,10).join("\n- ")}${oids.size>10?`\n... (+${oids.size-10} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`:''}\n\n(‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà 'Order‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö' ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)`
    : "‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö Order ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?";
    
  if (!confirm(msg)) return;

  // ‡πÅ‡∏™‡∏î‡∏á Loading
  const loader = document.getElementById('loadingOverlay');
  if(loader) loader.classList.remove('d-none');

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á Hidden Inputs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ app.py
  const form = document.getElementById("bulk-delete-form");
  form.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤
  
  checked.forEach(ch => {
    const hid = document.createElement("input");
    hid.type = "hidden";
    hid.name = "order_line_ids[]"; // ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ Backend ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ
    hid.value = ch.value;          // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ id ‡∏Ç‡∏≠‡∏á OrderLine
    form.appendChild(hid);
  });
  
  form.submit();
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞ redirect ‡πÑ‡∏õ dashboard ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà)

// ========== ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô DataTable ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á ==========
document.addEventListener('DOMContentLoaded', function() {
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ jQuery ‡πÅ‡∏•‡∏∞ DataTable ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  if (typeof $ !== 'undefined' && $.fn.dataTable) {
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô DataTable ‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á #ordersTable
    var table = $('#ordersTable').DataTable({
      // [‡πÅ‡∏Å‡πâ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà 1] ‡πÄ‡∏õ‡∏¥‡∏î Paging ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏†‡∏≤‡∏£‡∏∞ Browser
      "paging": true,          
      "pageLength": 50,        // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏∞ 50 ‡πÅ‡∏ñ‡∏ß (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
      "lengthMenu": [[50, 100, 200, -1], [50, 100, 200, "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"]],
      
      "searching": false,     // ‡∏õ‡∏¥‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡∏≠‡∏á DataTables (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏°‡∏µ Global Search ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
      "info": true,           // ‡πÇ‡∏ä‡∏ß‡πå‡∏ß‡πà‡∏≤‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà
      "ordering": true,       // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
      "order": [],            // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á (‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° Database ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤)
      
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á Order ID ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô
      "orderFixed": [[3, 'asc']], // 3 ‡∏Ñ‡∏∑‡∏≠ index ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡πÄ‡∏•‡∏Ç Order"
      
      "columnDefs": [
        { "orderable": false, "targets": 0 } // ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å (Checkbox)
      ],
      "language": {
        "emptyTable": "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á",
        "info": "‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å _TOTAL_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
        "infoEmpty": "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
        "infoFiltered": "(‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å _MAX_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)",
        "paginate": {
          "first": "‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å",
          "last": "‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢",
          "next": "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ",
          "previous": "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤"
        },
        "lengthMenu": "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏´‡∏ô‡πâ‡∏≤"
      },
      
      // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö (‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÅ‡∏Ñ‡πà 100 ‡∏£‡∏≠‡∏ö ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏±‡∏ô)
      "drawCallback": function (settings) {
        var api = this.api();
        var rows = api.rows({page:'current'}).nodes();
        var last = null;
        
        // ‡∏•‡∏ö Class ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
        $(rows).removeClass('order-group-start order-group-end');
 
        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ Order ID
        api.column(3, {page:'current'}).data().each(function (group, i) {
          // ‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç Order (‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á strip html tags ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
          var orderId = typeof group === 'string' ? group.replace(/<[^>]*>/g, '').trim() : group;
          
          if (last !== orderId) {
            // ‡πÄ‡∏à‡∏≠ Order ‡πÉ‡∏´‡∏°‡πà -> ‡∏Ç‡∏µ‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ö‡∏ô‡∏´‡∏ô‡∏≤‡πÜ ‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ
            $(rows).eq(i).addClass('order-group-start');
            
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÉ‡∏´‡πâ‡∏Ç‡∏µ‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            if (i > 0) {
              $(rows).eq(i - 1).addClass('order-group-end');
            }
            
            last = orderId;
          }
        });
        
        // ‡∏Ç‡∏µ‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        if (rows.length > 0) {
           $(rows).last().addClass('order-group-end');
        }
      }
    });

  } else {
    console.warn("jQuery ‡∏´‡∏£‡∏∑‡∏≠ DataTables ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ base.html");
  }
});

// ========== ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏° KPI Filter (‡πÄ‡∏û‡∏¥‡πà‡∏° Loading) ==========
document.addEventListener('DOMContentLoaded', function() {
  const kpiButtons = document.querySelectorAll('.kpi-filter');
  const filterForm = document.getElementById('filterForm');
  const statusSelect = filterForm ? filterForm.querySelector('select[name="status"]') : null;
  const loadingOverlay = document.getElementById('loadingOverlay');

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏ä‡∏ß‡πå Loading
  function showLoading() {
    if (loadingOverlay) loadingOverlay.classList.remove('d-none');
  }

  // 1. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° KPI
  kpiButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      showLoading(); // ‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏î
      
      // ‡∏£‡∏≠ browser render loading ‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∂‡∏á‡∏Ñ‡πà‡∏≠‡∏¢ submit
      setTimeout(() => {
        const status = this.getAttribute('data-status');
        if (statusSelect) {
          statusSelect.value = status;
          filterForm.submit();
        }
      }, 10);
    });
  });
  
  // 2. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏Å‡∏£‡∏≠‡∏á" ‡∏õ‡∏Å‡∏ï‡∏¥
  const btnFilter = document.getElementById('btn-filter');
  if (btnFilter) {
    btnFilter.addEventListener('click', function() {
      showLoading();
    });
  }
  
  // 3. ‡∏Å‡∏î Export Excel
  const btnExport = document.getElementById('btn-export');
  if (btnExport) {
    btnExport.addEventListener('click', function(e) {
      if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Excel?')) {
        e.preventDefault();
        return;
      }
      showLoading();
      // ‡∏ã‡πà‡∏≠‡∏ô Loading ‡∏´‡∏•‡∏±‡∏á 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏Å‡∏£‡∏ì‡∏µ Export ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡πá‡∏ß)
      setTimeout(() => {
        if (loadingOverlay) loadingOverlay.classList.add('d-none');
      }, 5000);
    });
  }
});

// ========== ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö Form Submit ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ß (‡∏Å‡∏î‡∏£‡∏±‡∏ö / ‡∏ñ‡∏≠‡∏¢‡∏Å‡∏•‡∏±‡∏ö) ==========
document.addEventListener('submit', function(e) {
    const form = e.target;
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡∏Å‡∏î‡∏£‡∏±‡∏ö" (dashboard_accept_order)
    if (form.action && form.action.includes('dashboard/accept_order')) {
        if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô "‡∏Å‡∏î‡∏£‡∏±‡∏ö" ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) {
            e.preventDefault();
            return false;
        }
    }
    
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏° "‡∏ñ‡∏≠‡∏¢‡∏Å‡∏•‡∏±‡∏ö" (cancel_accept)
    if (form.action && form.action.includes('cancel_accept')) {
        if (!confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ "‡∏ñ‡∏≠‡∏¢‡∏Å‡∏•‡∏±‡∏ö" (‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß)?')) {
            e.preventDefault();
            return false;
        }
    }
});

// ========== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Order ==========
function openCancelModal(orderId) {
    document.getElementById('modalOrderIdDisplay').innerText = orderId;
    document.getElementById('inputOrderIdForCancel').value = orderId;
    document.getElementById('cancelReasonInput').value = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
    
    var myModal = new bootstrap.Modal(document.getElementById('cancelOrderModal'));
    myModal.show();
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô submit
document.addEventListener('DOMContentLoaded', function() {
    var cancelForm = document.getElementById('cancelOrderForm');
    if (cancelForm) {
        cancelForm.addEventListener('submit', function(e) {
            var reason = document.getElementById('cancelReasonInput').value.trim();
            if (!reason) {
                e.preventDefault();
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');
                return false;
            }
            // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏û‡∏¥‡πà‡∏° confirm ‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
            if (!confirm('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞ "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Order" ‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?')) {
                e.preventDefault();
                return false;
            }
            // ‡πÇ‡∏ä‡∏ß‡πå Loading ‡πÄ‡∏°‡∏∑‡πà‡∏≠ submit
            var loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) loadingOverlay.classList.remove('d-none');
            return true;
        });
    }
});

// ========== ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Checkbox ‡πÅ‡∏•‡∏∞ ‡∏õ‡∏∏‡πà‡∏° Bulk Actions ==========
document.addEventListener('DOMContentLoaded', function() {
    const checkAll = document.getElementById('check-all');
    const bulkBar = document.getElementById('bulk-bar');
    const selectedCountSpan = document.getElementById('selected-count');
    const btnBulkClear = document.getElementById('btn-bulk-clear');
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ñ‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    function updateBulkBar() {
        const checked = document.querySelectorAll('.js-row-check:checked');
        const count = checked.length;
        if (selectedCountSpan) selectedCountSpan.innerText = count;
        
        if (count > 0) {
            bulkBar.classList.remove('d-none');
        } else {
            bulkBar.classList.add('d-none');
            if (checkAll) checkAll.checked = false;
        }
    }

    // Event: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    if (checkAll) {
        checkAll.addEventListener('change', function() {
            const isChecked = this.checked;
            document.querySelectorAll('.js-row-check').forEach(chk => {
                chk.checked = isChecked;
            });
            updateBulkBar();
        });
    }

    // Event: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ß
    const tbody = document.querySelector('tbody');
    if (tbody) {
        tbody.addEventListener('change', function(e) {
            if (e.target.classList.contains('js-row-check')) {
                updateBulkBar();
                if (!e.target.checked && checkAll) checkAll.checked = false;
            }
        });
    }

    // Event: ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    if (btnBulkClear) {
        btnBulkClear.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.js-row-check').forEach(chk => chk.checked = false);
            updateBulkBar();
        });
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Submit)
    function submitBulkForm(actionUrl) {
        const checked = document.querySelectorAll('.js-row-check:checked');
        if (checked.length === 0) return;

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = actionUrl;

        checked.forEach(chk => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'order_line_ids[]';
            input.value = chk.value;
            form.appendChild(input);
        });

        document.body.appendChild(form);
        
        // ‡πÇ‡∏ä‡∏ß‡πå Loading
        const loader = document.getElementById('loadingOverlay');
        if(loader) loader.classList.remove('d-none');
        
        form.submit();
    }

    // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Logic ‡πÉ‡∏´‡∏°‡πà: ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å) ---
    const btnBulkAccept = document.getElementById('btn-bulk-accept-confirm');
    if (btnBulkAccept) {
        const newBtn = btnBulkAccept.cloneNode(true);
        btnBulkAccept.parentNode.replaceChild(newBtn, btnBulkAccept);

        newBtn.addEventListener('click', function(e) {
            e.preventDefault(); 
            e.stopPropagation();

            const checked = document.querySelectorAll('.js-row-check:checked');
            
            // [Logic ‡πÉ‡∏´‡∏°‡πà] ‡πÅ‡∏¢‡∏Å‡∏ô‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞ ‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
            // ‡πÉ‡∏ä‡πâ data-order-ready ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Order ‡∏ô‡∏±‡πâ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö "‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            let validCount = 0;
            let invalidCount = 0;
            const validIds = []; // ‡πÄ‡∏Å‡πá‡∏ö ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ submit ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

            checked.forEach(chk => {
                // ‡πÉ‡∏ä‡πâ data-order-ready ‡πÅ‡∏ó‡∏ô data-can-accept
                // true = Order ‡∏ô‡∏µ‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö (‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô READY_ACCEPT)
                if (chk.getAttribute('data-order-ready') === 'true') {
                    validCount++;
                    validIds.push(chk);
                } else {
                    invalidCount++;
                }
            });

            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ï‡πà‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            if (validCount === 0) {
                if (invalidCount > 0) {
                    alert(`‚ùå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${invalidCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ\n\n‚õî ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô Order ‡∏ô‡∏±‡πâ‡∏ô‡πÜ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î/‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡πà‡∏á\n(‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏î‡∏£‡∏±‡∏ö" ‡∏ó‡∏±‡πâ‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)`);
                } else {
                    alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
                }
                return;
            }

            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏∞‡∏Å‡∏±‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ) ‡∏´‡∏£‡∏∑‡∏≠ ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            let msg = `‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ "‡∏Å‡∏î‡∏£‡∏±‡∏ö" ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${validCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;
            
            if (invalidCount > 0) {
                msg += `\n\n‚õî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏° ${invalidCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°\n(‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏î‡∏£‡∏±‡∏ö" ‡∏ó‡∏±‡πâ‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)`;
            }

            const isConfirmed = confirm(msg);

            if (isConfirmed) {
                // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ validIds ‡πÑ‡∏õ Backend ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = "{{ url_for('bulk_accept') }}";
                
                validIds.forEach(chk => {
                    const inp = document.createElement('input');
                    inp.type = 'hidden';
                    inp.name = 'order_line_ids[]';
                    inp.value = chk.value;
                    form.appendChild(inp);
                });
                
                document.body.appendChild(form);
                
                // ‡πÇ‡∏ä‡∏ß‡πå Loading
                const loader = document.getElementById('loadingOverlay');
                if(loader) loader.classList.remove('d-none');
                
                form.submit();
            } else {
                console.log("User cancelled bulk accept.");
                return false;
            }
        });
    }

    // ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const btnBulkCancel = document.getElementById('btn-bulk-cancel');
    if (btnBulkCancel) {
        const newBtnCancel = btnBulkCancel.cloneNode(true);
        btnBulkCancel.parentNode.replaceChild(newBtnCancel, btnBulkCancel);

        newBtnCancel.addEventListener('click', function(e) {
            e.preventDefault();
            const count = document.querySelectorAll('.js-row-check:checked').length;
            if (count === 0) return;

            if (confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏±‡∏ö" ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n(‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥)`)) {
                submitBulkForm("{{ url_for('bulk_cancel') }}");
            }
        });
    }
});
</script>

<!-- ========== Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Order ========== -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="cancelOrderModalLabel">
          <i class="bi bi-exclamation-triangle-fill me-2"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Order
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('cancel_order_permanent') }}" id="cancelOrderForm">
        <div class="modal-body">
          <div class="alert alert-warning border-0 bg-light">
            <i class="bi bi-info-circle me-1"></i>
            ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Order: <strong id="modalOrderIdDisplay" class="text-primary"></strong>
          </div>
          <p class="small text-muted mb-3">
            ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
          </p>
          
          <input type="hidden" name="order_id" id="inputOrderIdForCancel">
          
          {# ‡∏™‡πà‡∏á query params ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô #}
          {% for key, val in request.args.items() %}
            <input type="hidden" name="{{ key }}" value="{{ val }}">
          {% endfor %}
          
          <div class="mb-3">
            <label for="cancelReasonInput" class="form-label fw-bold text-danger">
              <i class="bi bi-chat-left-text me-1"></i> ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å <span class="text-danger">*</span>
            </label>
            <textarea name="reason" id="cancelReasonInput" class="form-control" rows="3" 
                      placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å, ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏ñ‡∏≤‡∏ß‡∏£, ‡∏™‡∏±‡πà‡∏á‡∏ú‡∏¥‡∏î, ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô" 
                      required></textarea>
            <div class="form-text text-muted">
              <i class="bi bi-lightbulb me-1"></i> ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            </div>
          </div>
        </div>
        <div class="modal-footer bg-light">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg me-1"></i> ‡∏õ‡∏¥‡∏î
          </button>
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash me-1"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Order
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="scroll-nav-container">
  <button type="button" class="btn btn-secondary btn-lg rounded-circle shadow-lg mb-2" id="btn-scroll-to-bottom" title="‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á">
    <i class="bi bi-arrow-down fw-bold"></i>
  </button>
  
  <button type="button" class="btn btn-primary btn-lg rounded-circle shadow-lg" id="btn-back-to-top" title="‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô">
    <i class="bi bi-arrow-up fw-bold"></i>
  </button>
</div>

<style>
  .scroll-nav-container {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 9999;
    display: flex;
    flex-direction: column; /* ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
    gap: 10px; /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° */
  }

  .scroll-nav-container button {
    width: 50px;
    height: 50px;
    padding: 0;
    font-size: 1.5rem;
    transition: all 0.3s ease;
    opacity: 0.7;
    border: none;
    display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß JS ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå */
  }
  
  /* ‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
  #btn-back-to-top { background-color: #0b5ed7; color: white; }
  #btn-back-to-top:hover { opacity: 1; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(11, 94, 215, 0.4) !important; }

  /* ‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏á */
  #btn-scroll-to-bottom { background-color: #6c757d; color: white; }
  #btn-scroll-to-bottom:hover { opacity: 1; transform: translateY(3px); box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4) !important; }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const btnUp = document.getElementById("btn-back-to-top");
    const btnDown = document.getElementById("btn-scroll-to-bottom");

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå/‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°
    function checkScroll() {
      const scrollPos = window.scrollY || document.documentElement.scrollTop;
      const winHeight = window.innerHeight;
      const docHeight = document.documentElement.scrollHeight;

      // 1. ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô: ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏°‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 300px
      if (scrollPos > 300) {
        btnUp.style.display = "block";
      } else {
        btnUp.style.display = "none";
      }

      // 2. ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏á: ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏≠‡∏µ‡∏Å 300px)
      if (scrollPos + winHeight < docHeight - 300) {
        btnDown.style.display = "block";
      } else {
        btnDown.style.display = "none";
      }
    }

    // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
    window.addEventListener("scroll", checkScroll);
    // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏¢‡∏≤‡∏ß)
    checkScroll();

    // --- Action ‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô ---
    btnUp.addEventListener("click", function() {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // --- Action ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏á ---
    btnDown.addEventListener("click", function() {
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    });
  });
</script>

{% endblock %}