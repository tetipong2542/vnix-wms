
{% extends "base.html" %}
{% block content %}

<style>
    /* --- Modern Dashboard CSS --- */
    :root {
        --card-radius: 16px;
        --btn-radius: 10px;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
        --shadow-md: 0 5px 15px rgba(0,0,0,0.08);
        --shadow-hover: 0 8px 25px rgba(0,0,0,0.12);
    }

    /* KPI Cards Styling */
    .kpi-card {
        border: none;
        border-radius: var(--card-radius);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        overflow: hidden;
        position: relative;
        cursor: pointer;
        box-shadow: var(--shadow-sm);
        height: 100%;
        min-height: 120px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏≠‡∏∂‡∏î‡∏≠‡∏±‡∏î */
        text-decoration: none !important;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .kpi-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }

    /* Gradients */
    .bg-gradient-fire { background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); color: white; }
    .bg-gradient-success { background: linear-gradient(135deg, #1dd1a1 0%, #10ac84 100%); color: white; }
    .bg-gradient-warning { background: linear-gradient(135deg, #feca57 0%, #ff9f43 100%); color: white; }
    .bg-gradient-danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%); color: white; }
    .bg-gradient-info { background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%); color: white; }
    .bg-gradient-dark { background: linear-gradient(135deg, #576574 0%, #222f3e 100%); color: white; }
    .bg-gradient-secondary { background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%); color: #2d3436; }

    .kpi-card-body { padding: 16px; position: relative; z-index: 2; }
    
    .kpi-title { font-size: 1.125rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.95; margin-bottom: 5px; font-weight: 700; }
    .kpi-value { font-size: 2.6rem; font-weight: 800; line-height: 1; margin-bottom: 8px; }
    
    /* [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏õ‡∏£‡∏±‡∏ö‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå‡∏õ‡πâ‡∏≤‡∏¢ ‡πÄ‡∏Å‡πà‡∏≤/‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
    .kpi-sub { 
        font-size: 0.85rem; 
        background: rgba(0,0,0,0.15); /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
        padding: 6px 12px; 
        border-radius: 8px; 
        display: inline-flex; /* ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
        align-items: center;
        gap: 8px;
        backdrop-filter: blur(4px);
        font-weight: 600;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        width: fit-content;
    }
    
    /* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏Å‡πà‡∏≤ (‡∏™‡∏µ‡πÇ‡∏ó‡∏ô‡∏£‡πâ‡∏≠‡∏ô/‡πÅ‡∏î‡∏á‡∏≠‡πà‡∏≠‡∏ô) */
    .val-old { color: #ffe5e5; font-weight: 800; font-size: 1.1em; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    /* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏´‡∏°‡πà (‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡∏™‡∏ß‡πà‡∏≤‡∏á) */
    .val-new { color: #ffffff; font-weight: 800; font-size: 1.1em; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    
    .divider { opacity: 0.6; font-weight: normal; font-size: 0.9em; }

    /* Override Text Colors ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏µ‡∏≠‡πà‡∏≠‡∏ô (Warning/Secondary) */
    .bg-gradient-warning .kpi-title, .bg-gradient-warning .kpi-value { text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .bg-gradient-secondary .kpi-sub { background: rgba(0,0,0,0.08); color: #636e72; }
    .bg-gradient-secondary .val-old { color: #d63031; } /* ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
    .bg-gradient-secondary .val-new { color: #2d3436; } /* ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏° */

    .kpi-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 3rem; opacity: 0.15; z-index: 1; }

    /* Filter & Table */
    .section-label { font-size: 1rem; color: #57606f; font-weight: 700; margin: 25px 0 15px 0; display: flex; align-items: center; }
    .section-label::after { content: ''; flex: 1; height: 2px; background: #f1f2f6; margin-left: 15px; border-radius: 2px; }
    .filter-bar, .action-bar { background: #fff; padding: 15px 20px; border-radius: 12px; box-shadow: var(--shadow-sm); border: 1px solid #f1f2f6; margin-bottom: 20px; }
    .table-container { border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-sm); border: 1px solid #dfe4ea; background: white; }
    #ordersTable thead th { background-color: #f8f9fa; color: #2f3542; font-weight: 700; border-bottom: 2px solid #dfe4ea; vertical-align: middle; text-transform: uppercase; font-size: 0.8rem; }
    #ordersTable td.order-cell { border-left: 3px solid #0d6efd !important; border-right: 2px solid #0d6efd !important; font-weight: 700; color: #0d6efd; vertical-align: middle; background-color: #f8faff !important; }
    tr.order-group-start td.order-cell { border-top: 2px solid #0d6efd !important; }
    tr.order-group-end td.order-cell { border-bottom: 2px solid #0d6efd !important; }
    tr.cancelled-row { background-color: #ffeaea !important; opacity: 0.8; }
    tr.cancelled-row td { text-decoration: line-through; color: #ff4757; }
    tr.cancelled-row td.order-cell, tr.cancelled-row td:last-child { text-decoration: none; }
    .btn-report { border-width: 1px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; border-radius: var(--btn-radius); }
    .btn-report:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

    /* ‚úÖ ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å(‡∏Å‡πà‡∏≠‡∏ô)/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å(‡∏´‡∏•‡∏±‡∏á)/‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞ (+25%) */
    h6.text-muted.mb-1.text-uppercase.small.fw-bold {
        font-size: 1.1rem !important;
    }

    /* ‚úÖ ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ" ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î inline style font-size:0.7rem (+25%) */
    small.text-muted[style*="font-size:0.7rem"] {
        font-size: 0.875rem !important;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <div class="page-title-icon me-3" style="width:48px;height:48px;background:linear-gradient(135deg, #3742fa, #5352ed);color:white;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;box-shadow:0 4px 10px rgba(55,66,250,0.3);">üìä</div>
        <div>
            <h3 class="mb-0 fw-bold text-dark">Dashboard</h3>
            <div class="d-flex align-items-center gap-2 mt-1">
                {% if all_time %}
                    <span class="badge bg-info text-white rounded-pill px-3">üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Time)</span>
                {% elif mode == 'today' %}
                    <span class="badge bg-success text-white rounded-pill px-3">üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Today)</span>
                {% elif use_default_view %}
                    <span class="badge bg-primary text-white rounded-pill px-3">‚ö° ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á + ‡∏á‡∏≤‡∏ô‡∏à‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</span>
                {% else %}
                    <span class="badge bg-secondary text-white rounded-pill px-3">üîç ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á (Filtered)</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div>
        {% if mode == 'today' %}
            <a href="{{ url_for('dashboard') }}" class="btn btn-light border shadow-sm fw-bold px-3 py-2" style="border-radius: 10px;">
                <i class="bi bi-arrow-left text-secondary"></i> ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á
            </a>
        {% else %}
            <a href="{{ url_for('dashboard', mode='today') }}" class="btn btn-primary shadow-sm fw-bold px-3 py-2" style="border-radius: 10px; background: linear-gradient(to right, #3742fa, #5352ed); border: none;">
                <i class="bi bi-calendar-check me-2"></i> ‡∏î‡∏π‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            </a>
        {% endif %}
    </div>
</div>

<div class="section-label text-danger">
    <i class="bi bi-fire me-2 fs-5"></i> 
    <span>‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (Pending Tasks)</span> 
    <span class="ms-2 badge bg-light text-danger border border-danger rounded-pill">‡∏î‡πà‡∏ß‡∏ô</span>
</div>

<div class="row g-3 mb-4">
    <div class="col-6 col-md-3 col-lg-2">
        <div class="kpi-card bg-gradient-fire kpi-filter" data-status="" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
            <div class="kpi-card-body">
                <div class="kpi-title">‡∏£‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á</div>
                <div class="kpi-value">{{ kpis.orders_unique }}</div>
                <div class="kpi-sub">
                    <span class="val-old">‡∏Ñ‡πâ‡∏≤‡∏á {{ kpis.orders_unique_old }}</span>
                    <span class="divider">|</span>
                    <span class="val-new">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ {{ kpis.orders_unique_new }}</span>
                </div>
                <i class="bi bi-inbox kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 col-lg-2">
        <div class="kpi-card bg-gradient-success kpi-filter" data-status="ORDER_READY" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≠‡∏á 1">
            <div class="kpi-card-body">
                <div class="kpi-title">‡∏Å‡∏≠‡∏á 1 (‡∏û‡∏£‡πâ‡∏≠‡∏°/‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô)</div>
                <div class="kpi-value">{{ kpis.orders_ready }}</div>
                <div class="kpi-sub">
                    <span class="val-old">‡∏Ñ‡πâ‡∏≤‡∏á {{ kpis.orders_ready_old }}</span>
                    <span class="divider">|</span>
                    <span class="val-new">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ {{ kpis.orders_ready_new }}</span>
                </div>
                <i class="bi bi-check-circle kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 col-lg-2">
        <div class="kpi-card bg-gradient-warning kpi-filter" data-status="ORDER_LOW_STOCK" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≠‡∏á 2">
            <div class="kpi-card-body">
                <div class="kpi-title">‡∏Å‡∏≠‡∏á 2 (‡∏ô‡πâ‡∏≠‡∏¢/‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô)</div>
                <div class="kpi-value">{{ kpis.orders_low }}</div>
                <div class="kpi-sub">
                    <span class="val-old">‡∏Ñ‡πâ‡∏≤‡∏á {{ kpis.orders_low_old }}</span>
                    <span class="divider">|</span>
                    <span class="val-new">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ {{ kpis.orders_low_new }}</span>
                </div>
                <i class="bi bi-exclamation-triangle kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 col-lg-2">
        <div class="kpi-card bg-gradient-danger kpi-filter" data-status="ORDER_PROBLEM" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≠‡∏á 3">
            <div class="kpi-card-body">
                <div class="kpi-title">‡∏Å‡∏≠‡∏á 3 (‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≤‡∏î/‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô)</div>
                <div class="kpi-value">{{ kpis.orders_problem }}</div>
                <div class="kpi-sub">
                    <span class="val-old">‡∏Ñ‡πâ‡∏≤‡∏á {{ kpis.orders_problem_old }}</span>
                    <span class="divider">|</span>
                    <span class="val-new">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ {{ kpis.orders_problem_new }}</span>
                </div>
                <i class="bi bi-x-octagon kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="col-12 col-md-12 col-lg-4">
        <div class="row g-3 h-100">
            <div class="col-6">
                <div class="kpi-card bg-gradient-secondary kpi-filter" data-status="ORDER_NO_SALES">
                    <div class="kpi-card-body">
                        <div class="kpi-title text-dark">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏û‡πá‡∏Ñ</div>
                        <div class="kpi-value text-dark">{{ kpis.orders_nosales }}</div>
                        <div class="kpi-sub">
                            <span class="val-old">‡∏Ñ‡πâ‡∏≤‡∏á {{ kpis.orders_nosales_old }}</span>
                            <span class="divider">|</span>
                            <span class="val-new">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ {{ kpis.orders_nosales_new }}</span>
                        </div>
                        <i class="bi bi-file-earmark-x kpi-icon text-dark opacity-25"></i>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="kpi-card bg-gradient-secondary kpi-filter" data-status="ORDER_NOT_IN_SBS">
                    <div class="kpi-card-body">
                        <div class="kpi-title text-dark">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ SBS</div>
                        <div class="kpi-value text-dark">{{ kpis.orders_not_in_sbs }}</div>
                        <div class="kpi-sub">
                            <span class="val-old">‡∏Ñ‡πâ‡∏≤‡∏á {{ kpis.orders_not_in_sbs_old }}</span>
                            <span class="divider">|</span>
                            <span class="val-new">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ {{ kpis.orders_not_in_sbs_new }}</span>
                        </div>
                        <i class="bi bi-cloud-slash kpi-icon text-dark opacity-25"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section-label text-primary">
    <i class="bi bi-flag-fill me-2 fs-5"></i> 
    <span>‡∏á‡∏≤‡∏ô‡∏à‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (Completed Today)</span>
</div>

<div class="row g-3 mb-4">
    <div class="col-6 col-md-3 col-lg-3">
        <a href="{{ url_for('dashboard_issued') }}" class="kpi-card bg-gradient-info text-decoration-none">
            <div class="kpi-card-body">
                <div class="kpi-title">‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
                <div class="kpi-value">{{ issued_count or 0 }}</div>
                <div class="kpi-sub"><i class="bi bi-calendar-check me-1"></i> ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                <i class="bi bi-send kpi-icon"></i>
            </div>
        </a>
    </div>

    <div class="col-6 col-md-3 col-lg-3">
        <div class="kpi-card bg-gradient-dark kpi-filter" data-status="PACKED">
            <div class="kpi-card-body">
                <div class="kpi-title">‡πÅ‡∏û‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß</div>
                <div class="kpi-value">{{ kpis.packed }}</div>
                <div class="kpi-sub"><i class="bi bi-calendar-check me-1"></i> ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                <i class="bi bi-box-seam kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="col-12 col-md-6 col-lg-6">
        <div class="card border-0 shadow-sm h-100" style="border-radius: var(--card-radius); background-color: #f8f9fa;">
            <div class="card-body d-flex justify-content-around align-items-center p-0">
                <div class="text-center kpi-filter flex-grow-1 p-3 h-100 d-flex flex-column justify-content-center" data-status="ORDER_CANCELLED" style="cursor:pointer; border-right:1px solid #dee2e6;">
                    <h6 class="text-muted mb-1 text-uppercase small fw-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å(‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏û‡πá‡∏Ñ)</h6>
                    <span class="fs-2 fw-bold text-secondary">{{ kpis.orders_cancelled }}</span>
                    <small class="text-muted" style="font-size:0.7rem;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
                </div>
                <div class="text-center kpi-filter flex-grow-1 p-3 h-100 d-flex flex-column justify-content-center" data-status="ORDER_CANCELLED_PACKED" style="cursor:pointer; border-right:1px solid #dee2e6;">
                    <h6 class="text-muted mb-1 text-uppercase small fw-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å(‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏û‡πá‡∏Ñ)</h6>
                    <span class="fs-2 fw-bold text-danger">{{ kpis.orders_cancelled_packed }}</span>
                    <small class="text-muted" style="font-size:0.7rem;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
                </div>
                <a href="{{ url_for('dashboard_deleted') }}" class="text-center text-decoration-none flex-grow-1 p-3 h-100 d-flex flex-column justify-content-center">
                    <h6 class="text-muted mb-1 text-uppercase small fw-bold"><i class="bi bi-trash"></i> ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞(‡∏•‡∏öOrder)</h6>
                    <span class="fs-2 fw-bold text-secondary">{{ kpis.orders_deleted }}</span>
                    <small class="text-muted" style="font-size:0.7rem;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="action-bar d-flex flex-wrap gap-2 align-items-center">
    <span class="text-muted small fw-bold text-uppercase me-2 d-none d-md-block"><i class="bi bi-printer-fill me-1"></i> ‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô/‡∏û‡∏¥‡∏°‡∏û‡πå‡∏á‡∏≤‡∏ô:</span>
    
    <div class="btn-group">
        <a href="{{ url_for('print_warehouse', platform=platform_sel, shop_id=shop_sel) }}" class="btn btn-report btn-outline-primary fw-bold">
            <i class="bi bi-file-earmark-text"></i> ‡∏Å‡∏≠‡∏á 1: ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á
        </a>
        <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"></button>
        <ul class="dropdown-menu shadow">
            <li><a class="dropdown-item" href="{{ url_for('warehouse_printed_history') }}"><i class="bi bi-clock-history me-2"></i> ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå</a></li>
        </ul>
    </div>

    <div class="btn-group">
        <a href="{{ url_for('picking_list', platform=platform_sel, shop_id=shop_sel) }}" class="btn btn-report btn-outline-success fw-bold">
            <i class="bi bi-basket"></i> Picking List
        </a>
        <button type="button" class="btn btn-outline-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"></button>
        <ul class="dropdown-menu shadow">
            <li><a class="dropdown-item" href="{{ url_for('picking_printed_history') }}"><i class="bi bi-clock-history me-2"></i> ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå</a></li>
        </ul>
    </div>
    
    <div class="vr bg-secondary opacity-25 mx-1 d-none d-md-block"></div>

    <a href="{{ url_for('report_lowstock', platform=platform_sel, shop_id=shop_sel) }}" class="btn btn-report btn-outline-warning text-dark fw-bold">
        <i class="bi bi-exclamation-circle"></i> ‡∏Å‡∏≠‡∏á 2: ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢
    </a>
    <a href="{{ url_for('report_nostock', platform=platform_sel, shop_id=shop_sel) }}" class="btn btn-report btn-outline-danger fw-bold">
        <i class="bi bi-x-circle"></i> ‡∏Å‡∏≠‡∏á 3: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    </a>
    <a href="{{ url_for('report_notenough', platform=platform_sel, shop_id=shop_sel) }}" class="btn btn-report btn-outline-danger fw-bold">
        <i class="bi bi-dash-circle"></i> ‡∏Å‡∏≠‡∏á 3: ‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡πà‡∏á
    </a>

    <div class="ms-auto">
        <a href="{{ url_for('export_excel', q=q, platform=platform_sel, shop_id=shop_sel, status=status_sel, all_time=all_time, mode=mode) }}" class="btn btn-success text-white shadow-sm fw-bold" style="border-radius: 10px;">
            <i class="bi bi-file-earmark-excel-fill"></i> Excel
        </a>
    </div>
</div>

<div class="filter-bar">
    <form class="row gy-3 gx-3 align-items-end" method="get" id="filterForm">
        {% if all_time %}<input type="hidden" name="all_time" value="1">{% endif %}
        {% if mode %}<input type="hidden" name="mode" value="{{ mode }}">{% endif %}

        <div class="col-md-2">
            <label class="form-label text-muted small fw-bold mb-1">‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</label>
            <select class="form-select form-select-sm bg-light border-0" name="platform">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                {% for p in ["Shopee","TikTok","Lazada","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] %}
                    <option value="{{p}}" {% if platform_sel==p %}selected{% endif %}>{{p}}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label text-muted small fw-bold mb-1">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label>
            <select class="form-select form-select-sm bg-light border-0" name="shop_id">
                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                {% for s in shops %}
                    <option value="{{ s.id }}" {% if shop_sel and shop_sel|int==s.id %}selected{% endif %}>
                        {{ s.platform }} ‚Ä¢ {{ s.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-2">
            <label class="form-label text-muted small fw-bold mb-1">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÄ‡∏£‡∏¥‡πà‡∏°)</label>
            <input type="date" class="form-control form-control-sm bg-light border-0" name="import_from" value="{{ import_from_sel or '' }}">
        </div>
        <div class="col-md-2">
            <label class="form-label text-muted small fw-bold mb-1">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (‡∏ñ‡∏∂‡∏á)</label>
            <input type="date" class="form-control form-control-sm bg-light border-0" name="import_to" value="{{ import_to_sel or '' }}">
        </div>
        
        <div class="col-md-4">
            <label class="form-label text-muted small fw-bold mb-1">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (Global Search)</label>
            <div class="input-group input-group-sm">
                <input type="text" class="form-control bg-light border-0" name="q" value="{{ q or '' }}" placeholder="‡πÄ‡∏•‡∏Ç Order, SKU, ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...">
                <button class="btn btn-primary px-4" type="submit" id="btn-filter"><i class="bi bi-search"></i></button>
                <a href="{{ url_for('dashboard') }}" class="btn btn-light border" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤"><i class="bi bi-arrow-counterclockwise"></i></a>
            </div>
        </div>

        <input type="hidden" name="status" value="{{ status_sel }}">
        
        <div class="col-md-2 mt-2">
            <label class="form-label text-muted small fw-bold mb-1">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡πÄ‡∏£‡∏¥‡πà‡∏°)</label>
            <input type="date" class="form-control form-control-sm bg-light border-0" name="date_from" value="{{ date_from_sel or '' }}">
        </div>
        <div class="col-md-2 mt-2">
            <label class="form-label text-muted small fw-bold mb-1">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ñ‡∏∂‡∏á)</label>
            <input type="date" class="form-control form-control-sm bg-light border-0" name="date_to" value="{{ date_to_sel or '' }}">
        </div>
        
        <div class="col-md-8 mt-2 d-flex align-items-center justify-content-end gap-2">
             {% if not all_time %}
                <a href="{{ url_for('dashboard', all_time='1') }}" class="btn btn-sm btn-outline-info rounded-pill px-3">
                    <i class="bi bi-calendar3"></i> ‡∏î‡∏π‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Time)
                </a>
            {% else %}
                <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-info text-white rounded-pill px-3">
                    <i class="bi bi-check-circle"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π All Time
                </a>
            {% endif %}
        </div>
    </form>
</div>

<div id="bulk-bar" class="alert alert-primary d-none d-flex justify-content-between align-items-center shadow-sm py-2 mb-3 rounded-pill px-4 border-0" style="background-color: #e7f1ff; color: #0d6efd;">
    <div class="d-flex align-items-center">
        <i class="bi bi-check-square-fill me-2 fs-5"></i>
        <span class="fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <span id="selected-count" class="badge bg-primary text-white fs-6 mx-1 rounded-pill">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-sm btn-primary fw-bold rounded-pill px-3" id="btn-bulk-accept-confirm"><i class="bi bi-check-lg"></i> ‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</button>
        <button class="btn btn-sm btn-warning text-dark fw-bold rounded-pill px-3" id="btn-bulk-cancel"><i class="bi bi-arrow-counterclockwise"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏±‡∏ö</button>
        <div class="vr bg-secondary opacity-25 mx-1"></div>
        <button class="btn btn-sm btn-danger fw-bold rounded-pill px-3" onclick="confirmBulkDeleteOrders()"><i class="bi bi-trash"></i> ‡∏•‡∏ö</button>
        <button class="btn btn-sm btn-light text-muted rounded-circle" id="btn-bulk-clear"><i class="bi bi-x-lg"></i></button>
    </div>
</div>
<form id="bulk-delete-form" method="post" action="{{ url_for('bulk_delete_orders') }}"></form>

<div class="table-container" id="ordersTableSection">
    <table id="ordersTable" class="table table-hover align-middle mb-0" style="width:100%">
        <thead>
            <tr>
                <th class="text-center" width="30"><input type="checkbox" id="check-all" class="form-check-input" style="cursor:pointer;"></th>
                <th>Platform</th>
                <th>‡∏£‡πâ‡∏≤‡∏ô</th>
                <th>‡πÄ‡∏•‡∏Ç Order</th>
                <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU)</th>
                <th>Brand</th>
                <th>Stock</th>
                <th>Qty</th>
                <th>AllQty</th>
                <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡πà‡∏á</th>
                <th>SLA</th>
                <th>‡∏Ç‡∏ô‡∏™‡πà‡∏á</th>
                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th>‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
                <th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö</th>
                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            </tr>
        </thead>
        <tbody>
            {% for r in rows %}
            {% set overdue = (r.sla and r.sla.startswith('‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î')) and (r.allocation_status != 'PACKED') %}
            {% set can_accept = (r.allocation_status == 'READY_ACCEPT') %}
            {% set is_order_ready = (r.order_id in ready_oids) %}
            <tr class="{% if r.is_cancelled %}cancelled-row{% elif overdue %}table-danger{% endif %}" data-order-id="{{ r.order_id }}">
                <td class="text-center">
                    <input type="checkbox" class="form-check-input js-row-check" 
                           data-id="{{ r.id }}" 
                           value="{{ r.id }}"
                           data-can-accept="{{ 'true' if can_accept else 'false' }}"
                           data-order-ready="{{ 'true' if is_order_ready else 'false' }}">
                </td>
                <td><span class="badge bg-light text-dark border">{{ r.platform }}</span></td>
                <td class="small text-muted">{{ r.shop }}</td>
                <td class="order-cell fw-bold text-primary text-nowrap">{{ r.order_id }}</td>
                <td>
                    <div class="fw-bold text-dark">{{ r.sku }}</div>
                    <div class="small text-muted text-truncate" style="max-width: 200px;">{{ r.model }}</div>
                </td>
                <td class="small">{{ r.brand }}</td>
                <td class="text-center">
                    <span class="badge {% if r.stock_qty <= 0 %}bg-danger{% elif r.stock_qty < r.qty %}bg-warning text-dark{% else %}bg-success{% endif %} rounded-pill px-2">
                        {{ r.stock_qty }}
                    </span>
                </td>
                <td class="text-center"><span class="badge bg-light text-dark border px-2 rounded-pill">{{ r.qty }}</span></td>
                <td class="text-center small text-muted">{{ r.allqty }}</td>
                <td class="small text-muted text-nowrap">{{ r.order_time|thai_be }}</td>
                <td class="small text-nowrap">{{ r.sla }}</td>
                <td class="small text-truncate" style="max-width: 100px;">{{ r.logistic or '-' }}</td>
                <td>
                    {% if r.card_tags and r.card_tags|length > 0 %}
                        <div class="mb-1">
                            {% for t in r.card_tags %}
                                <span class="badge {{ t.cls }} me-1" style="font-size:0.72rem;">{{ t.label }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% if r.is_issued %}
                        <span class="badge bg-info text-dark">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
                    {% elif r.allocation_status == "READY_ACCEPT" %}
                        <span class="badge bg-success">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö</span>
                    {% elif r.allocation_status == "ACCEPTED" %}
                        <span class="badge bg-secondary">‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
                    {% elif r.allocation_status == "LOW_STOCK" %}
                        <span class="badge bg-warning text-dark">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢</span>
                    {% elif r.allocation_status == "SHORTAGE" %}
                        <span class="badge bg-danger">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</span>
                    {% elif r.allocation_status == "NOT_ENOUGH" %}
                        <span class="badge bg-danger">‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡πà‡∏á</span>
                    {% elif r.allocation_status == "PACKED" %}
                        <span class="badge bg-dark">‡πÅ‡∏û‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß</span>
                    {% else %}
                        <span class="badge bg-light text-dark">{{ r.allocation_status }}</span>
                    {% endif %}
                </td>
                <td class="text-nowrap">
                    {% if not r.is_cancelled %}
                        {% if r.is_issued %}
                            <button class="btn btn-sm btn-secondary disabled opacity-50" style="font-size:0.7rem;">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>
                        {% elif r.accepted %}
                            <form method="post" action="{{ url_for('cancel_accept', order_line_id=r.id) }}" class="d-inline">
                                <button class="btn btn-sm btn-warning text-dark py-0 px-2" title="‡∏ñ‡∏≠‡∏¢‡∏Å‡∏•‡∏±‡∏ö" style="font-size:0.75rem; border-radius:6px;"><i class="bi bi-arrow-counterclockwise"></i> ‡∏ñ‡∏≠‡∏¢</button>
                            </form>
                        {# [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡πà‡∏≤ Order ID ‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö" (ready_oids) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô #}
                        {% elif r.allocation_status == "READY_ACCEPT" and r.order_id in ready_oids %}
                            <form method="post" action="{{ url_for('dashboard_accept_order') }}" class="d-inline">
                                <input type="hidden" name="order_id" value="{{ r.order_id }}">
                                <input type="hidden" name="sku" value="{{ r.sku }}">
                                <input type="hidden" name="platform" value="{{ platform_sel or '' }}">
                                <input type="hidden" name="shop_id" value="{{ shop_sel or '' }}">
                                <button class="btn btn-sm btn-success py-0 px-2 fw-bold" title="‡∏Å‡∏î‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô" style="font-size:0.75rem; border-radius:6px;"><i class="bi bi-check"></i> ‡∏£‡∏±‡∏ö</button>
                            </form>
                        {# [‡πÄ‡∏û‡∏¥‡πà‡∏°] ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Ready ‡πÅ‡∏ï‡πà‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ó‡∏≤ (‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ) #}
                        {% elif r.allocation_status == "READY_ACCEPT" %}
                             <button class="btn btn-sm btn-light text-muted border py-0 px-2" disabled style="font-size:0.75rem; border-radius:6px;" title="‡∏£‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"><i class="bi bi-hourglass"></i> ‡∏£‡∏≠‡∏Ñ‡∏£‡∏ö</button>
                        {% else %}
                             <button class="btn btn-sm btn-light text-muted border py-0 px-2" disabled style="font-size:0.75rem; border-radius:6px;"><i class="bi bi-x"></i> ‡∏£‡∏±‡∏ö</button>
                        {% endif %}
                        
                        {% if r.allocation_status != 'PACKED' %}
                            <button class="btn btn-sm btn-outline-danger py-0 px-2 ms-1" onclick="openCancelModal('{{ r.order_id }}')" title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" style="font-size:0.75rem; border-radius:6px;"><i class="bi bi-trash"></i></button>
                        {% endif %}
                    {% else %}
                        <span class="text-muted small">-</span>
                    {% endif %}
                </td>
                <td class="small text-muted">{{ r.accepted_by or '-' }}</td>
                <td class="small text-muted">
                    {% if r.is_cancelled %}
                        <span class="text-danger small"><i class="bi bi-info-circle"></i> {{ r.cancel_reason }}</span>
                    {% else %}
                        {{ r.note or '-' }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="cancelOrderModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 15px;">
      <div class="modal-header bg-danger text-white" style="border-radius: 15px 15px 0 0;">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Order</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{{ url_for('cancel_order_permanent') }}" id="cancelOrderForm">
        <div class="modal-body p-4">
          <div class="alert alert-warning border-0 bg-light d-flex align-items-center">
             <i class="bi bi-info-circle text-warning fs-4 me-3"></i>
             <div>‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å Order: <strong id="modalOrderIdDisplay" class="text-primary fs-5"></strong></div>
          </div>
          <input type="hidden" name="order_id" id="inputOrderIdForCancel">
          {% for key, val in request.args.items() %}<input type="hidden" name="{{ key }}" value="{{ val }}">{% endfor %}
          <div class="mb-3">
            <label class="form-label fw-bold text-danger">‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å *</label>
            <textarea name="reason" id="cancelReasonInput" class="form-control bg-light" rows="3" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å, ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏ñ‡∏≤‡∏ß‡∏£" style="border-radius: 10px;"></textarea>
          </div>
        </div>
        <div class="modal-footer bg-light border-0" style="border-radius: 0 0 15px 15px;">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
          <button type="submit" class="btn btn-danger fw-bold px-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="loadingOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background: rgba(255,255,255,0.7); z-index: 9999; backdrop-filter: blur(4px);">
    <div class="text-center shadow-lg p-4 rounded-4 bg-white">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <h6 class="m-0 text-secondary fw-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</h6>
    </div>
</div>

<div class="scroll-nav-container" style="position:fixed;bottom:30px;right:30px;z-index:9999;display:flex;flex-direction:column;gap:10px;">
  <button type="button" class="btn btn-secondary rounded-circle shadow border-0" id="btn-scroll-to-bottom" style="width:45px;height:45px;display:none; transition:transform 0.2s;"><i class="bi bi-arrow-down fs-5"></i></button>
  <button type="button" class="btn btn-primary rounded-circle shadow border-0" id="btn-back-to-top" style="width:45px;height:45px;display:none; background: linear-gradient(135deg, #0d6efd, #0a58ca); transition:transform 0.2s;"><i class="bi bi-arrow-up fs-5"></i></button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Init DataTable
    if (typeof $ !== 'undefined' && $.fn.dataTable) {
        var table = $('#ordersTable').DataTable({
            "paging": true, "pageLength": 50, "lengthMenu": [[50, 100, 200, -1], [50, 100, 200, "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"]],
            "searching": false, "info": true, "ordering": true, "order": [[3, 'asc']], 
            "columnDefs": [{ "orderable": false, "targets": 0 }],
            "drawCallback": function (settings) {
                var api = this.api(); var rows = api.rows({page:'current'}).nodes(); var last = null;
                $(rows).removeClass('order-group-start order-group-end');
                api.column(3, {page:'current'}).data().each(function (group, i) {
                    var orderId = typeof group === 'string' ? group.replace(/<[^>]*>/g, '').trim() : group;
                    if (last !== orderId) { $(rows).eq(i).addClass('order-group-start'); if (i > 0) $(rows).eq(i-1).addClass('order-group-end'); last = orderId; }
                });
                if (rows.length > 0) $(rows).last().addClass('order-group-end');
            }
        });
    }

    // =========================
    // Loading & Filters (FIX + AUTO SCROLL)
    // =========================
    function showLoading() {
        const el = document.getElementById('loadingOverlay');
        if (el) el.classList.remove('d-none');
    }

    const filterForm = document.getElementById('filterForm');

    // ‚úÖ ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà "submit ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏á" (‡∏Å‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏Å‡∏î Enter/‡∏Å‡∏î KPI ‡πÅ‡∏•‡πâ‡∏ß requestSubmit)
    // ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå loading + ‡∏ï‡∏±‡πâ‡∏á‡∏ò‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á reload
    if (filterForm) {
        filterForm.addEventListener('submit', function() {
            sessionStorage.setItem('scrollToOrders', '1');   // ‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡πá‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏î‡πâ‡∏ß‡∏¢
            showLoading();
        });
    }

    // ‚úÖ ‡∏Å‡∏î KPI -> ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤ status ‡∏•‡∏á input hidden ‡πÅ‡∏•‡πâ‡∏ß submit
    document.querySelectorAll('.kpi-filter').forEach(card => {
        card.addEventListener('click', function() {
            if (!filterForm) return;

            const statusVal = this.getAttribute('data-status') || '';

            // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏õ‡πá‡∏ô input hidden ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà select
            let statusInput = filterForm.querySelector('input[name="status"]');
            if (!statusInput) {
                statusInput = document.createElement('input');
                statusInput.type = 'hidden';
                statusInput.name = 'status';
                filterForm.appendChild(statusInput);
            }
            statusInput.value = statusVal;

            // ‡∏ï‡∏±‡πâ‡∏á‡∏ò‡∏á‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢ (‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ fallback submit ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏á event submit)
            sessionStorage.setItem('scrollToOrders', '1');

            // ‡πÉ‡∏ä‡πâ requestSubmit ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ submit event ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÇ‡∏ä‡∏ß‡πå loading ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô)
            if (filterForm.requestSubmit) filterForm.requestSubmit();
            else { showLoading(); filterForm.submit(); }
        });
    });

    // ‚úÖ ‡∏´‡∏•‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤ reload: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ò‡∏á ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    if (sessionStorage.getItem('scrollToOrders') === '1') {
        sessionStorage.removeItem('scrollToOrders');

        setTimeout(() => {
            const target = document.getElementById('ordersTableSection') || document.getElementById('ordersTable');
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ header fixed ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏±‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∏õ‡∏£‡∏±‡∏ö offset ‡πÑ‡∏î‡πâ
                window.scrollBy(0, -80);
            }
        }, 100);
    }

    // Bulk Actions
    const checkAll = document.getElementById('check-all');
    const bulkBar = document.getElementById('bulk-bar');
    const countSpan = document.getElementById('selected-count');
    
    function updateBulk() {
        const c = document.querySelectorAll('.js-row-check:checked').length;
        if(countSpan) countSpan.innerText = c;
        if(bulkBar) {
            if(c>0) bulkBar.classList.remove('d-none'); else bulkBar.classList.add('d-none');
        }
    }
    
    if(checkAll) checkAll.addEventListener('change', function(){
        document.querySelectorAll('.js-row-check').forEach(chk => chk.checked = this.checked);
        updateBulk();
    });
    
    document.querySelector('tbody').addEventListener('change', function(e){
        if(e.target.classList.contains('js-row-check')) {
            updateBulk();
            if(!e.target.checked && checkAll) checkAll.checked = false;
        }
    });
    
    document.getElementById('btn-bulk-clear').addEventListener('click', function(){
        document.querySelectorAll('.js-row-check').forEach(chk => chk.checked = false);
        if(checkAll) checkAll.checked = false;
        updateBulk();
    });

    // Bulk Accept Logic
    const btnAccept = document.getElementById('btn-bulk-accept-confirm');
    if(btnAccept) {
        const newBtn = btnAccept.cloneNode(true);
        btnAccept.parentNode.replaceChild(newBtn, btnAccept);
        newBtn.addEventListener('click', function(){
            const checked = document.querySelectorAll('.js-row-check:checked');
            let validIds = [];
            checked.forEach(chk => { if(chk.getAttribute('data-order-ready') === 'true') validIds.push(chk.value); });
            
            if(validIds.length === 0) { alert('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ö)'); return; }
            if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö ${validIds.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°?`)) {
                const f = document.createElement('form'); f.method='POST'; f.action="{{ url_for('bulk_accept') }}";
                validIds.forEach(v => { const i=document.createElement('input'); i.type='hidden'; i.name='order_line_ids[]'; i.value=v; f.appendChild(i); });
                document.body.appendChild(f); showLoading(); f.submit();
            }
        });
    }
    
    // Bulk Cancel Logic
    const btnCancel = document.getElementById('btn-bulk-cancel');
    if(btnCancel) {
        const newBtn = btnCancel.cloneNode(true);
        btnCancel.parentNode.replaceChild(newBtn, btnCancel);
        newBtn.addEventListener('click', function(){
            const checked = document.querySelectorAll('.js-row-check:checked');
            if(checked.length===0) return;
            if(confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏±‡∏ö ${checked.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) {
                const f = document.createElement('form'); f.method='POST'; f.action="{{ url_for('bulk_cancel') }}";
                checked.forEach(c => { const i=document.createElement('input'); i.type='hidden'; i.name='order_line_ids[]'; i.value=c.value; f.appendChild(i); });
                document.body.appendChild(f); showLoading(); f.submit();
            }
        });
    }

    // Scroll Buttons
    const btnUp = document.getElementById("btn-back-to-top");
    const btnDown = document.getElementById("btn-scroll-to-bottom");
    
    window.addEventListener("scroll", function() {
        const y = window.scrollY;
        if (y > 300) btnUp.style.display = "block"; else btnUp.style.display = "none";
        if (y + window.innerHeight < document.body.scrollHeight - 300) btnDown.style.display = "block"; else btnDown.style.display = "none";
    });
    
    btnUp.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
    btnDown.addEventListener("click", () => window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" }));
});

// Global functions
function openCancelModal(oid) {
    document.getElementById('modalOrderIdDisplay').innerText = oid;
    document.getElementById('inputOrderIdForCancel').value = oid;
    new bootstrap.Modal(document.getElementById('cancelOrderModal')).show();
}

function confirmBulkDeleteOrders() {
    const checked = document.querySelectorAll('.js-row-check:checked');
    if (checked.length === 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'); return; }
    if (confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö ${checked.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£? (‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ)`)) {
        const f = document.getElementById('bulk-delete-form'); f.innerHTML='';
        checked.forEach(c => { const i=document.createElement('input'); i.type='hidden'; i.name='order_line_ids[]'; i.value=c.value; f.appendChild(i); });
        f.submit();
    }
}
</script>

{% endblock %}