
{% extends "base.html" %}
{% block content %}

<style>
    /* --- Modern Dashboard CSS --- */
    :root {
        --card-radius: 16px;
        --btn-radius: 10px;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
        --shadow-md: 0 5px 15px rgba(0,0,0,0.08);
        --shadow-hover: 0 8px 25px rgba(0,0,0,0.12);
    }

    /* KPI Cards Styling */
    .kpi-card {
        border: none;
        border-radius: var(--card-radius);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        overflow: hidden;
        position: relative;
        cursor: pointer;
        box-shadow: var(--shadow-sm);
        height: 100%;
        min-height: 120px; /* เพิ่มความสูงนิดหน่อยให้ตัวเลขไม่อึดอัด */
        text-decoration: none !important;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .kpi-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }

    /* Gradients */
    .bg-gradient-fire { background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); color: white; }
    .bg-gradient-success { background: linear-gradient(135deg, #1dd1a1 0%, #10ac84 100%); color: white; }
    .bg-gradient-warning { background: linear-gradient(135deg, #feca57 0%, #ff9f43 100%); color: white; }
    .bg-gradient-danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5253 100%); color: white; }
    .bg-gradient-info { background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%); color: white; }
    .bg-gradient-dark { background: linear-gradient(135deg, #576574 0%, #222f3e 100%); color: white; }
    .bg-gradient-secondary { background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%); color: #2d3436; }

    /* Badge tone: Orange (match warning gradient end color) */
    .badge-orange { background-color: #ff9f43 !important; color: #ffffff !important; }

    /* Badge tone: Purple (สำหรับบิลเปล่า) */
    .bg-purple { background-color: #6f42c1 !important; color: #ffffff !important; }

    .kpi-card-body { padding: 16px; position: relative; z-index: 2; }
    
    .kpi-title { font-size: 1.125rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.95; margin-bottom: 5px; font-weight: 700; }
    .kpi-value { font-size: 2.6rem; font-weight: 800; line-height: 1; margin-bottom: 8px; }
    
    /* [แก้ไข] ปรับดีไซน์ป้าย เก่า/ใหม่ ให้ชัดเจน */
    .kpi-sub { 
        font-size: 0.85rem; 
        background: rgba(0,0,0,0.15); /* พื้นหลังเข้มขึ้นนิดนึงให้อ่านง่าย */
        padding: 6px 12px; 
        border-radius: 8px; 
        display: inline-flex; /* จัดเรียงแนวนอน */
        align-items: center;
        gap: 8px;
        backdrop-filter: blur(4px);
        font-weight: 600;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        width: fit-content;
    }
    
    /* ตัวเลขเก่า (สีโทนร้อน/แดงอ่อน) */
    .val-old { color: #ffe5e5; font-weight: 800; font-size: 1.1em; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    /* ตัวเลขใหม่ (สีขาวสว่าง) */
    .val-new { color: #ffffff; font-weight: 800; font-size: 1.1em; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    
    .divider { opacity: 0.6; font-weight: normal; font-size: 0.9em; }

    /* Override Text Colors สำหรับการ์ดสีอ่อน (Warning/Secondary) */
    .bg-gradient-warning .kpi-title, .bg-gradient-warning .kpi-value { text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .bg-gradient-secondary .kpi-sub { background: rgba(0,0,0,0.08); color: #636e72; }
    .bg-gradient-secondary .val-old { color: #d63031; } /* เก่าสีแดงเข้ม */
    .bg-gradient-secondary .val-new { color: #2d3436; } /* ใหม่สีเข้ม */

    .kpi-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 3rem; opacity: 0.15; z-index: 1; }

    /* Filter & Table */
    .section-label { font-size: 1rem; color: #57606f; font-weight: 700; margin: 25px 0 15px 0; display: flex; align-items: center; }
    .section-label::after { content: ''; flex: 1; height: 2px; background: #f1f2f6; margin-left: 15px; border-radius: 2px; }
    .filter-bar, .action-bar { background: #fff; padding: 15px 20px; border-radius: 12px; box-shadow: var(--shadow-sm); border: 1px solid #f1f2f6; margin-bottom: 20px; }
    .table-container { border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-sm); border: 1px solid #dfe4ea; background: white; }
    #ordersTable thead th { background-color: #f8f9fa; color: #2f3542; font-weight: 700; border-bottom: 2px solid #dfe4ea; vertical-align: middle; text-transform: uppercase; font-size: 0.8rem; }
    #ordersTable td.order-cell { border-left: 3px solid #0d6efd !important; border-right: 2px solid #0d6efd !important; font-weight: 700; color: #0d6efd; vertical-align: middle; background-color: #f8faff !important; }
    tr.order-group-start td.order-cell { border-top: 2px solid #0d6efd !important; }
    tr.order-group-end td.order-cell { border-bottom: 2px solid #0d6efd !important; }
    tr.cancelled-row { background-color: #ffeaea !important; opacity: 0.8; }
    tr.cancelled-row td { text-decoration: line-through; color: #ff4757; }
    tr.cancelled-row td.order-cell, tr.cancelled-row td:last-child { text-decoration: none; }
    .btn-report { border-width: 1px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; border-radius: var(--btn-radius); }
    .btn-report:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

    /* ✅ ขยายหัวข้อในบล็อก ยกเลิก(ก่อน)/ยกเลิก(หลัง)/ถังขยะ (+25%) */
    h6.text-muted.mb-1.text-uppercase.small.fw-bold {
        font-size: 1.1rem !important;
    }

    /* ✅ ขยายคำว่า "วันนี้" ที่ถูกกำหนด inline style font-size:0.7rem (+25%) */
    small.text-muted[style*="font-size:0.7rem"] {
        font-size: 0.875rem !important;
    }

    /* Scan checkbox (dark blue) */
    .scan-check {
        width: 18px;
        height: 18px;
        accent-color: #0d47a1;
        cursor: default;
    }
    .scan-check:disabled { opacity: 1; }

    /* Warehouse receive section: Cool & Vibrant Tone (purple/teal/bronze/pink) */
    .warehouse-section-label {
        color: #6c5ce7 !important;
    }
    .warehouse-section-label::after {
        background: rgba(108, 92, 231, 0.18) !important;
    }
    .warehouse-badge {
        background-color: #a29bfe !important;
        color: #2d3436 !important;
        border-color: transparent !important;
    }

    .warehouse-kpi {
        box-shadow: var(--shadow-md);
        color: #ffffff;
    }
    .warehouse-kpi::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(255,255,255,0.10) 0%, rgba(255,255,255,0) 55%);
        z-index: 1;
        pointer-events: none;
    }
    .warehouse-kpi .kpi-card-body { z-index: 2; }
    .warehouse-kpi .kpi-icon { opacity: 0.20; }

    .wh-tone-total {
        background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%) !important;
        color: #ffffff !important;
    }
    .wh-tone-g1 {
        background: linear-gradient(135deg, #00b894 0%, #00cec9 100%) !important;
        color: #ffffff !important;
    }
    .wh-tone-g2 {
        background: linear-gradient(135deg, #e17055 0%, #fab1a0 100%) !important;
        color: #ffffff !important;
    }
    .wh-tone-g3 {
        background: linear-gradient(135deg, #e84393 0%, #fd79a8 100%) !important;
        color: #ffffff !important;
    }

    /* Warehouse: small "สถานะเปลี่ยน" filter button */
    .wh-change-link {
        font-size: 0.80rem;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.30);
        color: #ffffff;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        line-height: 1;
        transition: all 0.15s ease-in-out;
        user-select: none;
    }
    .wh-change-link:hover {
        background: rgba(255, 255, 255, 0.28);
        transform: translateY(-1px);
        color: #ffffff;
    }
    .wh-change-link.active {
        background: rgba(0, 0, 0, 0.18);
        border-color: rgba(0, 0, 0, 0.20);
        font-weight: 800;
    }
    .wh-change-disabled {
        font-size: 0.80rem;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.10);
        border: 1px solid rgba(255, 255, 255, 0.18);
        color: rgba(255, 255, 255, 0.85);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        line-height: 1;
        user-select: none;
    }
    .wh-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        background: #ff4757;
        box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.65);
        animation: whPulse 1.4s infinite;
    }
    @keyframes whPulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.55); }
        70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0.00); }
        100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.00); }
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="d-flex align-items-center">
        <div class="page-title-icon me-3" style="width:48px;height:48px;background:linear-gradient(135deg, #3742fa, #5352ed);color:white;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;box-shadow:0 4px 10px rgba(55,66,250,0.3);"><i data-lucide="bar-chart-3"></i></div>
        <div>
            <h3 class="mb-0 fw-bold text-dark">Dashboard</h3>
            <div class="d-flex align-items-center gap-2 mt-1">
                {% if all_time %}
                    <span class="badge bg-info text-white rounded-pill px-3"><i data-lucide="calendar" class="lucide-sm me-1"></i> ข้อมูลทั้งหมด (All Time)</span>
                {% elif mode == 'today' %}
                    <span class="badge bg-success text-white rounded-pill px-3"><i data-lucide="calendar" class="lucide-sm me-1"></i> ข้อมูลเฉพาะวันนี้ (Today)</span>
                {% elif use_default_view %}
                    <span class="badge bg-primary text-white rounded-pill px-3"><i data-lucide="zap" class="lucide-sm me-1"></i> มุมมองปกติ (งานค้าง + งานจบวันนี้)</span>
                {% else %}
                    <span class="badge bg-secondary text-white rounded-pill px-3"><i data-lucide="search" class="lucide-sm me-1"></i> มุมมองแบบกำหนดเอง (Filtered)</span>
                {% endif %}

                {# แสดง Badge สถานะที่กรองอยู่ #}
                {% if status_sel %}
                    {% if status_sel == 'ORDER_READY' %}
                        <span class="badge bg-success text-white rounded-pill px-3"><i data-lucide="check-circle" class="lucide-sm me-1"></i> กำลังดู: กอง 1 (พร้อม/ยังไม่จ่ายงาน)</span>
                    {% elif status_sel in ['ORDER_LOW_STOCK', 'ORDER_LOW'] %}
                        <span class="badge bg-warning text-dark rounded-pill px-3"><i data-lucide="alert-triangle" class="lucide-sm me-1"></i> กำลังดู: กอง 2 (สินค้าน้อย)</span>
                    {% elif status_sel == 'ORDER_PROBLEM' %}
                        <span class="badge bg-danger text-white rounded-pill px-3"><i data-lucide="octagon-x" class="lucide-sm me-1"></i> กำลังดู: กอง 3 (ของขาด)</span>
                    {% elif status_sel == 'BILL_EMPTY' %}
                        <span class="badge rounded-pill px-3" style="background-color: #6f42c1; color: white;"><i data-lucide="file-text" class="lucide-sm me-1"></i> กำลังดู: บิลเปล่า</span>
                    {% elif status_sel == 'ORDER_NO_SALES' %}
                        <span class="badge bg-light text-dark border border-secondary rounded-pill px-3"><i data-lucide="file-x" class="lucide-sm me-1"></i> กำลังดู: ยังไม่ได้แพ็ค</span>
                    {% elif status_sel == 'ORDER_NOT_IN_SBS' %}
                        <span class="badge bg-light text-dark border border-secondary rounded-pill px-3"><i data-lucide="cloud-off" class="lucide-sm me-1"></i> กำลังดู: ยังไม่นำเข้า SBS</span>
                    {% elif status_sel in ['ORDER_NOT_SCANNED', 'ORDER_SCAN_BARCODE'] %}
                        <span class="badge bg-info text-white rounded-pill px-3"><i data-lucide="scan-barcode" class="lucide-sm me-1"></i> กำลังดู: รอ Scan Barcode</span>
                    {% elif status_sel == 'PACKED' %}
                        <span class="badge bg-dark text-white rounded-pill px-3"><i data-lucide="package" class="lucide-sm me-1"></i> กำลังดู: แพ็คแล้ว</span>
                    {% elif status_sel == 'ORDER_CANCELLED' %}
                        <span class="badge bg-secondary text-white rounded-pill px-3"><i data-lucide="x-circle" class="lucide-sm me-1"></i> กำลังดู: ยกเลิก (ก่อนแพ็ค)</span>
                    {% elif status_sel == 'ORDER_CANCELLED_PACKED' %}
                        <span class="badge bg-danger text-white rounded-pill px-3"><i data-lucide="x-circle" class="lucide-sm me-1"></i> กำลังดู: ยกเลิก (หลังแพ็ค)</span>
                    {% elif status_sel == 'WH_RECEIVE_TOTAL' %}
                        <span class="badge rounded-pill px-3" style="background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); color: white;"><i data-lucide="layers" class="lucide-sm me-1"></i> กำลังดู: รวมคลังรับงาน</span>
                    {% elif status_sel == 'WH_RECEIVE_G1' %}
                        <span class="badge rounded-pill px-3" style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); color: white;"><i data-lucide="clipboard-check" class="lucide-sm me-1"></i> กำลังดู: คลังรับงาน กอง 1</span>
                    {% elif status_sel == 'WH_RECEIVE_G2' %}
                        <span class="badge rounded-pill px-3" style="background: linear-gradient(135deg, #e17055 0%, #fab1a0 100%); color: white;"><i data-lucide="alert-triangle" class="lucide-sm me-1"></i> กำลังดู: คลังรับงาน กอง 2</span>
                    {% elif status_sel == 'WH_RECEIVE_G3' %}
                        <span class="badge rounded-pill px-3" style="background: linear-gradient(135deg, #e84393 0%, #fd79a8 100%); color: white;"><i data-lucide="octagon-x" class="lucide-sm me-1"></i> กำลังดู: คลังรับงาน กอง 3</span>
                    {% else %}
                        <span class="badge bg-secondary text-white rounded-pill px-3"><i data-lucide="filter" class="lucide-sm me-1"></i> กำลังดู: {{ status_sel }}</span>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    <div>
        {% if mode == 'today' %}
            <a href="{{ url_for('dashboard') }}" class="btn btn-light border shadow-sm fw-bold px-3 py-2" style="border-radius: 10px;">
                <i data-lucide="arrow-left" class="text-secondary"></i> กลับไปดูงานค้าง
            </a>
        {% else %}
            <a href="{{ url_for('dashboard', mode='today') }}" class="btn btn-primary shadow-sm fw-bold px-3 py-2" style="border-radius: 10px; background: linear-gradient(to right, #3742fa, #5352ed); border: none;">
                <i data-lucide="calendar-check" class="me-2"></i> ดูเฉพาะงานวันนี้
            </a>
        {% endif %}
    </div>
</div>

<div class="section-label text-danger">
    <i data-lucide="flame" class="me-2 fs-5"></i> 
    <span>งานค้างที่ต้องจัดการ (Pending Tasks)</span> 
    <span class="ms-2 badge bg-light text-danger border border-danger rounded-pill">ด่วน</span>
</div>

<div class="row g-3 mb-4">
    <div class="col-6 col-md-3 col-lg-2">
        <div class="kpi-card bg-gradient-fire kpi-filter" data-status="" title="คลิกเพื่อดูทั้งหมด">
            <div class="kpi-card-body">
                <div class="kpi-title">รวมงานค้าง</div>
                <div class="kpi-value">{{ kpis.orders_unique }}</div>
                <div class="kpi-sub">
                    <span class="val-old">ค้าง {{ kpis.orders_unique_old }}</span>
                    <span class="divider">|</span>
                    <span class="val-new">วันนี้ {{ kpis.orders_unique_new }}</span>
                </div>
                <i data-lucide="inbox" class="kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 col-lg-2">
        <div class="kpi-card bg-gradient-success kpi-filter" data-status="ORDER_READY" title="คลิกเพื่อดูกอง 1">
            <div class="kpi-card-body">
                <div class="kpi-title">กอง 1 (พร้อม/ยังไม่จ่ายงาน)</div>
                <div class="kpi-value">{{ kpis.orders_ready }}</div>
                <div class="kpi-sub">
                    <span class="val-old">ค้าง {{ kpis.orders_ready_old }}</span>
                    <span class="divider">|</span>
                    <span class="val-new">วันนี้ {{ kpis.orders_ready_new }}</span>
                </div>
                <i data-lucide="check-circle" class="kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 col-lg-2">
        <div class="kpi-card bg-gradient-warning kpi-filter" data-status="ORDER_LOW_STOCK" title="คลิกเพื่อดูกอง 2">
            <div class="kpi-card-body">
                <div class="kpi-title">กอง 2 (น้อย/ยังไม่จ่ายงาน)</div>
                <div class="kpi-value">{{ kpis.orders_low }}</div>
                <div class="kpi-sub">
                    <span class="val-old">ค้าง {{ kpis.orders_low_old }}</span>
                    <span class="divider">|</span>
                    <span class="val-new">วันนี้ {{ kpis.orders_low_new }}</span>
                </div>
                <i data-lucide="alert-triangle" class="kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 col-lg-2">
        <div class="kpi-card bg-gradient-danger kpi-filter" data-status="ORDER_PROBLEM" title="คลิกเพื่อดูกอง 3">
            <div class="kpi-card-body">
                <div class="kpi-title">กอง 3 (ของขาด/ยังไม่จ่ายงาน)</div>
                <div class="kpi-value">{{ kpis.orders_problem }}</div>
                <div class="kpi-sub">
                    <span class="val-old">ค้าง {{ kpis.orders_problem_old }}</span>
                    <span class="divider">|</span>
                    <span class="val-new">วันนี้ {{ kpis.orders_problem_new }}</span>
                </div>
                <i data-lucide="octagon-x" class="kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="col-12 col-md-12 col-lg-4">
        <div class="row g-2 h-100">
            <div class="col-12 col-sm-6 col-md-4">
                <div class="kpi-card bg-gradient-secondary kpi-filter" data-status="ORDER_NO_SALES">
                    <div class="kpi-card-body">
                        <div class="kpi-title text-dark">ยังไม่ได้แพ็ค</div>
                        <div class="kpi-value text-dark">{{ kpis.orders_nosales }}</div>
                        <div class="kpi-sub">
                            <span class="val-old">ค้าง {{ kpis.orders_nosales_old }}</span>
                            <span class="divider">|</span>
                            <span class="val-new">วันนี้ {{ kpis.orders_nosales_new }}</span>
                        </div>
                        <i data-lucide="file-x" class="kpi-icon text-dark opacity-25"></i>
                    </div>
                </div>
            </div>
            <div class="col-12 col-sm-6 col-md-4">
                <div class="kpi-card bg-gradient-secondary kpi-filter" data-status="ORDER_NOT_IN_SBS">
                    <div class="kpi-card-body">
                        <div class="kpi-title text-dark">ยังไม่นำเข้า SBS</div>
                        <div class="kpi-value text-dark">{{ kpis.orders_not_in_sbs }}</div>
                        <div class="kpi-sub">
                            <span class="val-old">ค้าง {{ kpis.orders_not_in_sbs_old }}</span>
                            <span class="divider">|</span>
                            <span class="val-new">วันนี้ {{ kpis.orders_not_in_sbs_new }}</span>
                        </div>
                        <i data-lucide="cloud-off" class="kpi-icon text-dark opacity-25"></i>
                    </div>
                </div>
            </div>

            <!-- Scan Barcode (นับเฉพาะงานค้างที่ยังไม่สแกน) -->
            <div class="col-12 col-sm-6 col-md-4">
                <div class="kpi-card bg-gradient-info kpi-filter" data-status="ORDER_NOT_SCANNED" title="คลิกเพื่อดู Order ที่ยังไม่สแกน">
                    <div class="kpi-card-body">
                        <div class="kpi-title">รอ Scan Barcode</div>
                        <div class="kpi-value">{{ kpis.orders_not_scanned }}</div>
                        <div class="kpi-sub">
                            <span class="val-old">ค้าง {{ kpis.orders_not_scanned_old }}</span>
                            <span class="divider">|</span>
                            <span class="val-new">วันนี้ {{ kpis.orders_not_scanned_new }}</span>
                        </div>
                        <i data-lucide="scan-barcode" class="kpi-icon"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="section-label text-primary">
    <i data-lucide="flag" class="me-2 fs-5"></i> 
    <span>งานจบวันนี้ (Completed Today)</span>
</div>

<div class="row g-3 mb-4">
    <div class="col-6 col-md-3 col-lg-3">
        <a href="{{ url_for('dashboard_issued') }}" class="kpi-card bg-gradient-info text-decoration-none">
            <div class="kpi-card-body">
                <div class="kpi-title">จ่ายงานแล้ว</div>
                <div class="kpi-value">{{ issued_count or 0 }}</div>
                <div class="kpi-sub"><i data-lucide="calendar-check" class="lucide-sm me-1"></i> เฉพาะวันนี้</div>
                <i data-lucide="send" class="kpi-icon"></i>
            </div>
        </a>
    </div>

    <div class="col-6 col-md-3 col-lg-3">
        <div class="kpi-card bg-gradient-dark kpi-filter" data-status="PACKED">
            <div class="kpi-card-body">
                <div class="kpi-title">แพ็คแล้ว</div>
                <div class="kpi-value">{{ kpis.packed }}</div>
                <div class="kpi-sub"><i data-lucide="calendar-check" class="lucide-sm me-1"></i> เฉพาะวันนี้</div>
                <i data-lucide="package" class="kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="col-12 col-md-6 col-lg-6">
        <div class="card border-0 shadow-sm h-100" style="border-radius: var(--card-radius); background-color: #f8f9fa;">
            <div class="card-body d-flex justify-content-around align-items-center p-0">
                <div class="text-center kpi-filter flex-grow-1 p-3 h-100 d-flex flex-column justify-content-center" data-status="ORDER_CANCELLED" style="cursor:pointer; border-right:1px solid #dee2e6;">
                    <h6 class="text-muted mb-1 text-uppercase small fw-bold">ยกเลิก(ก่อนแพ็ค)</h6>
                    <span class="fs-2 fw-bold text-secondary">{{ kpis.orders_cancelled }}</span>
                    <small class="text-muted" style="font-size:0.7rem;">วันนี้</small>
                </div>
                <div class="text-center kpi-filter flex-grow-1 p-3 h-100 d-flex flex-column justify-content-center" data-status="ORDER_CANCELLED_PACKED" style="cursor:pointer; border-right:1px solid #dee2e6;">
                    <h6 class="text-muted mb-1 text-uppercase small fw-bold">ยกเลิก(หลังแพ็ค)</h6>
                    <span class="fs-2 fw-bold text-danger">{{ kpis.orders_cancelled_packed }}</span>
                    <small class="text-muted" style="font-size:0.7rem;">วันนี้</small>
                </div>
                <a href="{{ url_for('dashboard_deleted') }}" class="text-center text-decoration-none flex-grow-1 p-3 h-100 d-flex flex-column justify-content-center">
                    <h6 class="text-muted mb-1 text-uppercase small fw-bold"><i data-lucide="trash-2"></i> ถังขยะ(ลบOrder)</h6>
                    <span class="fs-2 fw-bold text-secondary">{{ kpis.orders_deleted }}</span>
                    <small class="text-muted" style="font-size:0.7rem;">วันนี้</small>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="section-label warehouse-section-label">
    <i data-lucide="package" class="me-2 fs-5"></i>
    <span>คลังรับงาน (รับแล้ว/ยังไม่แพ็ค)</span>
    <span class="ms-2 badge rounded-pill warehouse-badge">กำลังดำเนินการ</span>
    {% if change_filter %}
        <a href="{{ url_for('dashboard', platform=platform_sel, shop_id=shop_sel) }}" class="ms-3 btn btn-sm btn-outline-secondary rounded-pill px-3" style="border-width:1px;">
            <i data-lucide="x-circle" class="lucide-sm"></i> ล้างตัวกรองสถานะเปลี่ยน
        </a>
    {% endif %}
</div>

<div class="row g-3 mb-4">
    <div class="col-6 col-md-3 col-lg-3">
        <div class="kpi-card warehouse-kpi wh-tone-total kpi-filter" data-status="WH_RECEIVE_TOTAL" title="คลิกเพื่อดูรวม: คลังรับงานที่ยังไม่แพ็ค">
            <div class="kpi-card-body">
                <div class="kpi-title">รวมงานค้าง (คลังรับงาน/ยังไม่ได้แพ็ค)</div>
                <div class="kpi-value">{{ kpis.wh_receive_total }}</div>
                <div class="kpi-sub">
                    <span class="val-old">ค้าง {{ kpis.wh_receive_total_old }}</span>
                    <span class="divider">|</span>
                    <span class="val-new">วันนี้ {{ kpis.wh_receive_total_new }}</span>
                </div>
                <div class="mt-2">
                    {% if kpis.wh_change_total and kpis.wh_change_total > 0 %}
                        <a class="wh-change-link {% if change_filter == 'TOTAL' %}active{% endif %}"
                                    href="{{ url_for('dashboard', show_change='TOTAL', platform=platform_sel, shop_id=shop_sel) }}"
                           onclick="event.stopPropagation(); sessionStorage.setItem('scrollToOrders','1');">
                            <span class="wh-dot"></span>
                            <span>สถานะเปลี่ยน {{ kpis.wh_change_total }}</span>
                        </a>
                    {% else %}
                        <span class="wh-change-disabled"><i data-lucide="arrow-left-right" class="lucide-sm"></i> สถานะเปลี่ยน 0</span>
                    {% endif %}
                </div>
                <i data-lucide="layers" class="kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 col-lg-3">
        <div class="kpi-card warehouse-kpi wh-tone-g1 kpi-filter" data-status="WH_RECEIVE_G1" title="คลิกเพื่อดู: กอง 1 (ใบงานคลัง + Picking)">
            <div class="kpi-card-body">
                <div class="kpi-title">กอง 1 (รับแล้ว/ยังไม่แพ็ค)</div>
                <div class="kpi-value">{{ kpis.wh_receive_g1 }}</div>
                <div class="kpi-sub">
                    <span class="val-old">ค้าง {{ kpis.wh_receive_g1_old }}</span>
                    <span class="divider">|</span>
                    <span class="val-new">วันนี้ {{ kpis.wh_receive_g1_new }}</span>
                </div>
                <div class="mt-2">
                    {% if kpis.wh_change_g1 and kpis.wh_change_g1 > 0 %}
                        <a class="wh-change-link {% if change_filter == 'G1' %}active{% endif %}"
                                    href="{{ url_for('dashboard', show_change='G1', platform=platform_sel, shop_id=shop_sel) }}"
                           onclick="event.stopPropagation(); sessionStorage.setItem('scrollToOrders','1');">
                            <span class="wh-dot"></span>
                            <span>สถานะเปลี่ยน {{ kpis.wh_change_g1 }}</span>
                        </a>
                    {% else %}
                        <span class="wh-change-disabled"><i data-lucide="arrow-left-right" class="lucide-sm"></i> สถานะเปลี่ยน 0</span>
                    {% endif %}
                </div>
                <i data-lucide="clipboard-check" class="kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 col-lg-3">
        <div class="kpi-card warehouse-kpi wh-tone-g2 kpi-filter" data-status="WH_RECEIVE_G2" title="คลิกเพื่อดู: กอง 2 (สินค้าน้อย)">
            <div class="kpi-card-body">
                <div class="kpi-title">กอง 2 (รับแล้ว/ยังไม่แพ็ค)</div>
                <div class="kpi-value">{{ kpis.wh_receive_g2 }}</div>
                <div class="kpi-sub">
                    <span class="val-old">ค้าง {{ kpis.wh_receive_g2_old }}</span>
                    <span class="divider">|</span>
                    <span class="val-new">วันนี้ {{ kpis.wh_receive_g2_new }}</span>
                </div>
                <div class="mt-2">
                    {% if kpis.wh_change_g2 and kpis.wh_change_g2 > 0 %}
                        <a class="wh-change-link {% if change_filter == 'G2' %}active{% endif %}"
                                    href="{{ url_for('dashboard', show_change='G2', platform=platform_sel, shop_id=shop_sel) }}"
                           onclick="event.stopPropagation(); sessionStorage.setItem('scrollToOrders','1');">
                            <span class="wh-dot"></span>
                            <span>สถานะเปลี่ยน {{ kpis.wh_change_g2 }}</span>
                        </a>
                    {% else %}
                        <span class="wh-change-disabled"><i data-lucide="arrow-left-right" class="lucide-sm"></i> สถานะเปลี่ยน 0</span>
                    {% endif %}
                </div>
                <i data-lucide="alert-triangle" class="kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 col-lg-3">
        <div class="kpi-card warehouse-kpi wh-tone-g3 kpi-filter" data-status="WH_RECEIVE_G3" title="คลิกเพื่อดู: กอง 3 (ไม่มีสินค้า + ไม่พอส่ง)">
            <div class="kpi-card-body">
                <div class="kpi-title">กอง 3 (รับแล้ว/ยังไม่แพ็ค)</div>
                <div class="kpi-value">{{ kpis.wh_receive_g3 }}</div>
                <div class="kpi-sub">
                    <span class="val-old">ค้าง {{ kpis.wh_receive_g3_old }}</span>
                    <span class="divider">|</span>
                    <span class="val-new">วันนี้ {{ kpis.wh_receive_g3_new }}</span>
                </div>
                <div class="mt-2">
                    {% if kpis.wh_change_g3 and kpis.wh_change_g3 > 0 %}
                        <a class="wh-change-link {% if change_filter == 'G3' %}active{% endif %}"
                                    href="{{ url_for('dashboard', show_change='G3', platform=platform_sel, shop_id=shop_sel) }}"
                           onclick="event.stopPropagation(); sessionStorage.setItem('scrollToOrders','1');">
                            <span class="wh-dot"></span>
                            <span>สถานะเปลี่ยน {{ kpis.wh_change_g3 }}</span>
                        </a>
                    {% else %}
                        <span class="wh-change-disabled"><i data-lucide="arrow-left-right" class="lucide-sm"></i> สถานะเปลี่ยน 0</span>
                    {% endif %}
                </div>
                <i data-lucide="octagon-x" class="kpi-icon"></i>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3 col-lg-3">
        <div class="kpi-card warehouse-kpi kpi-filter" data-status="BILL_EMPTY" title="คลิกเพื่อดู: บิลเปล่า" style="background: linear-gradient(135deg, #6f42c1 0%, #8b5cf6 100%);">
            <div class="kpi-card-body">
                <div class="kpi-title text-white">บิลเปล่า</div>
                <div class="kpi-value text-white">{{ kpis.orders_bill_empty }}</div>
                <div class="kpi-sub text-white opacity-75">
                    <span class="val-old">ค้าง {{ kpis.orders_bill_empty_old }}</span>
                    <span class="divider">|</span>
                    <span class="val-new">วันนี้ {{ kpis.orders_bill_empty_new }}</span>
                </div>
                <i data-lucide="file-text" class="kpi-icon text-white opacity-25"></i>
            </div>
        </div>
    </div>
</div>

<div class="action-bar d-flex flex-wrap gap-2 align-items-center">
    <span class="text-muted small fw-bold text-uppercase me-2 d-none d-md-block"><i data-lucide="printer" class="lucide-sm me-1"></i>Scan Barcode/พิมพ์งาน/จ่ายงาน:</span>
    
    <div class="btn-group">
        <a href="{{ url_for('print_warehouse', platform=platform_sel, shop_id=shop_sel) }}" class="btn btn-report btn-outline-primary fw-bold">
            <i data-lucide="file-text"></i> กอง 1: ใบงานคลัง
        </a>
        <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"></button>
        <ul class="dropdown-menu shadow">
            <li><a class="dropdown-item" href="{{ url_for('warehouse_printed_history') }}"><i data-lucide="history" class="lucide-sm me-2"></i> ดูประวัติการพิมพ์</a></li>
        </ul>
    </div>

    <div class="btn-group">
        <a href="{{ url_for('picking_list', platform=platform_sel, shop_id=shop_sel) }}" class="btn btn-report btn-outline-success fw-bold">
            <i data-lucide="shopping-basket"></i> Picking List
        </a>
        <button type="button" class="btn btn-outline-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"></button>
        <ul class="dropdown-menu shadow">
            <li><a class="dropdown-item" href="{{ url_for('picking_printed_history') }}"><i data-lucide="history" class="lucide-sm me-2"></i> ดูประวัติการพิมพ์</a></li>
        </ul>
    </div>
    
    <div class="vr bg-secondary opacity-25 mx-1 d-none d-md-block"></div>

    <a href="{{ url_for('report_lowstock', platform=platform_sel, shop_id=shop_sel) }}" class="btn btn-report btn-outline-warning text-dark fw-bold">
        <i data-lucide="alert-circle"></i> กอง 2: สินค้าน้อย
    </a>
    <a href="{{ url_for('report_nostock', platform=platform_sel, shop_id=shop_sel) }}" class="btn btn-report btn-outline-danger fw-bold">
        <i data-lucide="x-circle"></i> กอง 3: ไม่มีสินค้า
    </a>
    <a href="{{ url_for('report_notenough', platform=platform_sel, shop_id=shop_sel) }}" class="btn btn-report btn-outline-danger fw-bold">
        <i data-lucide="minus-circle"></i> กอง 3: ไม่พอส่ง
    </a>

    <div class="ms-auto">
        <a href="{{ url_for('export_excel', platform=platform_sel, shop_id=shop_sel, status=status_sel, q=q, import_from=import_from_sel, import_to=import_to_sel, date_from=date_from_sel, date_to=date_to_sel, all_time=all_time, mode=mode) }}" class="btn btn-success text-white shadow-sm fw-bold" style="border-radius: 10px;">
            <i data-lucide="file-spreadsheet"></i> Excel
        </a>
    </div>
</div>

<div class="filter-bar">
    <form class="row gy-3 gx-3 align-items-end" method="get" id="filterForm">
        {% if all_time %}<input type="hidden" name="all_time" value="1">{% endif %}
        {% if mode %}<input type="hidden" name="mode" value="{{ mode }}">{% endif %}

        <div class="col-md-2">
            <label class="form-label text-muted small fw-bold mb-1">แพลตฟอร์ม</label>
            <select class="form-select form-select-sm bg-light border-0" name="platform">
                <option value="">ทั้งหมด</option>
                {% for p in ["Shopee","TikTok","Lazada","อื่นๆ"] %}
                    <option value="{{p}}" {% if platform_sel==p %}selected{% endif %}>{{p}}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label text-muted small fw-bold mb-1">ร้านค้า</label>
            <select class="form-select form-select-sm bg-light border-0" name="shop_id">
                <option value="">ทั้งหมด</option>
                {% for s in shops %}
                    <option value="{{ s.id }}" {% if shop_sel and shop_sel|int==s.id %}selected{% endif %}>
                        {{ s.platform }} • {{ s.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-2">
            <label class="form-label text-muted small fw-bold mb-1">นำเข้า (เริ่ม)</label>
            <input type="date" class="form-control form-control-sm bg-light border-0" name="import_from" value="{{ import_from_sel or '' }}">
        </div>
        <div class="col-md-2">
            <label class="form-label text-muted small fw-bold mb-1">นำเข้า (ถึง)</label>
            <input type="date" class="form-control form-control-sm bg-light border-0" name="import_to" value="{{ import_to_sel or '' }}">
        </div>
        
        <div class="col-md-4">
            <label class="form-label text-muted small fw-bold mb-1"><i data-lucide="search" class="lucide-sm"></i> ค้นหา (Global Search)</label>
            <div class="input-group input-group-sm">
                <input type="text" class="form-control bg-light border-0" name="q" value="{{ q or '' }}" placeholder="เลข Order, SKU, สินค้า...">
                <button class="btn btn-primary px-4" type="submit" id="btn-filter"><i data-lucide="search"></i></button>
                <a href="{{ url_for('dashboard') }}" class="btn btn-light border" title="ล้างค่า"><i data-lucide="refresh-ccw" class="lucide-sm"></i></a>
            </div>
        </div>

        <input type="hidden" name="status" value="{{ status_sel if status_sel else '' }}">
        
        <div class="col-md-2 mt-2">
            <label class="form-label text-muted small fw-bold mb-1">สั่งซื้อ (เริ่ม)</label>
            <input type="date" class="form-control form-control-sm bg-light border-0" name="date_from" value="{{ date_from_sel or '' }}">
        </div>
        <div class="col-md-2 mt-2">
            <label class="form-label text-muted small fw-bold mb-1">สั่งซื้อ (ถึง)</label>
            <input type="date" class="form-control form-control-sm bg-light border-0" name="date_to" value="{{ date_to_sel or '' }}">
        </div>
        
        <div class="col-md-8 mt-2 d-flex align-items-center justify-content-end gap-2">
             {% if not all_time %}
                <a href="{{ url_for('dashboard', all_time='1') }}" class="btn btn-sm btn-outline-info rounded-pill px-3">
                    <i data-lucide="calendar" class="lucide-sm"></i> ดูยอดสะสมทั้งหมด (All Time)
                </a>
            {% else %}
                <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-info text-white rounded-pill px-3">
                    <i data-lucide="check-circle" class="lucide-sm"></i> กำลังดู All Time
                </a>
            {% endif %}
        </div>
    </form>
</div>

{% if date_from_sel or date_to_sel or import_from_sel or import_to_sel or platform_sel or shop_sel or q %}
<div class="alert alert-info d-flex align-items-center justify-content-between shadow-sm py-2 mb-3 rounded-pill px-4 border-0" style="background-color: #d1ecf1; color: #0c5460;">
    <div class="d-flex align-items-center flex-wrap gap-2">
        <i data-lucide="filter" class="me-2"></i>
        <span class="fw-bold">กำลังใช้ฟิลเตอร์:</span>
        {% if date_from_sel or date_to_sel %}
            <span class="badge bg-info text-white rounded-pill">
                <i data-lucide="calendar" class="lucide-sm"></i> สั่งซื้อ:
                {{ date_from_sel if date_from_sel else '...' }} - {{ date_to_sel if date_to_sel else '...' }}
            </span>
        {% endif %}
        {% if import_from_sel or import_to_sel %}
            <span class="badge bg-info text-white rounded-pill">
                <i data-lucide="download" class="lucide-sm"></i> นำเข้า:
                {{ import_from_sel if import_from_sel else '...' }} - {{ import_to_sel if import_to_sel else '...' }}
            </span>
        {% endif %}
        {% if platform_sel %}
            <span class="badge bg-primary text-white rounded-pill">
                <i data-lucide="shopping-bag" class="lucide-sm"></i> {{ platform_sel }}
            </span>
        {% endif %}
        {% if shop_sel %}
            <span class="badge bg-primary text-white rounded-pill">
                <i data-lucide="store" class="lucide-sm"></i> ร้าน #{{ shop_sel }}
            </span>
        {% endif %}
        {% if q %}
            <span class="badge bg-warning text-dark rounded-pill">
                <i data-lucide="search" class="lucide-sm"></i> "{{ q }}"
            </span>
        {% endif %}
    </div>
    <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary rounded-pill px-3" title="ล้างฟิลเตอร์ทั้งหมด">
        <i data-lucide="x-circle" class="lucide-sm"></i> ล้างทั้งหมด
    </a>
</div>
{% endif %}

<div id="bulk-bar" class="alert alert-primary d-none d-flex justify-content-between align-items-center shadow-sm py-2 mb-3 rounded-pill px-4 border-0" style="background-color: #e7f1ff; color: #0d6efd;">
    <div class="d-flex align-items-center">
        <i data-lucide="check-square" class="me-2 fs-5"></i>
        <span class="fw-bold">เลือก <span id="selected-count" class="badge bg-primary text-white fs-6 mx-1 rounded-pill">0</span> รายการ</span>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-sm btn-primary fw-bold rounded-pill px-3" id="btn-bulk-accept-confirm"><i data-lucide="check" class="lucide-sm"></i> กดรับงาน</button>
        <button class="btn btn-sm btn-warning text-dark fw-bold rounded-pill px-3" id="btn-bulk-cancel"><i data-lucide="refresh-ccw" class="lucide-sm"></i> ยกเลิกรับ</button>
        <div class="vr bg-secondary opacity-25 mx-1"></div>
        <button class="btn btn-sm btn-danger fw-bold rounded-pill px-3" onclick="confirmBulkDeleteOrders()"><i data-lucide="trash-2" class="lucide-sm"></i> ลบ</button>
        <button class="btn btn-sm btn-light text-muted rounded-circle" id="btn-bulk-clear"><i data-lucide="x" class="lucide-sm"></i></button>
    </div>
</div>
<form id="bulk-delete-form" method="post" action="{{ url_for('bulk_delete_orders') }}"></form>

<div class="table-container" id="ordersTableSection">
    <table id="ordersTable" class="table table-hover align-middle mb-0" style="width:100%">
        <thead>
            <tr>
                <th class="text-center" width="30"><input type="checkbox" id="check-all" class="form-check-input" style="cursor:pointer;"></th>
                <th>Platform</th>
                <th>ร้าน</th>
                <th>เลข Order</th>
                <th>สินค้า (SKU)</th>
                <th>Brand</th>
                <th>Stock</th>
                <th>Qty</th>
                <th>AllQty</th>
                <th>เวลาสั่ง</th>
                <th>SLA</th>
                <th>ขนส่ง</th>
                <th>สถานะ</th>
                <th>การกระทำ</th>
                <th class="text-center">Scan Order</th>
                <th>ผู้รับ</th>
                <th>หมายเหตุ</th>
            </tr>
        </thead>
        <tbody>
            {% for r in rows %}
            {% set overdue = (r.sla and r.sla.startswith('เลยกำหนด')) and (r.allocation_status != 'PACKED') %}
            {% set can_accept = (r.allocation_status == 'READY_ACCEPT') %}
            {% set is_order_ready = (r.order_id in ready_oids) %}
            <tr class="{% if r.is_cancelled %}cancelled-row{% elif overdue %}table-danger{% endif %}" data-order-id="{{ r.order_id }}">
                <td class="text-center">
                    <input type="checkbox" class="form-check-input js-row-check" 
                           data-id="{{ r.id }}" 
                           value="{{ r.id }}"
                           data-can-accept="{{ 'true' if can_accept else 'false' }}"
                           data-order-ready="{{ 'true' if is_order_ready else 'false' }}">
                </td>
                <td><span class="badge bg-light text-dark border">{{ r.platform }}</span></td>
                <td class="small text-muted">{{ r.shop }}</td>
                <td class="order-cell fw-bold text-primary text-nowrap">{{ r.order_id }}</td>
                <td>
                    <div class="fw-bold text-dark">{{ r.sku }}</div>
                    <div class="small text-muted text-truncate" style="max-width: 200px;">{{ r.model }}</div>
                </td>
                <td class="small">{{ r.brand }}</td>
                <td class="text-center">
                    {# Map Stock badge color to Card meaning:
                       - LOW_STOCK  -> Yellow (กอง 2)
                       - NOT_ENOUGH -> Orange (ไม่พอส่ง)
                       - SHORTAGE   -> Red (ไม่มีของ/หมด)
                       Fallback to qty comparison if status missing.
                    #}
                    {% if r.allocation_status == 'SHORTAGE' or r.stock_qty <= 0 %}
                        <span class="badge bg-danger rounded-pill px-2">{{ r.stock_qty }}</span>
                    {% elif r.allocation_status == 'NOT_ENOUGH' or r.stock_qty < r.qty %}
                        <span class="badge badge-orange rounded-pill px-2">{{ r.stock_qty }}</span>
                    {% elif r.allocation_status == 'LOW_STOCK' %}
                        <span class="badge bg-warning text-dark rounded-pill px-2">{{ r.stock_qty }}</span>
                    {% else %}
                        <span class="badge bg-success rounded-pill px-2">{{ r.stock_qty }}</span>
                    {% endif %}
                </td>
                <td class="text-center"><span class="badge bg-light text-dark border px-2 rounded-pill">{{ r.qty }}</span></td>
                <td class="text-center small text-muted">{{ r.allqty }}</td>
                <td class="small text-muted text-nowrap">{{ r.order_time|thai_be }}</td>
                <td class="small text-nowrap">{{ r.sla }}</td>
                <td class="small text-truncate" style="max-width: 100px;">{{ r.logistic or '-' }}</td>
                <td>
                    {% if r.status_change %}
                        <div class="mb-1">
                            <span class="badge {{ r.status_change.cls }} me-1" style="font-size:0.72rem;">
                                <i class="bi {{ r.status_change.icon }} me-1"></i>{{ r.status_change.label }}
                            </span>
                        </div>
                    {% endif %}

                    {% if r.card_tags and r.card_tags|length > 0 %}
                        <div class="mb-1">
                            {% for t in r.card_tags %}
                                <span class="badge {{ t.cls }} me-1" style="font-size:0.72rem;">{{ t.label }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {# ตรวจสอบว่ามี card_tags ที่ตรงกับ allocation_status หรือไม่ #}
                    {% set card_codes = r.card_tags|map(attribute='code')|list if r.card_tags else [] %}
                    {% set show_alloc_badge = true %}

                    {# ถ้ามี card_tags ที่ตรงกับ allocation_status แล้ว ไม่ต้องแสดง badge ซ้ำ #}
                    {% if r.allocation_status in card_codes %}
                        {% set show_alloc_badge = false %}
                    {% endif %}

                    {# แสดง allocation_status badge เฉพาะเมื่อไม่ซ้ำกับ card_tags #}
                    {% if show_alloc_badge %}
                        {% if r.is_issued %}
                            <span class="badge bg-info text-dark">จ่ายแล้ว</span>
                        {% elif r.allocation_status == "READY_ACCEPT" %}
                            <span class="badge bg-success">พร้อมรับ</span>
                        {% elif r.allocation_status == "ACCEPTED" %}
                            <span class="badge bg-secondary">รับแล้ว</span>
                        {% elif r.allocation_status == "LOW_STOCK" %}
                            <span class="badge bg-warning text-dark">สินค้าน้อย</span>
                        {% elif r.allocation_status == "SHORTAGE" %}
                            <span class="badge bg-danger">สินค้าหมด</span>
                        {% elif r.allocation_status == "NOT_ENOUGH" %}
                            <span class="badge badge-orange">ไม่พอส่ง</span>
                        {% elif r.allocation_status == "BILL_EMPTY" %}
                            <span class="badge" style="background-color: #6f42c1; color: white;">บิลเปล่า</span>
                        {% elif r.allocation_status == "PACKED" %}
                            <span class="badge bg-dark">แพ็คแล้ว</span>
                        {% elif r.allocation_status %}
                            <span class="badge bg-light text-dark">{{ r.allocation_status }}</span>
                        {% endif %}
                    {% endif %}
                </td>
                <td class="text-nowrap">
                    {% if not r.is_cancelled %}
                        {% if r.is_issued %}
                            <button class="btn btn-sm btn-secondary disabled opacity-50" style="font-size:0.7rem;">จ่ายแล้ว</button>
                        {% elif r.accepted %}
                            <form method="post" action="{{ url_for('cancel_accept', order_line_id=r.id) }}" class="d-inline">
                                <button class="btn btn-sm btn-warning text-dark py-0 px-2" title="ถอยกลับ" style="font-size:0.75rem; border-radius:6px;"><i data-lucide="refresh-ccw" class="lucide-sm"></i> ถอย</button>
                            </form>
                        {# [แก้ไข] เช็คเพิ่มว่า Order ID นี้ต้องอยู่ในรายการที่ "พร้อมทั้งใบ" (ready_oids) เท่านั้น + รองรับ BILL_EMPTY #}
                        {% elif (r.allocation_status == "READY_ACCEPT" or r.allocation_status == "BILL_EMPTY") and r.order_id in ready_oids %}
                            <form method="post" action="{{ url_for('dashboard_accept_order') }}" class="d-inline">
                                <input type="hidden" name="order_id" value="{{ r.order_id }}">
                                <input type="hidden" name="sku" value="{{ r.sku }}">
                                <input type="hidden" name="platform" value="{{ platform_sel or '' }}">
                                <input type="hidden" name="shop_id" value="{{ shop_sel or '' }}">
                                <button class="btn btn-sm btn-success py-0 px-2 fw-bold" title="กดรับงาน" style="font-size:0.75rem; border-radius:6px;"><i data-lucide="check" class="lucide-sm"></i> รับ</button>
                            </form>
                        {# [เพิ่ม] ถ้าสถานะ Ready/BILL_EMPTY แต่ของตัวอื่นในออเดอร์ไม่พร้อม ให้โชว์ปุ่มเทา (กดไม่ได้) #}
                        {% elif (r.allocation_status == "READY_ACCEPT" or r.allocation_status == "BILL_EMPTY") %}
                             <button class="btn btn-sm btn-light text-muted border py-0 px-2" disabled style="font-size:0.75rem; border-radius:6px;" title="รอสินค้าอื่นในออเดอร์ให้ครบ"><i data-lucide="hourglass" class="lucide-sm"></i> รอครบ</button>
                        {% else %}
                             <button class="btn btn-sm btn-light text-muted border py-0 px-2" disabled style="font-size:0.75rem; border-radius:6px;"><i data-lucide="x" class="lucide-sm"></i> รับ</button>
                        {% endif %}
                        
                        {% if r.allocation_status != 'PACKED' %}
                            <button class="btn btn-sm btn-outline-danger py-0 px-2 ms-1" onclick="openCancelModal('{{ r.order_id }}')" title="ยกเลิก" style="font-size:0.75rem; border-radius:6px;"><i data-lucide="trash-2" class="lucide-sm"></i></button>
                        {% endif %}
                    {% else %}
                        <span class="text-muted small">-</span>
                    {% endif %}
                </td>

                <td class="text-center">
                    <input type="checkbox" class="form-check-input scan-check" disabled {% if r.scanned_at %}checked{% endif %}>
                </td>

                <td class="small text-muted">{{ r.accepted_by or '-' }}</td>
                <td class="small text-muted">
                    {% if r.is_cancelled %}
                        <span class="text-danger small"><i data-lucide="info" class="lucide-sm"></i> {{ r.cancel_reason }}</span>
                    {% else %}
                        {{ r.note or '-' }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot style="background-color: #f8f9fa; font-weight: bold; border-top: 3px solid #0d6efd;">
            <tr>
                <td colspan="5" class="text-end px-3 py-2">
                    <span class="text-primary">สรุปยอดรวม:</span>
                </td>
                <td class="text-center py-2">
                    <span class="badge bg-light text-dark border px-2" id="summary-brand-count">-</span>
                </td>
                <td class="text-center py-2">
                    <span class="badge bg-info text-white px-2" id="summary-total-stock">-</span>
                </td>
                <td class="text-center py-2">
                    <span class="badge bg-primary text-white px-2" id="summary-total-qty">-</span>
                </td>
                <td class="text-center py-2">
                    <span class="badge bg-secondary text-white px-2" id="summary-total-allqty">-</span>
                </td>
                <td colspan="8" class="px-3 py-2">
                    <span class="text-muted small">
                        <i data-lucide="package" class="lucide-sm me-1"></i>
                        จำนวน Order: <span class="fw-bold text-dark" id="summary-order-count">-</span>
                        <span class="mx-2">|</span>
                        <i data-lucide="list" class="lucide-sm me-1"></i>
                        จำนวนรายการ: <span class="fw-bold text-dark" id="summary-row-count">-</span>
                    </span>
                </td>
            </tr>
        </tfoot>
    </table>
</div>

<div class="modal fade" id="cancelOrderModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 15px;">
      <div class="modal-header bg-danger text-white" style="border-radius: 15px 15px 0 0;">
        <h5 class="modal-title"><i data-lucide="alert-triangle" class="me-2"></i> ยืนยันการยกเลิก Order</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{{ url_for('cancel_order_permanent') }}" id="cancelOrderForm">
        <div class="modal-body p-4">
          <div class="alert alert-warning border-0 bg-light d-flex align-items-center">
             <i data-lucide="info" class="text-warning fs-4 me-3"></i>
             <div>คุณกำลังจะยกเลิก Order: <strong id="modalOrderIdDisplay" class="text-primary fs-5"></strong></div>
          </div>
          <input type="hidden" name="order_id" id="inputOrderIdForCancel">
          {% for key, val in request.args.items() %}<input type="hidden" name="{{ key }}" value="{{ val }}">{% endfor %}
          <div class="mb-3">
            <label class="form-label fw-bold text-danger">ระบุสาเหตุการยกเลิก *</label>
            <textarea name="reason" id="cancelReasonInput" class="form-control bg-light" rows="3" required placeholder="เช่น ลูกค้ายกเลิก, สินค้าหมดถาวร" style="border-radius: 10px;"></textarea>
          </div>
        </div>
        <div class="modal-footer bg-light border-0" style="border-radius: 0 0 15px 15px;">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">ปิด</button>
          <button type="submit" class="btn btn-danger fw-bold px-4">ยืนยันยกเลิก</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="loadingOverlay" class="d-none position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background: rgba(255,255,255,0.7); z-index: 9999; backdrop-filter: blur(4px);">
    <div class="text-center shadow-lg p-4 rounded-4 bg-white">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <h6 class="m-0 text-secondary fw-bold">กำลังโหลดข้อมูล...</h6>
    </div>
</div>

<div class="scroll-nav-container" style="position:fixed;bottom:30px;right:30px;z-index:9999;display:flex;flex-direction:column;gap:10px;">
  <button type="button" class="btn btn-secondary rounded-circle shadow border-0" id="btn-scroll-to-bottom" style="width:45px;height:45px;display:none; transition:transform 0.2s;"><i data-lucide="arrow-down" class="fs-5"></i></button>
  <button type="button" class="btn btn-primary rounded-circle shadow border-0" id="btn-back-to-top" style="width:45px;height:45px;display:none; background: linear-gradient(135deg, #0d6efd, #0a58ca); transition:transform 0.2s;"><i data-lucide="arrow-up" class="fs-5"></i></button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Init DataTable
    if (typeof $ !== 'undefined' && $.fn.dataTable) {
        var table = $('#ordersTable').DataTable({
            "paging": true, "pageLength": 50, "lengthMenu": [[50, 100, 200, -1], [50, 100, 200, "ทั้งหมด"]],
            "searching": false, "info": true, "ordering": true, "order": [[3, 'asc']],
            "columnDefs": [{ "orderable": false, "targets": 0 }],
            "drawCallback": function (settings) {
                var api = this.api(); var rows = api.rows({page:'current'}).nodes(); var last = null;
                $(rows).removeClass('order-group-start order-group-end');
                api.column(3, {page:'current'}).data().each(function (group, i) {
                    var orderId = typeof group === 'string' ? group.replace(/<[^>]*>/g, '').trim() : group;
                    if (last !== orderId) { $(rows).eq(i).addClass('order-group-start'); if (i > 0) $(rows).eq(i-1).addClass('order-group-end'); last = orderId; }
                });
                if (rows.length > 0) $(rows).last().addClass('order-group-end');

                // คำนวณยอดรวม (สำหรับหน้าปัจจุบัน)
                updateSummaryRow(api);
            }
        });

        // ฟังก์ชันคำนวณและอัพเดทแถวสรุปยอดรวม
        function updateSummaryRow(api) {
            var currentRows = api.rows({page:'current', search:'applied'}).data();
            var allRows = api.rows({search:'applied'}).data();

            var uniqueOrders = new Set();
            var uniqueBrands = new Set();
            var totalStock = 0;
            var totalQty = 0;
            var totalAllQty = 0;
            var rowCount = 0;

            // วนลูปข้อมูลทั้งหมด (รวมทุกหน้า)
            allRows.each(function(row, index) {
                var $row = $(api.row(index).node());

                // ดึงข้อมูลจาก DOM
                var orderId = $row.find('td.order-cell').text().trim();
                var brand = $row.find('td').eq(5).text().trim();
                var stockText = $row.find('td').eq(6).find('.badge').text().trim();
                var qtyText = $row.find('td').eq(7).find('.badge').text().trim();
                var allQtyText = $row.find('td').eq(8).text().trim();

                if (orderId) uniqueOrders.add(orderId);
                if (brand && brand !== '-') uniqueBrands.add(brand);

                var stock = parseInt(stockText) || 0;
                var qty = parseInt(qtyText) || 0;
                var allQty = parseInt(allQtyText) || 0;

                totalStock += stock;
                totalQty += qty;
                totalAllQty += allQty;
                rowCount++;
            });

            // อัพเดทค่าใน summary row
            $('#summary-brand-count').text(uniqueBrands.size);
            $('#summary-total-stock').text(totalStock.toLocaleString());
            $('#summary-total-qty').text(totalQty.toLocaleString());
            $('#summary-total-allqty').text(totalAllQty.toLocaleString());
            $('#summary-order-count').text(uniqueOrders.size);
            $('#summary-row-count').text(rowCount);
        }
    }

    // =========================
    // Loading & Filters (FIX + AUTO SCROLL)
    // =========================
    function showLoading() {
        const el = document.getElementById('loadingOverlay');
        if (el) el.classList.remove('d-none');
    }

    const filterForm = document.getElementById('filterForm');

    // ✅ ทุกครั้งที่ "submit ฟอร์มกรอง" (กดค้นหา/กด Enter/กด KPI แล้ว requestSubmit)
    // ให้โชว์ loading + ตั้งธงเพื่อเลื่อนลงตารางหลัง reload
    if (filterForm) {
        filterForm.addEventListener('submit', function() {
            sessionStorage.setItem('scrollToOrders', '1');   // ⭐ เพิ่มเพื่อให้ปุ่มค้นหาก็เลื่อนลงด้วย
            showLoading();
        });
    }

    // ✅ กด KPI -> เซ็ตค่า status ลง input hidden แล้ว submit
    document.querySelectorAll('.kpi-filter').forEach(card => {
        card.addEventListener('click', function() {
            if (!filterForm) return;

            const statusVal = this.getAttribute('data-status') || '';

            // สำคัญ: ของจริงเป็น input hidden ไม่ใช่ select
            let statusInput = filterForm.querySelector('input[name="status"]');
            if (!statusInput) {
                statusInput = document.createElement('input');
                statusInput.type = 'hidden';
                statusInput.name = 'status';
                filterForm.appendChild(statusInput);
            }
            statusInput.value = statusVal;

            // ตั้งธงไว้ด้วย (กันกรณี fallback submit ที่ไม่ยิง event submit)
            sessionStorage.setItem('scrollToOrders', '1');

            // ใช้ requestSubmit เพื่อให้ submit event ทำงาน (จะได้โชว์ loading แน่นอน)
            if (filterForm.requestSubmit) filterForm.requestSubmit();
            else { showLoading(); filterForm.submit(); }
        });
    });

    // ✅ หลังหน้า reload: ถ้ามีธง ให้เลื่อนลงตารางอัตโนมัติ
    if (sessionStorage.getItem('scrollToOrders') === '1') {
        sessionStorage.removeItem('scrollToOrders');

        setTimeout(() => {
            const target = document.getElementById('ordersTableSection') || document.getElementById('ordersTable');
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // ถ้ามี header fixed แล้วบังหัวตาราง ปรับ offset ได้
                window.scrollBy(0, -80);
            }
        }, 100);
    }

    // Bulk Actions
    const checkAll = document.getElementById('check-all');
    const bulkBar = document.getElementById('bulk-bar');
    const countSpan = document.getElementById('selected-count');
    
    function updateBulk() {
        const c = document.querySelectorAll('.js-row-check:checked').length;
        if(countSpan) countSpan.innerText = c;
        if(bulkBar) {
            if(c>0) bulkBar.classList.remove('d-none'); else bulkBar.classList.add('d-none');
        }
    }
    
    if(checkAll) checkAll.addEventListener('change', function(){
        document.querySelectorAll('.js-row-check').forEach(chk => chk.checked = this.checked);
        updateBulk();
    });
    
    document.querySelector('tbody').addEventListener('change', function(e){
        if(e.target.classList.contains('js-row-check')) {
            updateBulk();
            if(!e.target.checked && checkAll) checkAll.checked = false;
        }
    });
    
    document.getElementById('btn-bulk-clear').addEventListener('click', function(){
        document.querySelectorAll('.js-row-check').forEach(chk => chk.checked = false);
        if(checkAll) checkAll.checked = false;
        updateBulk();
    });

    // Bulk Accept Logic
    const btnAccept = document.getElementById('btn-bulk-accept-confirm');
    if(btnAccept) {
        const newBtn = btnAccept.cloneNode(true);
        btnAccept.parentNode.replaceChild(newBtn, btnAccept);
        newBtn.addEventListener('click', function(){
            const checked = document.querySelectorAll('.js-row-check:checked');
            let validIds = [];
            checked.forEach(chk => { if(chk.getAttribute('data-order-ready') === 'true') validIds.push(chk.value); });
            
            if(validIds.length === 0) { alert('ไม่มีรายการที่พร้อมรับ (ต้องเขียวทั้งใบ)'); return; }
            if(confirm(`ยืนยันรับ ${validIds.length} รายการที่พร้อม?`)) {
                const f = document.createElement('form'); f.method='POST'; f.action="{{ url_for('bulk_accept') }}";
                validIds.forEach(v => { const i=document.createElement('input'); i.type='hidden'; i.name='order_line_ids[]'; i.value=v; f.appendChild(i); });
                document.body.appendChild(f); showLoading(); f.submit();
            }
        });
    }
    
    // Bulk Cancel Logic
    const btnCancel = document.getElementById('btn-bulk-cancel');
    if(btnCancel) {
        const newBtn = btnCancel.cloneNode(true);
        btnCancel.parentNode.replaceChild(newBtn, btnCancel);
        newBtn.addEventListener('click', function(){
            const checked = document.querySelectorAll('.js-row-check:checked');
            if(checked.length===0) return;
            if(confirm(`ยืนยันยกเลิกรับ ${checked.length} รายการ?`)) {
                const f = document.createElement('form'); f.method='POST'; f.action="{{ url_for('bulk_cancel') }}";
                checked.forEach(c => { const i=document.createElement('input'); i.type='hidden'; i.name='order_line_ids[]'; i.value=c.value; f.appendChild(i); });
                document.body.appendChild(f); showLoading(); f.submit();
            }
        });
    }

    // Scroll Buttons
    const btnUp = document.getElementById("btn-back-to-top");
    const btnDown = document.getElementById("btn-scroll-to-bottom");
    
    window.addEventListener("scroll", function() {
        const y = window.scrollY;
        if (y > 300) btnUp.style.display = "block"; else btnUp.style.display = "none";
        if (y + window.innerHeight < document.body.scrollHeight - 300) btnDown.style.display = "block"; else btnDown.style.display = "none";
    });
    
    btnUp.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
    btnDown.addEventListener("click", () => window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" }));
});

// Global functions
function openCancelModal(oid) {
    document.getElementById('modalOrderIdDisplay').innerText = oid;
    document.getElementById('inputOrderIdForCancel').value = oid;
    new bootstrap.Modal(document.getElementById('cancelOrderModal')).show();
}

function confirmBulkDeleteOrders() {
    const checked = document.querySelectorAll('.js-row-check:checked');
    if (checked.length === 0) { alert('กรุณาเลือกรายการ'); return; }
    if (confirm(`ยืนยันลบ ${checked.length} รายการ? (กู้คืนได้)`)) {
        const f = document.getElementById('bulk-delete-form'); f.innerHTML='';
        checked.forEach(c => { const i=document.createElement('input'); i.type='hidden'; i.name='order_line_ids[]'; i.value=c.value; f.appendChild(i); });
        f.submit();
    }
}
</script>

{% endblock %}