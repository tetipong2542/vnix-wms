
{% extends "base.html" %}
{% block content %}

<div class="row g-3 align-items-end mb-3">
  <div class="col-auto">
    <div class="page-title d-flex align-items-center">
      <div class="page-title-icon me-3">
        <i data-lucide="clipboard-list"></i>
      </div>
      <div class="d-flex align-items-baseline flex-wrap">
        <div class="page-title-main me-3">ใบงานหยิบสินค้า (Picking)</div>
        <div class="text-muted" style="font-size: 1rem; border-left: 2px solid #ccc; padding-left: 12px;">
          ระบบจัดการการหยิบสินค้าและจัดพัสดุ
        </div>
      </div>
    </div>
  </div>
</div>
<hr class="mb-4">

<style>
  /* ซ่อน footer เฉพาะหน้านี้ + ปรับคุณภาพพิมพ์ */
  footer { display: none !important; }
  @media print {
    footer { display: none !important; }
    .d-print-none { display: none !important; }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    table.table { border-color: #333 !important; }
    table.table th, table.table td { border-color: #333 !important; padding: 4px 6px !important; font-size: 12px; }
    .table .need-col{
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      background: #dbe8ff !important;
    }
  }
  /* เน้นคอลัมน์ "ต้องหยิบ" */
  .table .need-col{
    background: #e6f0ff;
    font-weight: 700;
    border-left: 2px solid #99b8ff;
    border-right: 2px solid #99b8ff;
  }
  
  /* Sortable column headers */
  th.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 20px !important;
  }
  th.sortable:hover {
    background-color: #e9ecef;
  }
  th.sortable::after {
    content: '⇅';
    position: absolute;
    right: 5px;
    opacity: 0.3;
  }
  th.sortable.asc::after {
    content: '▲';
    opacity: 1;
  }
  th.sortable.desc::after {
    content: '▼';
    opacity: 1;
  }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">
    Picking List
    {% if is_history_view %}<span class="badge bg-info ms-2">งานที่พิมพ์แล้ว</span>{% endif %}
  </h3>
  <div class="d-print-none d-flex gap-2">
    {% if not official_print %}
      <button id="printSelectedBtn" type="button" class="btn btn-danger" onclick="printSelected()"><i data-lucide="lock"></i> พิมพ์และล็อกงานที่เลือก</button>
      <button id="printAllBtn" type="button" class="btn btn-warning" onclick="printAllPicking()"><i data-lucide="lock"></i> พิมพ์และล็อกงานทั้งหมด</button>
      <button id="updateDispatchBtn" type="button" class="btn btn-primary" onclick="showDispatchModal()"><i data-lucide="edit"></i> จ่ายงาน(รอบที่)</button>
    {% endif %}
    {% if is_history_view %}
      <a class="btn btn-outline-secondary"
         href="{{ url_for('picking_printed_history', reset='today') }}">
        รีเฟรช
      </a>
    {% else %}
      <a class="btn btn-outline-secondary"
         href="{{ url_for('picking_list', reset='all') }}">
        รีเฟรช/Orderค้าง
      </a>
    {% endif %}
    
    {% if is_history_view %}
      <a class="btn btn-success"
         href="{{ url_for('export_picking_history_excel', **request.args) }}">
        Export Excel
      </a>
    {% else %}
      <a class="btn btn-success"
         href="{{ url_for('export_picking_excel', **request.args) }}">
        Export Excel
      </a>
    {% endif %}
    
    {% if not official_print %}
      <button class="btn btn-outline-primary" onclick="window.print()">พิมพ์ (Preview)</button>
    {% endif %}
  </div>
</div>

{% if is_history_view %}
  <div class="alert alert-primary d-print-none">
    <strong><i data-lucide="clipboard-check"></i> โหมดดูงานที่พิมพ์แล้ว</strong> — แสดงเฉพาะออเดอร์ที่ถูกพิมพ์แล้ว (สามารถพิมพ์ซ้ำได้)
  </div>
{% elif official_print and printed_meta %}
  <div class="alert alert-success d-print-none">
    <strong>Official print</strong>
    • ผู้ออก: {{ printed_meta.by }}
    • เวลา: {{ printed_meta.at|thai_be }}
    • รวมออเดอร์: {{ printed_meta.orders }}
    {% if printed_meta.override %}<span class="badge text-bg-warning ms-2">Reprint (Admin)</span>{% endif %}
  </div>
{% else %}
  <div class="alert alert-info d-print-none">
    นี่คือโหมด <strong>Preview</strong> — จะไม่ล็อกงานจนกว่าจะกด "พิมพ์และล็อกงาน"
    {% if warehouse_print_info %}
    <br>
    <strong><i data-lucide="link"></i> เชื่อมโยงกับใบงานคลัง:</strong> 
    พิมพ์เมื่อ {{ warehouse_print_info.printed_at|thai_be }} 
    โดย {{ warehouse_print_info.printed_by }}
    (ครั้งที่ {{ warehouse_print_info.print_count }})
    {% endif %}
  </div>
{% endif %}

<form class="row gy-2 gx-2 align-items-end mb-3 d-print-none" method="get" action="{{ url_for('picking_list') if not is_history_view else url_for('picking_printed_history') }}">
  {% if is_history_view and available_dates %}
  <div class="col-md-2">
    <label class="form-label small fw-bold">วันที่พิมพ์</label>
    <select name="print_date" class="form-select form-select-sm">
      <option value="">ทั้งหมด</option>
      {% for d in available_dates %}
        <option value="{{d}}" {% if print_date_sel==d|string %}selected{% endif %}>{{ d }}</option>
      {% endfor %}
    </select>
  </div>
  {% endif %}
  <div class="col-md-2">
    <label class="form-label small fw-bold">แพลตฟอร์ม</label>
    <select class="form-select form-select-sm" name="platform">
      <option value="">ทั้งหมด</option>
      {% for p in ["Shopee","TikTok","Lazada","อื่นๆ"] %}
        <option value="{{p}}" {% if platform_sel==p %}selected{% endif %}>{{p}}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label small fw-bold">ชื่อร้าน</label>
    <select class="form-select form-select-sm" name="shop_id">
      <option value="">ทั้งหมด</option>
      {% for s in shops %}
        <option value="{{ s.id }}" {% if shop_sel and shop_sel|int==s.id %}selected{% endif %}>
          {{ s.platform }} • {{ s.name }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label small fw-bold">ประเภทขนส่ง</label>
    <select class="form-select form-select-sm" name="logistic">
      <option value="">ทั้งหมด</option>
      {% for lg in logistics %}
        <option value="{{ lg }}" {% if logistic_sel==lg %}selected{% endif %}>{{ lg }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-1">
    <label class="form-label small fw-bold">รอบที่</label>
    {% if is_history_view and available_rounds %}
    <select class="form-select form-select-sm" name="round">
      <option value="">ทั้งหมด</option>
      {% for r in available_rounds %}
        <option value="{{ r }}" {% if round_sel|string == r|string %}selected{% endif %}>{{ r }}</option>
      {% endfor %}
    </select>
    {% else %}
    <input type="number" class="form-control form-control-sm" name="round" value="{{ round_sel or '' }}" placeholder="ทุกรอบ" min="1">
    {% endif %}
  </div>
  <div class="col-md-1">
    <label class="form-label small fw-bold">พิมพ์(ครั้ง)</label>
    <input type="number" class="form-control form-control-sm" name="print_count" value="{{ print_count_sel or '' }}" placeholder="ทุกค่า" min="0">
  </div>

  <div class="w-100"></div>

  <div class="col-md-2">
    <label class="form-label small fw-bold">ใบงานคลัง(จาก)</label>
    <input type="date" name="accepted_from" class="form-control form-control-sm" value="{{ accepted_from or '' }}">
  </div>
  <div class="col-md-2">
    <label class="form-label small fw-bold">ถึงวันที่</label>
    <div class="input-group input-group-sm">
      <input type="date" name="accepted_to" class="form-control form-control-sm" value="{{ accepted_to or '' }}">
      <button type="button" class="btn btn-outline-secondary" onclick="setTodayPicking()">วันนี้</button>
    </div>
  </div>
  <div class="col-md-auto d-grid">
    <button type="submit" class="btn btn-primary btn-sm fw-bold"><i data-lucide="search"></i> กรอง</button>
  </div>
</form>

<div class="mb-2 d-flex justify-content-between align-items-center">
  <div>
    <span class="badge text-bg-primary">Distinct SKUs: {{ totals.total_skus }}</span>
    <span class="badge text-bg-secondary">ต้องหยิบรวม: {{ totals.total_need_qty }}</span>
    <span class="badge text-bg-danger">ขาดรวม: {{ totals.total_shortage }}</span>
    <span class="badge text-bg-info" id="selectedCount">Selected: 0</span>
  </div>
  <div class="d-print-none">
    <button class="btn btn-sm btn-outline-secondary" onclick="clearAllFilters()">
      <i data-lucide="x-circle"></i> ล้างตัวกรองทั้งหมด
    </button>
  </div>
</div>

{# เตรียมชื่อร้านจาก shop_sel ถ้าเลือก #}
{% set shop_sel_name = '-' %}
{% if shop_sel %}
  {% for s in shops %}
    {% if s.id == shop_sel|int %}
      {% set shop_sel_name = s.platform ~ ' • ' ~ s.name %}
    {% endif %}
  {% endfor %}
{% endif %}

<div class="table-responsive">
  <table class="table table-sm table-bordered align-middle" id="pickingTable">
    <thead class="table-light">
      <tr>
        <th class="d-print-none" style="width: 40px;">
          <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
        </th>
        <th class="sortable" data-column="platform">แพลตฟอร์ม</th>
        <th class="sortable" data-column="shop">ร้าน</th>
        <th class="sortable" data-column="sku" style="width: 140px;">SKU</th>
        <th class="sortable" data-column="brand">Brand</th>
        <th class="sortable" data-column="model">สินค้า</th>
        <th class="text-end" style="width: 120px;">ต้องหยิบ</th>
        <th class="text-end" style="width: 120px;">สต็อก</th>
        <th class="text-end" style="width: 120px;">ขาด</th>
        <th class="text-end" style="width: 140px;">คงเหลือหลังหยิบ</th>
        <th class="sortable" data-column="logistic">ประเภทขนส่ง</th>
        <th class="sortable text-center" data-column="dispatch_round" style="width: 120px;">จ่ายงาน(รอบที่)</th>
        <th class="sortable text-center" data-column="printed_count" style="width: 130px;">พิมพ์แล้ว (ครั้ง)</th>
        <th class="sortable text-center" data-column="printed_at" style="width: 180px;">วัน/เดือน/ปี/เวลา ที่พิมพ์</th>
      </tr>
    </thead>
    <tbody>
      {% for it in items %}
        <tr class="{% if it.shortage>0 %}table-warning{% endif %}" data-sku="{{ it.sku }}" data-platform="{{ platform_sel or '-' }}" data-shop="{{ shop_sel_name or '-' }}" data-brand="{{ it.brand }}" data-model="{{ it.model }}" data-logistic="{{ logistic_sel or '-' }}" data-dispatch-round="{% if it.dispatch_round is not none %}{{ it.dispatch_round }}{% endif %}" data-printed-count="{{ it.print_count|default(0, true) }}" data-printed-at="{% if it.printed_at %}{{ it.printed_at.isoformat() }}{% endif %}">
          
          <td class="d-print-none">
            <input type="checkbox" class="sku-checkbox" value="{{ it.sku }}" onchange="updateSelectedCount()">
          </td>

          <td>{{ platform_sel or '-' }}</td>
          <td>{{ shop_sel_name or '-' }}</td>

          <td><strong>{{ it.sku }}</strong></td>
          <td>{{ it.brand }}</td>
          <td>{{ it.model }}</td>
          <td class="text-end need-col">{{ it.need_qty }}</td>
          <td class="text-end">{{ it.stock_qty }}</td>
          <td class="text-end">{{ it.shortage }}</td>
          <td class="text-end">{{ it.remain_after_pick }}</td>

          <td>{{ logistic_sel or '-' }}</td>

          <td class="text-center">
            {% if round_sel %}
              {# ถ้าเลือกรอบแล้ว แสดง badge สีเขียว (ข้อมูลที่แสดงคือรอบที่กรองแล้ว) #}
              <span class="badge bg-primary rounded-pill">{{ round_sel }}</span>
            {% elif it.dispatch_round is not none %}
              <span class="badge bg-secondary rounded-pill">{{ it.dispatch_round }}</span>
            {% else %}
              -
            {% endif %}
          </td>

          <td class="text-center">
            {% if it.print_count > 0 %}
              <span class="badge bg-success">{{ it.print_count }}</span>
            {% else %}
              <span class="text-muted">0</span>
            {% endif %}
          </td>

          <td class="text-center">
            {% if it.printed_at %}
              {{ it.printed_at|thai_be }}
              {% if it.printed_by %}
                <br><small class="text-muted">(โดย: {{ it.printed_by }})</small>
              {% endif %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      {% if not items %}
        <tr><td colspan="14" class="text-center text-muted">ไม่พบรายการที่ต้องหยิบ</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

{% if official_print %}
<script>
  // พิมพ์อัตโนมัติเมื่อเป็น Official print
  window.addEventListener('load', function(){ window.print(); });
</script>
{% endif %}

{# Modal สำหรับระบุเลขรอบจ่ายงาน #}
<div class="modal fade" id="dispatchModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i data-lucide="truck"></i> จ่ายงาน / ระบุรอบ</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="dispatchForm" action="{{ url_for('picking_update_dispatch') }}" method="POST">
          <div class="mb-3 text-center">
            <label class="form-label fw-bold text-muted">ระบุเลขรอบ (Round)</label>
            <input type="number" class="form-control form-control-lg text-center fw-bold text-primary" 
                   name="dispatch_round" id="dispatchRoundInput" value="1" min="1" required style="font-size: 2rem;">
            <div class="form-text">ใส่เลข 1, 2, 3... เพื่อแยกชุดงาน</div>
          </div>
          
          <div id="dispatchHiddenInputs"></div>
          
          {# Hidden fields for current filters #}
          <input type="hidden" name="platform" value="{{ platform_sel or '' }}">
          <input type="hidden" name="shop_id" value="{{ shop_sel or '' }}">
          <input type="hidden" name="logistic" value="{{ logistic_sel or '' }}">

          <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg"><i data-lucide="check-circle-2"></i> ยืนยันจ่ายงาน</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Store original rows for filtering
let allRows = [];
let sortState = { column: null, direction: 'none' };

document.addEventListener('DOMContentLoaded', function() {
  const tbody = document.querySelector('#pickingTable tbody');
  allRows = Array.from(tbody.querySelectorAll('tr:not(:last-child)'));
});

// Toggle select all checkboxes
function toggleSelectAll(checkbox) {
  const checkboxes = document.querySelectorAll('.sku-checkbox:not(:disabled)');
  const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
    const row = cb.closest('tr');
    return row.style.display !== 'none';
  });
  
  visibleCheckboxes.forEach(cb => {
    cb.checked = checkbox.checked;
  });
  updateSelectedCount();
}

// Update selected count badge
function updateSelectedCount() {
  const checked = document.querySelectorAll('.sku-checkbox:checked').length;
  document.getElementById('selectedCount').textContent = `Selected: ${checked}`;
  
  // Update select all checkbox state
  const selectAll = document.getElementById('selectAll');
  const visibleCheckboxes = Array.from(document.querySelectorAll('.sku-checkbox:not(:disabled)')).filter(cb => {
    const row = cb.closest('tr');
    return row.style.display !== 'none';
  });
  
  if (visibleCheckboxes.length === 0) {
    selectAll.checked = false;
    selectAll.indeterminate = false;
  } else {
    const visibleChecked = visibleCheckboxes.filter(cb => cb.checked).length;
    selectAll.checked = visibleChecked === visibleCheckboxes.length;
    selectAll.indeterminate = visibleChecked > 0 && visibleChecked < visibleCheckboxes.length;
  }
}

// Print selected SKUs
function printSelected() {
  const selected = Array.from(document.querySelectorAll('.sku-checkbox:checked')).map(cb => cb.value);
  
  if (selected.length === 0) {
    alert('กรุณาเลือก SKU ที่ต้องการพิมพ์อย่างน้อย 1 รายการ');
    return;
  }
  
  if (!confirm(`ต้องการพิมพ์และล็อกงาน ${selected.length} SKU ใช่หรือไม่?`)) {
    return;
  }
  
  submitPrintForm(selected.join(','));
}

// Print all SKUs
function printAllPicking() {
  const allSkus = Array.from(document.querySelectorAll('.sku-checkbox')).map(cb => cb.value);
  
  if (allSkus.length === 0) {
    alert('ไม่พบ SKU ที่จะพิมพ์');
    return;
  }
  
  if (!confirm(`ต้องการพิมพ์และล็อกงานทั้งหมด ${allSkus.length} SKU ใช่หรือไม่?`)) {
    return;
  }
  
  submitPrintForm('all');
}

// Submit print form
let __pickingPrintSubmitting = false;

// Idempotency token (per submit) - helps backend dedupe duplicate POSTs
let __pickingPrintToken = null;
function __getPickingPrintToken() {
  if (__pickingPrintToken) return __pickingPrintToken;
  if (window.crypto && crypto.randomUUID) {
    __pickingPrintToken = crypto.randomUUID();
  } else {
    __pickingPrintToken = String(Date.now()) + "-" + Math.random().toString(16).slice(2);
  }
  return __pickingPrintToken;
}

function __setPickingPrintButtonsLocked(isLocked) {
  const btnSelected = document.getElementById('printSelectedBtn');
  const btnAll = document.getElementById('printAllBtn');

  [btnSelected, btnAll].forEach(btn => {
    if (!btn) return;
    if (!btn.dataset.originalText) {
      btn.dataset.originalText = btn.textContent || '';
    }
    btn.disabled = !!isLocked;
    btn.textContent = isLocked ? 'กำลังทำงาน...' : (btn.dataset.originalText || btn.textContent);
  });
}

function submitPrintForm(selectedSkus) {
  // กันกดเบิ้ล/เมาส์เด้ง/คลิกซ้ำ: ให้ส่งได้ครั้งเดียวต่อการโหลดหน้า
  if (__pickingPrintSubmitting) {
    return;
  }
  __pickingPrintSubmitting = true;
  __setPickingPrintButtonsLocked(true);

  const form = document.createElement('form');
  form.method = 'post';
  form.action = '{{ url_for("picking_list_commit") }}';
  
  // Add hidden fields - ไม่ส่ง order_ids ให้ server ดึงออเดอร์ที่เข้าข่ายเอง
  const fields = {
    platform: '{{ platform_sel or "" }}',
    shop_id: '{{ shop_sel or "" }}',
    logistic: '{{ logistic_sel or "" }}',
    print_token: __getPickingPrintToken(),
    selected_skus: (selectedSkus || "")
  };
  
  {% if CURRENT_USER and CURRENT_USER.role == 'admin' %}
  const override = confirm('ต้องการอนุญาตพิมพ์ซ้ำหรือไม่? (สำหรับแอดมิน)');
  if (override) {
    fields.override = '1';
  }
  {% endif %}
  
  for (const [key, value] of Object.entries(fields)) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = key;
    input.value = value;
    form.appendChild(input);
  }
  
  document.body.appendChild(form);
  form.submit();
}

// Clear all filters - redirect to reset page (server-side filtering)
function clearAllFilters() {
  {% if is_history_view %}
    window.location.href = "{{ url_for('picking_printed_history', reset='today') }}";
  {% else %}
    window.location.href = "{{ url_for('picking_list', reset='all') }}";
  {% endif %}
}

// Sort table by column
document.querySelectorAll('th.sortable').forEach(th => {
  th.addEventListener('click', function() {
    const column = this.dataset.column;
    
    // Determine sort direction
    if (sortState.column === column) {
      if (sortState.direction === 'none') {
        sortState.direction = 'asc';
      } else if (sortState.direction === 'asc') {
        sortState.direction = 'desc';
      } else {
        sortState.direction = 'none';
      }
    } else {
      sortState.column = column;
      sortState.direction = 'asc';
    }
    
    // Update UI
    document.querySelectorAll('th.sortable').forEach(h => {
      h.classList.remove('asc', 'desc');
    });
    
    if (sortState.direction !== 'none') {
      this.classList.add(sortState.direction);
    }
    
    // Sort rows
    sortTable(column, sortState.direction);
  });
});

function sortTable(column, direction) {
  const tbody = document.querySelector('#pickingTable tbody');
  const emptyRow = tbody.querySelector('tr:last-child');
  
  if (direction === 'none') {
    // Restore original order
    allRows.forEach(row => tbody.insertBefore(row, emptyRow));
    return;
  }
  
  // Sort rows
  const sortedRows = [...allRows].sort((rowA, rowB) => {
    let valueA = rowA.dataset[column] || '';
    let valueB = rowB.dataset[column] || '';
    
    // Handle numeric sorting for printed_count and dispatch_round
    if (column === 'printed_count' || column === 'dispatch_round') {
      // For dispatch_round, handle ranges like "1-3"
      if (column === 'dispatch_round') {
        if (valueA.includes('-')) valueA = parseInt(valueA.split('-')[0]);
        if (valueB.includes('-')) valueB = parseInt(valueB.split('-')[0]);
      }
      
      valueA = parseInt(valueA) || 0;
      valueB = parseInt(valueB) || 0;
      
      if (direction === 'asc') {
        return valueA - valueB;
      } else {
        return valueB - valueA;
      }
    }
    
    // Handle datetime sorting for printed_at
    if (column === 'printed_at') {
      const dateA = valueA ? new Date(valueA).getTime() : 0;
      const dateB = valueB ? new Date(valueB).getTime() : 0;
      
      if (direction === 'asc') {
        return dateA - dateB;
      } else {
        return dateB - dateA;
      }
    }
    
    // String comparison with Thai locale support
    const comparison = valueA.localeCompare(valueB, 'th');
    return direction === 'asc' ? comparison : -comparison;
  });
  
  // Rebuild table with sorted rows
  sortedRows.forEach(row => tbody.insertBefore(row, emptyRow));
}

// Show dispatch round modal for picking list
function showDispatchModal() {
  // For picking list, we update all orders in the current filter
  const orderIds = {{ (order_ids|default([]))|tojson|safe }};
  
  if (!orderIds || orderIds.length === 0) {
    alert('ไม่พบออเดอร์สำหรับจ่ายงาน');
    return;
  }
  
  // ใส่ Order IDs ลงใน Hidden Inputs
  const container = document.getElementById('dispatchHiddenInputs');
  container.innerHTML = '';
  orderIds.forEach(oid => {
    const inp = document.createElement('input');
    inp.type = 'hidden';
    inp.name = 'order_ids[]';
    inp.value = oid;
    container.appendChild(inp);
  });
  
  // แสดงจำนวนออเดอร์ใน Modal
  const label = document.querySelector('#dispatchModal .form-text');
  if (label) {
    label.textContent = `จ่ายงาน ${orderIds.length} ออเดอร์ - ใส่เลข 1, 2, 3... เพื่อแยกชุดงาน`;
  }
  
  // เปิด Modal
  new bootstrap.Modal(document.getElementById('dispatchModal')).show();
}

// Update dispatch round via API
async function updateDispatchRound(orderIds, dispatchRound) {
  try {
    const response = await fetch('{{ url_for("update_dispatch_round") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        order_ids: orderIds,
        dispatch_round: dispatchRound
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert(result.message);
      // Reload page to show updated data
      window.location.reload();
    } else {
      alert('เกิดข้อผิดพลาด: ' + result.error);
    }
  } catch (error) {
    alert('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message);
  }
}

// Initialize
updateSelectedCount();

function setTodayPicking() {
  // ดึงวันที่ปัจจุบันตามเวลาเครื่อง (Local Time)
  const date = new Date();
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const today = `${year}-${month}-${day}`;

  const form = document.querySelector('form[method="get"]');
  const inputFrom = form.querySelector('input[name="accepted_from"]');
  const inputTo = form.querySelector('input[name="accepted_to"]');
  
  if(inputFrom) inputFrom.value = today;
  if(inputTo) inputTo.value = today;

  // สั่ง Submit Form ทันที
  form.submit();
}
</script>

{% endblock %}

{# ซ่อน footer ข้อความลิขสิทธิ์เฉพาะหน้านี้ #}
{% block footer %}{% endblock %}