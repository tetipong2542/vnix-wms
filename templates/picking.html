
{% extends "base.html" %}
{% block content %}

<div class="row g-3 align-items-end mb-3">
  <div class="col-auto">
    <div class="page-title d-flex align-items-center">
      <div class="page-title-icon me-3">
        üìã
      </div>
      <div class="d-flex align-items-baseline flex-wrap">
        <div class="page-title-main me-3">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏´‡∏¢‡∏¥‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Picking)</div>
        <div class="text-muted" style="font-size: 1rem; border-left: 2px solid #ccc; padding-left: 12px;">
          ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏¥‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏û‡∏±‡∏™‡∏î‡∏∏
        </div>
      </div>
    </div>
  </div>
</div>
<hr class="mb-4">

<style>
  /* ‡∏ã‡πà‡∏≠‡∏ô footer ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ + ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏û‡∏¥‡∏°‡∏û‡πå */
  footer { display: none !important; }
  @media print {
    footer { display: none !important; }
    .d-print-none { display: none !important; }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    table.table { border-color: #333 !important; }
    table.table th, table.table td { border-color: #333 !important; padding: 4px 6px !important; font-size: 12px; }
    .table .need-col{
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      background: #dbe8ff !important;
    }
  }
  /* ‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏¥‡∏ö" */
  .table .need-col{
    background: #e6f0ff;
    font-weight: 700;
    border-left: 2px solid #99b8ff;
    border-right: 2px solid #99b8ff;
  }
  
  /* Sortable column headers */
  th.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 20px !important;
  }
  th.sortable:hover {
    background-color: #e9ecef;
  }
  th.sortable::after {
    content: '‚áÖ';
    position: absolute;
    right: 5px;
    opacity: 0.3;
  }
  th.sortable.asc::after {
    content: '‚ñ≤';
    opacity: 1;
  }
  th.sortable.desc::after {
    content: '‚ñº';
    opacity: 1;
  }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">
    Picking List
    {% if is_history_view %}<span class="badge bg-info ms-2">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß</span>{% endif %}
  </h3>
  <div class="d-print-none d-flex gap-2">
    {% if not official_print %}
      <button id="printSelectedBtn" type="button" class="btn btn-danger" onclick="printSelected()">üîí ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      <button id="printAllBtn" type="button" class="btn btn-warning" onclick="printAllPicking()">üîí ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button id="updateDispatchBtn" type="button" class="btn btn-primary" onclick="showDispatchModal()">üìù ‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô(‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà)</button>
    {% endif %}
    {% if is_history_view %}
      <a class="btn btn-outline-secondary"
         href="{{ url_for('picking_printed_history', reset='today') }}">
        ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
      </a>
    {% else %}
      <a class="btn btn-outline-secondary"
         href="{{ url_for('picking_list', reset='all') }}">
        ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä/Order‡∏Ñ‡πâ‡∏≤‡∏á
      </a>
    {% endif %}
    
    {% if is_history_view %}
      <a class="btn btn-success"
         href="{{ url_for('export_picking_history_excel', **request.args) }}">
        Export Excel
      </a>
    {% else %}
      <a class="btn btn-success"
         href="{{ url_for('export_picking_excel', **request.args) }}">
        Export Excel
      </a>
    {% endif %}
    
    {% if not official_print %}
      <button class="btn btn-outline-primary" onclick="window.print()">‡∏û‡∏¥‡∏°‡∏û‡πå (Preview)</button>
    {% endif %}
  </div>
</div>

{% if is_history_view %}
  <div class="alert alert-primary d-print-none">
    <strong>üìã ‡πÇ‡∏´‡∏°‡∏î‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß</strong> ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ)
  </div>
{% elif official_print and printed_meta %}
  <div class="alert alert-success d-print-none">
    <strong>Official print</strong>
    ‚Ä¢ ‡∏ú‡∏π‡πâ‡∏≠‡∏≠‡∏Å: {{ printed_meta.by }}
    ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: {{ printed_meta.at|thai_be }}
    ‚Ä¢ ‡∏£‡∏ß‡∏°‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: {{ printed_meta.orders }}
    {% if printed_meta.override %}<span class="badge text-bg-warning ms-2">Reprint (Admin)</span>{% endif %}
  </div>
{% else %}
  <div class="alert alert-info d-print-none">
    ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏´‡∏°‡∏î <strong>Preview</strong> ‚Äî ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Å‡∏î "‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô"
    {% if warehouse_print_info %}
    <br>
    <strong>üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á:</strong> 
    ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠ {{ warehouse_print_info.printed_at|thai_be }} 
    ‡πÇ‡∏î‡∏¢ {{ warehouse_print_info.printed_by }}
    (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà {{ warehouse_print_info.print_count }})
    {% endif %}
  </div>
{% endif %}

<form class="row gy-2 gx-2 align-items-end mb-3 d-print-none" method="get" action="{{ url_for('picking_list') if not is_history_view else url_for('picking_printed_history') }}">
  {% if is_history_view and available_dates %}
  <div class="col-md-2">
    <label class="form-label small fw-bold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå</label>
    <select name="print_date" class="form-select form-select-sm">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      {% for d in available_dates %}
        <option value="{{d}}" {% if print_date_sel==d|string %}selected{% endif %}>{{ d }}</option>
      {% endfor %}
    </select>
  </div>
  {% endif %}
  <div class="col-md-2">
    <label class="form-label small fw-bold">‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</label>
    <select class="form-select form-select-sm" name="platform">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      {% for p in ["Shopee","TikTok","Lazada","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"] %}
        <option value="{{p}}" {% if platform_sel==p %}selected{% endif %}>{{p}}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label small fw-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
    <select class="form-select form-select-sm" name="shop_id">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      {% for s in shops %}
        <option value="{{ s.id }}" {% if shop_sel and shop_sel|int==s.id %}selected{% endif %}>
          {{ s.platform }} ‚Ä¢ {{ s.name }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label small fw-bold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏ô‡∏™‡πà‡∏á</label>
    <select class="form-select form-select-sm" name="logistic">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      {% for lg in logistics %}
        <option value="{{ lg }}" {% if logistic_sel==lg %}selected{% endif %}>{{ lg }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-1">
    <label class="form-label small fw-bold">‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà</label>
    {% if is_history_view and available_rounds %}
    <select class="form-select form-select-sm" name="round">
      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      {% for r in available_rounds %}
        <option value="{{ r }}" {% if round_sel|string == r|string %}selected{% endif %}>{{ r }}</option>
      {% endfor %}
    </select>
    {% else %}
    <input type="number" class="form-control form-control-sm" name="round" value="{{ round_sel or '' }}" placeholder="‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö" min="1">
    {% endif %}
  </div>
  <div class="col-md-1">
    <label class="form-label small fw-bold">‡∏û‡∏¥‡∏°‡∏û‡πå(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</label>
    <input type="number" class="form-control form-control-sm" name="print_count" value="{{ print_count_sel or '' }}" placeholder="‡∏ó‡∏∏‡∏Å‡∏Ñ‡πà‡∏≤" min="0">
  </div>

  <div class="w-100"></div>

  <div class="col-md-2">
    <label class="form-label small fw-bold">‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á(‡∏à‡∏≤‡∏Å)</label>
    <input type="date" name="accepted_from" class="form-control form-control-sm" value="{{ accepted_from or '' }}">
  </div>
  <div class="col-md-2">
    <label class="form-label small fw-bold">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
    <div class="input-group input-group-sm">
      <input type="date" name="accepted_to" class="form-control form-control-sm" value="{{ accepted_to or '' }}">
      <button type="button" class="btn btn-outline-secondary" onclick="setTodayPicking()">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>
  </div>
  <div class="col-md-auto d-grid">
    <button type="submit" class="btn btn-primary btn-sm fw-bold"><i class="bi bi-search"></i> ‡∏Å‡∏£‡∏≠‡∏á</button>
  </div>
</form>

<div class="mb-2 d-flex justify-content-between align-items-center">
  <div>
    <span class="badge text-bg-primary">Distinct SKUs: {{ totals.total_skus }}</span>
    <span class="badge text-bg-secondary">‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏¥‡∏ö‡∏£‡∏ß‡∏°: {{ totals.total_need_qty }}</span>
    <span class="badge text-bg-danger">‡∏Ç‡∏≤‡∏î‡∏£‡∏ß‡∏°: {{ totals.total_shortage }}</span>
    <span class="badge text-bg-info" id="selectedCount">Selected: 0</span>
  </div>
  <div class="d-print-none">
    <button class="btn btn-sm btn-outline-secondary" onclick="clearAllFilters()">
      <i class="bi bi-x-circle"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    </button>
  </div>
</div>

{# ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å shop_sel ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å #}
{% set shop_sel_name = '-' %}
{% if shop_sel %}
  {% for s in shops %}
    {% if s.id == shop_sel|int %}
      {% set shop_sel_name = s.platform ~ ' ‚Ä¢ ' ~ s.name %}
    {% endif %}
  {% endfor %}
{% endif %}

<div class="table-responsive">
  <table class="table table-sm table-bordered align-middle" id="pickingTable">
    <thead class="table-light">
      <tr>
        <th class="d-print-none" style="width: 40px;">
          <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
        </th>
        <th class="sortable" data-column="platform">‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</th>
        <th class="sortable" data-column="shop">‡∏£‡πâ‡∏≤‡∏ô</th>
        <th class="sortable" data-column="sku" style="width: 140px;">SKU</th>
        <th class="sortable" data-column="brand">Brand</th>
        <th class="sortable" data-column="model">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
        <th class="text-end" style="width: 120px;">‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏¥‡∏ö</th>
        <th class="text-end" style="width: 120px;">‡∏™‡∏ï‡πá‡∏≠‡∏Å</th>
        <th class="text-end" style="width: 120px;">‡∏Ç‡∏≤‡∏î</th>
        <th class="text-end" style="width: 140px;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏´‡∏¢‡∏¥‡∏ö</th>
        <th class="sortable" data-column="logistic">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏ô‡∏™‡πà‡∏á</th>
        <th class="sortable text-center" data-column="dispatch_round" style="width: 120px;">‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô(‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà)</th>
        <th class="sortable text-center" data-column="printed_count" style="width: 130px;">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</th>
        <th class="sortable text-center" data-column="printed_at" style="width: 180px;">‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ/‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå</th>
      </tr>
    </thead>
    <tbody>
      {% for it in items %}
        <tr class="{% if it.shortage>0 %}table-warning{% endif %}" data-sku="{{ it.sku }}" data-platform="{{ platform_sel or '-' }}" data-shop="{{ shop_sel_name or '-' }}" data-brand="{{ it.brand }}" data-model="{{ it.model }}" data-logistic="{{ logistic_sel or '-' }}" data-dispatch-round="{% if it.dispatch_round is not none %}{{ it.dispatch_round }}{% endif %}" data-printed-count="{{ print_count_overall|default(0, true) }}" data-printed-at="{% if print_timestamp_overall %}{{ print_timestamp_overall.isoformat() }}{% endif %}">
          
          <td class="d-print-none">
            <input type="checkbox" class="sku-checkbox" value="{{ it.sku }}" onchange="updateSelectedCount()">
          </td>

          <td>{{ platform_sel or '-' }}</td>
          <td>{{ shop_sel_name or '-' }}</td>

          <td><strong>{{ it.sku }}</strong></td>
          <td>{{ it.brand }}</td>
          <td>{{ it.model }}</td>
          <td class="text-end need-col">{{ it.need_qty }}</td>
          <td class="text-end">{{ it.stock_qty }}</td>
          <td class="text-end">{{ it.shortage }}</td>
          <td class="text-end">{{ it.remain_after_pick }}</td>

          <td>{{ logistic_sel or '-' }}</td>

          <td class="text-center">
            {% if round_sel %}
              {# ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏™‡∏î‡∏á badge ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∑‡∏≠‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß) #}
              <span class="badge bg-primary rounded-pill">{{ round_sel }}</span>
            {% elif it.dispatch_round is not none %}
              <span class="badge bg-secondary rounded-pill">{{ it.dispatch_round }}</span>
            {% else %}
              -
            {% endif %}
          </td>

          <td class="text-center">
            {% if print_count_overall > 0 %}
              <span class="badge bg-success">{{ print_count_overall }}</span>
            {% else %}
              <span class="text-muted">0</span>
            {% endif %}
          </td>
          
          <td class="text-center">
            {% if print_timestamp_overall %}
              {{ print_timestamp_overall|thai_be }}
              {% if print_user_overall %}
                <br><small class="text-muted">(‡πÇ‡∏î‡∏¢: {{ print_user_overall }})</small>
              {% endif %}
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      {% if not items %}
        <tr><td colspan="14" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏¥‡∏ö</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

{% if official_print %}
<script>
  // ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô Official print
  window.addEventListener('load', function(){ window.print(); });
</script>
{% endif %}

{# Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏£‡∏≠‡∏ö‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô #}
<div class="modal fade" id="dispatchModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-truck"></i> ‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô / ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≠‡∏ö</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="dispatchForm" action="{{ url_for('picking_update_dispatch') }}" method="POST">
          <div class="mb-3 text-center">
            <label class="form-label fw-bold text-muted">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏£‡∏≠‡∏ö (Round)</label>
            <input type="number" class="form-control form-control-lg text-center fw-bold text-primary" 
                   name="dispatch_round" id="dispatchRoundInput" value="1" min="1" required style="font-size: 2rem;">
            <div class="form-text">‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç 1, 2, 3... ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô</div>
          </div>
          
          <div id="dispatchHiddenInputs"></div>
          
          {# Hidden fields for current filters #}
          <input type="hidden" name="platform" value="{{ platform_sel or '' }}">
          <input type="hidden" name="shop_id" value="{{ shop_sel or '' }}">
          <input type="hidden" name="logistic" value="{{ logistic_sel or '' }}">

          <div class="d-grid">
            <button type="submit" class="btn btn-primary btn-lg">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Store original rows for filtering
let allRows = [];
let sortState = { column: null, direction: 'none' };

document.addEventListener('DOMContentLoaded', function() {
  const tbody = document.querySelector('#pickingTable tbody');
  allRows = Array.from(tbody.querySelectorAll('tr:not(:last-child)'));
});

// Toggle select all checkboxes
function toggleSelectAll(checkbox) {
  const checkboxes = document.querySelectorAll('.sku-checkbox:not(:disabled)');
  const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
    const row = cb.closest('tr');
    return row.style.display !== 'none';
  });
  
  visibleCheckboxes.forEach(cb => {
    cb.checked = checkbox.checked;
  });
  updateSelectedCount();
}

// Update selected count badge
function updateSelectedCount() {
  const checked = document.querySelectorAll('.sku-checkbox:checked').length;
  document.getElementById('selectedCount').textContent = `Selected: ${checked}`;
  
  // Update select all checkbox state
  const selectAll = document.getElementById('selectAll');
  const visibleCheckboxes = Array.from(document.querySelectorAll('.sku-checkbox:not(:disabled)')).filter(cb => {
    const row = cb.closest('tr');
    return row.style.display !== 'none';
  });
  
  if (visibleCheckboxes.length === 0) {
    selectAll.checked = false;
    selectAll.indeterminate = false;
  } else {
    const visibleChecked = visibleCheckboxes.filter(cb => cb.checked).length;
    selectAll.checked = visibleChecked === visibleCheckboxes.length;
    selectAll.indeterminate = visibleChecked > 0 && visibleChecked < visibleCheckboxes.length;
  }
}

// Print selected SKUs
function printSelected() {
  const selected = Array.from(document.querySelectorAll('.sku-checkbox:checked')).map(cb => cb.value);
  
  if (selected.length === 0) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å SKU ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
    return;
  }
  
  if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô ${selected.length} SKU ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
    return;
  }
  
  submitPrintForm(selected.join(','));
}

// Print all SKUs
function printAllPicking() {
  const allSkus = Array.from(document.querySelectorAll('.sku-checkbox')).map(cb => cb.value);
  
  if (allSkus.length === 0) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö SKU ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå');
    return;
  }
  
  if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${allSkus.length} SKU ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
    return;
  }
  
  submitPrintForm('all');
}

// Submit print form
let __pickingPrintSubmitting = false;

// Idempotency token (per submit) - helps backend dedupe duplicate POSTs
let __pickingPrintToken = null;
function __getPickingPrintToken() {
  if (__pickingPrintToken) return __pickingPrintToken;
  if (window.crypto && crypto.randomUUID) {
    __pickingPrintToken = crypto.randomUUID();
  } else {
    __pickingPrintToken = String(Date.now()) + "-" + Math.random().toString(16).slice(2);
  }
  return __pickingPrintToken;
}

function __setPickingPrintButtonsLocked(isLocked) {
  const btnSelected = document.getElementById('printSelectedBtn');
  const btnAll = document.getElementById('printAllBtn');

  [btnSelected, btnAll].forEach(btn => {
    if (!btn) return;
    if (!btn.dataset.originalText) {
      btn.dataset.originalText = btn.textContent || '';
    }
    btn.disabled = !!isLocked;
    btn.textContent = isLocked ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...' : (btn.dataset.originalText || btn.textContent);
  });
}

function submitPrintForm(selectedSkus) {
  // ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡πÄ‡∏ö‡∏¥‡πâ‡∏•/‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏î‡πâ‡∏á/‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ã‡πâ‡∏≥: ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
  if (__pickingPrintSubmitting) {
    return;
  }
  __pickingPrintSubmitting = true;
  __setPickingPrintButtonsLocked(true);

  const form = document.createElement('form');
  form.method = 'post';
  form.action = '{{ url_for("picking_list_commit") }}';
  
  // Add hidden fields - ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á order_ids ‡πÉ‡∏´‡πâ server ‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡πÄ‡∏≠‡∏á
  const fields = {
    platform: '{{ platform_sel or "" }}',
    shop_id: '{{ shop_sel or "" }}',
    logistic: '{{ logistic_sel or "" }}',
    print_token: __getPickingPrintToken(),
    selected_skus: (selectedSkus || "")
  };
  
  {% if CURRENT_USER and CURRENT_USER.role == 'admin' %}
  const override = confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)');
  if (override) {
    fields.override = '1';
  }
  {% endif %}
  
  for (const [key, value] of Object.entries(fields)) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = key;
    input.value = value;
    form.appendChild(input);
  }
  
  document.body.appendChild(form);
  form.submit();
}

// Clear all filters - redirect to reset page (server-side filtering)
function clearAllFilters() {
  {% if is_history_view %}
    window.location.href = "{{ url_for('picking_printed_history', reset='today') }}";
  {% else %}
    window.location.href = "{{ url_for('picking_list', reset='all') }}";
  {% endif %}
}

// Sort table by column
document.querySelectorAll('th.sortable').forEach(th => {
  th.addEventListener('click', function() {
    const column = this.dataset.column;
    
    // Determine sort direction
    if (sortState.column === column) {
      if (sortState.direction === 'none') {
        sortState.direction = 'asc';
      } else if (sortState.direction === 'asc') {
        sortState.direction = 'desc';
      } else {
        sortState.direction = 'none';
      }
    } else {
      sortState.column = column;
      sortState.direction = 'asc';
    }
    
    // Update UI
    document.querySelectorAll('th.sortable').forEach(h => {
      h.classList.remove('asc', 'desc');
    });
    
    if (sortState.direction !== 'none') {
      this.classList.add(sortState.direction);
    }
    
    // Sort rows
    sortTable(column, sortState.direction);
  });
});

function sortTable(column, direction) {
  const tbody = document.querySelector('#pickingTable tbody');
  const emptyRow = tbody.querySelector('tr:last-child');
  
  if (direction === 'none') {
    // Restore original order
    allRows.forEach(row => tbody.insertBefore(row, emptyRow));
    return;
  }
  
  // Sort rows
  const sortedRows = [...allRows].sort((rowA, rowB) => {
    let valueA = rowA.dataset[column] || '';
    let valueB = rowB.dataset[column] || '';
    
    // Handle numeric sorting for printed_count and dispatch_round
    if (column === 'printed_count' || column === 'dispatch_round') {
      // For dispatch_round, handle ranges like "1-3"
      if (column === 'dispatch_round') {
        if (valueA.includes('-')) valueA = parseInt(valueA.split('-')[0]);
        if (valueB.includes('-')) valueB = parseInt(valueB.split('-')[0]);
      }
      
      valueA = parseInt(valueA) || 0;
      valueB = parseInt(valueB) || 0;
      
      if (direction === 'asc') {
        return valueA - valueB;
      } else {
        return valueB - valueA;
      }
    }
    
    // Handle datetime sorting for printed_at
    if (column === 'printed_at') {
      const dateA = valueA ? new Date(valueA).getTime() : 0;
      const dateB = valueB ? new Date(valueB).getTime() : 0;
      
      if (direction === 'asc') {
        return dateA - dateB;
      } else {
        return dateB - dateA;
      }
    }
    
    // String comparison with Thai locale support
    const comparison = valueA.localeCompare(valueB, 'th');
    return direction === 'asc' ? comparison : -comparison;
  });
  
  // Rebuild table with sorted rows
  sortedRows.forEach(row => tbody.insertBefore(row, emptyRow));
}

// Show dispatch round modal for picking list
function showDispatchModal() {
  // For picking list, we update all orders in the current filter
  const orderIds = {{ (order_ids|default([]))|tojson|safe }};
  
  if (!orderIds || orderIds.length === 0) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
    return;
  }
  
  // ‡πÉ‡∏™‡πà Order IDs ‡∏•‡∏á‡πÉ‡∏ô Hidden Inputs
  const container = document.getElementById('dispatchHiddenInputs');
  container.innerHTML = '';
  orderIds.forEach(oid => {
    const inp = document.createElement('input');
    inp.type = 'hidden';
    inp.name = 'order_ids[]';
    inp.value = oid;
    container.appendChild(inp);
  });
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô Modal
  const label = document.querySelector('#dispatchModal .form-text');
  if (label) {
    label.textContent = `‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ${orderIds.length} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå - ‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç 1, 2, 3... ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å‡∏ä‡∏∏‡∏î‡∏á‡∏≤‡∏ô`;
  }
  
  // ‡πÄ‡∏õ‡∏¥‡∏î Modal
  new bootstrap.Modal(document.getElementById('dispatchModal')).show();
}

// Update dispatch round via API
async function updateDispatchRound(orderIds, dispatchRound) {
  try {
    const response = await fetch('{{ url_for("update_dispatch_round") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        order_ids: orderIds,
        dispatch_round: dispatchRound
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      alert(result.message);
      // Reload page to show updated data
      window.location.reload();
    } else {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.error);
    }
  } catch (error) {
    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + error.message);
  }
}

// Initialize
updateSelectedCount();

function setTodayPicking() {
  // ‡∏î‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Local Time)
  const date = new Date();
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const today = `${year}-${month}-${day}`;

  const form = document.querySelector('form[method="get"]');
  const inputFrom = form.querySelector('input[name="accepted_from"]');
  const inputTo = form.querySelector('input[name="accepted_to"]');
  
  if(inputFrom) inputFrom.value = today;
  if(inputTo) inputTo.value = today;

  // ‡∏™‡∏±‡πà‡∏á Submit Form ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  form.submit();
}
</script>

{% endblock %}

{# ‡∏ã‡πà‡∏≠‡∏ô footer ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ #}
{% block footer %}{% endblock %}