{% extends "base.html" %}
{% block content %}

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);z-index:9999;align-items:center;justify-content:center;">
  <div class="text-center">
    <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-2 text-primary fw-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>
</div>

<div class="row g-3 align-items-end mb-3">
  <div class="col-auto">
    <div class="page-title d-flex align-items-center">
      <div class="page-title-icon me-3">üìã</div>
      <div class="d-flex align-items-baseline flex-wrap">
        <div class="page-title-main me-3">Order ‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</div>
        <div class="text-muted" style="font-size: 1rem; border-left: 2px solid #ccc; padding-left: 12px;">
          ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ({{ rows|length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
        </div>
      </div>
    </div>
  </div>
</div>
<hr class="mb-4">

<!-- Filter Form -->
<div class="card shadow-sm mb-4 border-0">
  <div class="card-body bg-light rounded-3">
    <form class="row gy-2 gx-3 align-items-end" id="filterForm" method="get">
      <div class="col-md-2">
        <label class="form-label fw-bold small text-muted">‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</label>
        <select name="platform" class="form-select form-select-sm">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          {% for p in platforms %}
            <option value="{{p}}" {% if platform_sel==p %}selected{% endif %}>{{p}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold small text-muted">‡∏£‡πâ‡∏≤‡∏ô</label>
        <select name="shop_id" class="form-select form-select-sm">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          {% for s in shops %}
            <option value="{{s.id}}" {% if shop_sel==s.id %}selected{% endif %}>{{s.platform}} ‚Ä¢ {{s.name}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold small text-muted">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</label>
        <input type="date" name="date_from" class="form-control form-control-sm" value="{{ date_from_sel or '' }}">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold small text-muted">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input type="date" name="date_to" class="form-control form-control-sm" value="{{ date_to_sel or '' }}">
      </div>
      <div class="col-md-2">
        <label class="form-label fw-bold small text-muted">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç Order</label>
        <input type="text" name="q" class="form-control form-control-sm" value="{{q}}" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç Order...">
      </div>
      <div class="col-md-2 d-flex gap-2">
        <button class="btn btn-primary btn-sm w-50 fw-bold" type="submit">
          <i class="bi bi-search"></i> ‡∏Å‡∏£‡∏≠‡∏á
        </button>
        <a href="{{ url_for('dashboard_issued') }}" class="btn btn-outline-secondary btn-sm w-50 fw-bold" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
          <i class="bi bi-arrow-counterclockwise"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
        </a>
      </div>
    </form>
  </div>
</div>

<!-- Data Table -->
<div class="card shadow-sm">
  <div class="card-body p-0">
    <form method="post" action="{{ url_for('issued_unissue') }}" id="unissueForm">
      <div class="d-flex justify-content-between align-items-center px-3 py-2 bg-light border-bottom">
        <button type="button" class="btn btn-warning btn-sm" id="btnUnissueSelected" disabled>
          <i class="bi bi-arrow-counterclockwise"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (<span id="selectedCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
        </button>
      </div>
      <table id="issuedTable" class="table table-sm table-bordered table-hover align-middle mb-0" style="width:100%">
        <thead class="table-light">
          <tr>
            <th style="width:40px" class="text-center">
              <input type="checkbox" id="chkAll" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
            </th>
            <th>‡πÄ‡∏•‡∏Ç Order</th>
            <th>‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</th>
            <th>‡∏£‡πâ‡∏≤‡∏ô</th>
            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏ô‡∏™‡πà‡∏á</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</th>
            <th style="width:120px">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td class="text-center">
              <input type="checkbox" class="rowchk" name="order_ids[]" value="{{ r.order_id }}">
            </td>
            <td><strong class="text-primary">{{ r.order_id }}</strong></td>
            <td>
              {% if r.platform %}
                <span class="badge bg-secondary">{{ r.platform }}</span>
              {% else %}
                <span class="text-muted">-</span>
              {% endif %}
            </td>
            <td>{{ r.shop_name or '-' }}</td>
            <td>{{ r.logistic or '-' }}</td>
            <td>{{ r.issued_at|thai_be }}</td>
            <td class="text-center">
              <button type="button" class="btn btn-sm btn-outline-danger btn-unissue-single" data-order-id="{{ r.order_id }}">
                <i class="bi bi-x-circle"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </button>
            </td>
          </tr>
          {% endfor %}
          {% if not rows %}
            <tr><td colspan="7" class="text-center text-muted py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</td></tr>
          {% endif %}
        </tbody>
      </table>
      <!-- Hidden input for single unissue -->
      <input type="hidden" name="order_id" id="singleOrderId">
    </form>
  </div>
</div>

<!-- DataTables CSS/JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<style>
  #issuedTable th, #issuedTable td { vertical-align: middle; }
  #issuedTable tbody tr:hover { background-color: rgba(13, 110, 253, 0.05); }
  .dataTables_wrapper .dataTables_length select { min-width: 80px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Show loading on form submit
  document.getElementById('filterForm').addEventListener('submit', function() {
    document.getElementById('loadingOverlay').style.display = 'flex';
  });

  // Initialize DataTable
  {% if rows %}
  var table = $('#issuedTable').DataTable({
    paging: true,
    pageLength: 50,
    lengthMenu: [[50, 100, 200, -1], [50, 100, 200, "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"]],
    searching: false,
    // [‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á DataTable 
    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î" ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Server (app.py)
    ordering: false,
    info: true,
    language: {
      lengthMenu: "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
      zeroRecords: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
      info: "‡πÅ‡∏™‡∏î‡∏á _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å _TOTAL_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
      infoEmpty: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
      infoFiltered: "(‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å _MAX_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)",
      paginate: { first: "‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å", last: "‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢", next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ", previous: "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤" }
    },
    columnDefs: [
      { orderable: false, targets: "_all" } // ‡∏¢‡πâ‡∏≥‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏î‡πÜ ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    ]
  });
  {% endif %}

  // Checkbox: Select All
  document.getElementById('chkAll').addEventListener('change', function() {
    document.querySelectorAll('.rowchk').forEach(c => c.checked = this.checked);
    updateSelectedCount();
  });

  // Checkbox: Individual row
  document.querySelectorAll('.rowchk').forEach(function(chk) {
    chk.addEventListener('change', updateSelectedCount);
  });

  function updateSelectedCount() {
    var count = document.querySelectorAll('.rowchk:checked').length;
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('btnUnissueSelected').disabled = (count === 0);
  }

  // Bulk unissue button
  document.getElementById('btnUnissueSelected').addEventListener('click', function() {
    var count = document.querySelectorAll('.rowchk:checked').length;
    if (count > 0 && confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ' + count + ' ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå?')) {
      document.getElementById('singleOrderId').value = '';
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('unissueForm').submit();
    }
  });

  // Single row unissue buttons
  document.querySelectorAll('.btn-unissue-single').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var orderId = this.getAttribute('data-order-id');
      if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ' + orderId + '?')) {
        // Uncheck all, set single order_id
        document.querySelectorAll('.rowchk').forEach(c => c.checked = false);
        document.getElementById('singleOrderId').value = orderId;
        document.getElementById('loadingOverlay').style.display = 'flex';
        document.getElementById('unissueForm').submit();
      }
    });
  });
});
</script>
{% endblock %}
