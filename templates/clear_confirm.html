
{% extends "base.html" %}
{% block content %}
<h4>ล้างข้อมูล</h4>

<div class="alert alert-warning">
  <i data-lucide="alert-triangle"></i>
  <strong>คำเตือน:</strong> การล้างข้อมูลไม่สามารถกู้คืนได้ กรุณาตรวจสอบให้แน่ใจก่อนดำเนินการ
</div>

<form method="post" class="row g-3 mb-4">
  <div class="col-12">
    <h5>ล้างข้อมูลออเดอร์</h5>
  </div>

  <div class="col-md-4">
    <select name="scope" id="scopeSelect" class="form-select" required onchange="toggleDateInputs()">
      <option value="">-- เลือกขอบเขตการล้างข้อมูล --</option>
      <option value="today">ลบเฉพาะข้อมูลของวันนี้ (ออเดอร์)</option>
      <option value="date_range">ลบข้อมูลตามช่วงวันที่ (กำหนดเอง)</option>
      <option value="all">ลบข้อมูลออเดอร์ทั้งหมด (ล้างเกลี้ยง)</option>
      <option value="deleted_bin">ล้างถังขยะ (Order ที่ถูกลบ) ทั้งหมด</option>
      <option value="cancelled">ลบ Order ยกเลิกทั้งหมด</option>
      <option value="issued">ลบ Order จ่ายแล้วทั้งหมด</option>
      <option value="sales">ลบข้อมูลใบสั่งขาย (Sales) ทั้งหมด</option>
      <option value="bill_empty_today">ยกเลิกสถานะบิลเปล่าที่ import วันนี้</option>
    </select>
  </div>

  <div class="col-md-6" id="dateRangeInputs" style="display: none;">
    <div class="input-group">
      <span class="input-group-text">จาก</span>
      <input type="date" name="date_from" class="form-control">
      <span class="input-group-text">ถึง</span>
      <input type="date" name="date_to" class="form-control">
    </div>
  </div>

  <div class="col-12" id="targetTypeInputs" style="display: none;">
    <div class="card bg-light border-warning mt-2">
      <div class="card-body py-2">
        <label class="fw-bold mb-2">เลือกข้อมูลที่ต้องการลบในช่วงวันที่นี้:</label>
        <div class="d-flex flex-wrap gap-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="targets" value="orders" id="chk_orders" checked>
            <label class="form-check-label" for="chk_orders">ข้อมูลออเดอร์ (OrderLine)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="targets" value="sales" id="chk_sales">
            <label class="form-check-label" for="chk_sales">ใบสั่งขาย (Sales)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="targets" value="issued" id="chk_issued">
            <label class="form-check-label" for="chk_issued">ประวัติจ่ายงาน (Issued)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="targets" value="cancelled" id="chk_cancelled">
            <label class="form-check-label" for="chk_cancelled">ประวัติยกเลิก (Cancelled)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="targets" value="deleted" id="chk_deleted">
            <label class="form-check-label" for="chk_deleted">ประวัติการลบ (Deleted Log)</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-2">
    <button type="submit" class="btn btn-danger w-100" onclick="return confirm('คุณแน่ใจหรือไม่ว่าต้องการล้างข้อมูล?')">ล้างข้อมูล</button>
  </div>
</form>

<script>
function toggleDateInputs() {
  const scope = document.getElementById('scopeSelect').value;
  const dateDiv = document.getElementById('dateRangeInputs');
  const targetDiv = document.getElementById('targetTypeInputs');
  
  if (scope === 'date_range') {
    dateDiv.style.display = 'block';
    targetDiv.style.display = 'block';
    // บังคับกรอกวันที่
    dateDiv.querySelectorAll('input').forEach(input => input.required = true);
  } else {
    dateDiv.style.display = 'none';
    targetDiv.style.display = 'none';
    // ยกเลิกบังคับ
    dateDiv.querySelectorAll('input').forEach(input => input.required = false);
  }
}
</script>

<div class="card">
  <div class="card-body">
    <h6 class="card-title">คำอธิบายตัวเลือก:</h6>
    <ul class="mb-0">
      <li><strong>ลบเฉพาะข้อมูลของวันนี้:</strong> ลบเฉพาะออเดอร์ที่นำเข้าวันนี้</li>
      <li><strong>ลบข้อมูลตามช่วงวันที่ (กำหนดเอง):</strong> เลือกวันที่เริ่มต้น-สิ้นสุด ลบออเดอร์ที่นำเข้าในช่วงนั้น</li>
      <li><strong>ลบข้อมูลออเดอร์ทั้งหมด:</strong> ลบออเดอร์ทั้งหมดในระบบ (รวมถังขยะ)</li>
      <li><strong>ล้างถังขยะ (Order ที่ถูกลบ):</strong> ลบเฉพาะข้อมูลในถังขยะ ไม่กระทบออเดอร์ปกติ</li>
      <li><strong>ลบ Order ยกเลิกทั้งหมด:</strong> ลบออเดอร์ที่อยู่ในสถานะยกเลิก (CancelledOrder) ทั้งหมด</li>
      <li><strong>ลบ Order จ่ายแล้วทั้งหมด:</strong> ลบออเดอร์ที่อยู่ในสถานะจ่ายแล้ว (IssuedOrder) ทั้งหมด</li>
      <li><strong>ลบข้อมูลใบสั่งขาย (Sales) ทั้งหมด:</strong> ลบข้อมูลประวัติการขายที่นำเข้า (Sales) ทั้งหมด</li>
      <li><strong>ยกเลิกสถานะบิลเปล่าที่ import วันนี้:</strong> เปลี่ยน allocation_status จาก BILL_EMPTY กลับเป็น NULL สำหรับ Orders ที่ import วันนี้ (Order ยังอยู่ในระบบ แต่ไม่แสดง badge บิลเปล่า และลบ ImportLog ที่เกี่ยวข้อง)</li>
    </ul>
  </div>
</div>

<div class="mt-4">
  <h6>สถิติข้อมูลปัจจุบัน:</h6>
  <div class="row">
    <div class="col-md-3">
      <div class="card bg-light">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">ออเดอร์ทั้งหมด</h6>
          <h4 class="mb-0">{{ stats.total_orders }}</h4>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-light">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Order ยกเลิก</h6>
          <h4 class="mb-0">{{ stats.cancelled_orders }}</h4>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-light">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Order จ่ายแล้ว</h6>
          <h4 class="mb-0">{{ stats.issued_orders }}</h4>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-light">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">ออเดอร์วันนี้</h6>
          <h4 class="mb-0">{{ stats.today_orders }}</h4>
        </div>
      </div>
    </div>
    <div class="col-md-3 mt-3">
      <div class="card bg-light">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">ใบสั่งขาย (Sales)</h6>
          <h4 class="mb-0">{{ stats.total_sales }}</h4>
        </div>
      </div>
    </div>
    <div class="col-md-3 mt-3">
      <div class="card bg-light border-danger">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Order ที่ถูกลบ (ถังขยะ)</h6>
          <h4 class="mb-0 text-danger">{{ stats.deleted_orders }}</h4>
        </div>
      </div>
    </div>
    <div class="col-md-3 mt-3">
      <div class="card bg-light" style="border: 1px solid #6f42c1;">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">บิลเปล่าวันนี้</h6>
          <h4 class="mb-0" style="color: #6f42c1;">{{ stats.bill_empty_today }}</h4>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
